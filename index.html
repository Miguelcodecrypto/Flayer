<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1a0a2e">
<meta name="description" content="Vales de Amor para Florecilla y Chiquit√≠n">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Vales de Amor">
<title>Vales de Amor üåô</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Special+Elite&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root {
  --deep: #d0eef8;
  --night: #c8f0e8;
  --twilight: #a8d8e8;
  --rose: #2a7a8a;
  --blush: #3a8a7a;
  --gold: #1a6a7a;
  --cream: #0d3d4a;
  --moonlight: #1a5a6a;
  --parchment: #f5ead0;
  --parchment-dark: #e8d5a3;
  --ink: #2c1810;
  --ink-light: #4a2e1a;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: linear-gradient(160deg, #d0eef8 0%, #c8f0e8 30%, #d8f0f0 55%, #b8e8f5 80%, #c0f0e0 100%);
  background-attachment: fixed;
  min-height: 100vh;
  font-family: 'Cormorant Garamond', serif;
  color: var(--cream);
  overflow-x: hidden;
}

.stars { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
.star {
  position: absolute; border-radius: 50%;
  animation: twinkle var(--d) ease-in-out infinite alternate;
}
@keyframes twinkle { from { opacity: 0.2; transform: scale(0.8); } to { opacity: 0.8; transform: scale(1.2); } }

.floaters { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
.floater {
  position: absolute;
  animation: float var(--d) ease-in-out infinite alternate;
  opacity: 0.22;
}
@keyframes float {
  0% { transform: translateY(0) rotate(0deg); }
  100% { transform: translateY(-18px) rotate(8deg); }
}

.app {
  position: relative; z-index: 1; min-height: 100vh;
  display: flex; flex-direction: column; align-items: center;
  padding: 2rem 1rem 3rem;
}

header { text-align: center; margin-bottom: 2rem; }
.moon-icon {
  font-size: 3.5rem; display: block;
  filter: drop-shadow(0 0 20px #d4a853bb);
  animation: moonGlow 3s ease-in-out infinite alternate;
}
@keyframes moonGlow {
  from { filter: drop-shadow(0 0 8px rgba(42,138,154,0.4)); }
  to   { filter: drop-shadow(0 0 25px rgba(42,154,122,0.7)); }
}
h1 {
  font-family: 'Playfair Display', serif;
  font-size: clamp(1.8rem, 6vw, 3rem);
  font-style: italic;
  background: linear-gradient(135deg, #1a7a8a, #2a9a7a, #1a6a9a);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  line-height: 1.2; margin-top: 0.3rem;
}
.subtitle {
  font-size: 0.85rem; color: var(--moonlight); opacity: 0.75;
  letter-spacing: 0.25em; text-transform: uppercase; margin-top: 0.4rem;
}

.install-banner {
  display: none; width: 100%; max-width: 480px;
  background: rgba(255,255,255,0.6);
  border: 1px solid rgba(196,96,122,0.3); border-radius: 1rem;
  padding: 1rem 1.5rem; margin-bottom: 1.5rem;
  align-items: center; gap: 1rem; cursor: pointer; transition: all 0.3s;
  backdrop-filter: blur(10px);
}
.install-banner:hover { transform: scale(1.01); }
.install-banner.show { display: flex; animation: fadeUp 0.5s ease; }
.install-text strong { display: block; font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--gold); }
.install-text span { font-size: 0.8rem; opacity: 0.7; }

.sender-avatars-preview {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1.2rem;
  margin-bottom: 0.8rem;
}
.sender-avatar-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
}
.sender-avatar-name {
  font-family: 'Playfair Display', serif;
  font-size: 0.75rem;
  font-style: italic;
  color: var(--moonlight);
  opacity: 0.8;
}
.sender-avatar-wrap svg {
  filter: drop-shadow(0 3px 8px rgba(42,138,154,0.25));
  transition: transform 0.3s;
}
.sender-avatar-wrap svg:hover { transform: scale(1.1); }
  display: flex; flex-direction: column; align-items: center; gap: 0.6rem;
  margin-bottom: 1.8rem;
  background: rgba(255,255,255,0.55); border: 1px solid rgba(196,96,122,0.2);
  border-radius: 1rem; padding: 1rem 1.5rem; backdrop-filter: blur(10px);
  width: 100%; max-width: 480px;
  box-shadow: 0 4px 20px rgba(196,96,122,0.08);
}
.sender-label { font-size: 0.8rem; color: var(--blush); letter-spacing: 0.18em; text-transform: uppercase; }
.sender-btns { display: flex; gap: 0.7rem; }
.sender-btn {
  padding: 0.55rem 1.3rem; border: 1px solid rgba(212,168,83,0.4);
  border-radius: 2rem; background: transparent; color: var(--cream);
  font-family: 'Playfair Display', serif; font-size: 0.95rem; cursor: pointer; transition: all 0.3s;
}
.sender-btn.active {
  background: linear-gradient(135deg, #2a8a9a, #1a7a6a);
  border-color: #2a8a9a; box-shadow: 0 0 18px rgba(42,138,154,0.4);
  color: white;
}

.form-card {
  width: 100%; max-width: 480px;
  background: rgba(255,255,255,0.65);
  border: 1px solid rgba(196,96,122,0.2); border-radius: 1.5rem;
  padding: 1.8rem; backdrop-filter: blur(20px);
  box-shadow: 0 8px 32px rgba(196,96,122,0.12); margin-bottom: 1.8rem;
}
.form-label {
  font-size: 0.78rem; letter-spacing: 0.2em; text-transform: uppercase;
  color: var(--blush); margin-bottom: 0.5rem; display: block;
}
.concept-input {
  width: 100%; background: rgba(255,255,255,0.8);
  border: 1px solid rgba(196,96,122,0.3); border-radius: 0.75rem;
  color: var(--cream); font-family: 'Playfair Display', serif;
  font-size: 1.05rem; font-style: italic; padding: 0.8rem 1rem;
  outline: none; transition: border-color 0.3s, box-shadow 0.3s;
  resize: none; min-height: 75px; margin-bottom: 1.3rem;
}
.concept-input::placeholder { color: rgba(100,50,120,0.35); }
.concept-input:focus { border-color: var(--rose); box-shadow: 0 0 15px rgba(196,96,122,0.2); }
.generate-btn {
  width: 100%; padding: 0.95rem;
  background: linear-gradient(135deg, #2a8a9a 0%, #1a7a6a 50%, #1a6a9a 100%);
  border: none; border-radius: 0.75rem; color: white;
  font-family: 'Playfair Display', serif; font-size: 1.05rem; font-style: italic;
  cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 20px rgba(42,138,154,0.35);
  overflow: hidden; position: relative;
}
.generate-btn::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, transparent, rgba(255,255,255,0.12), transparent);
  transform: translateX(-100%); transition: transform 0.5s;
}
.generate-btn:hover::before { transform: translateX(100%); }
.generate-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(42,138,154,0.5); }

.suggestions { width: 100%; max-width: 480px; margin-bottom: 2rem; }
.suggestions-title {
  font-size: 0.75rem; letter-spacing: 0.2em; text-transform: uppercase;
  color: var(--blush); opacity: 0.6; margin-bottom: 0.7rem;
}
.tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
.tag {
  padding: 0.35rem 0.85rem; border: 1px solid rgba(196,96,122,0.3);
  border-radius: 2rem; font-size: 0.82rem; color: var(--moonlight);
  cursor: pointer; transition: all 0.2s; background: rgba(255,255,255,0.5);
}
.tag:hover { background: rgba(196,96,122,0.1); border-color: var(--rose); color: var(--rose); }

/* ===== TICKET ===== */
.flyer-container { width: 100%; max-width: 460px; display: none; }
.flyer-container.visible { display: block; animation: fadeUp 0.7s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(40px) scale(0.95); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}

.ticket-shadow {
  filter: drop-shadow(0 25px 50px rgba(0,0,0,0.75)) drop-shadow(0 0 25px rgba(196,96,122,0.15));
}

.ticket {
  background: var(--parchment);
  position: relative;
  border-radius: 4px;
}

/* Zigzag edges via SVG-like clip */
.zz-top {
  width: 100%; height: 14px; overflow: hidden; line-height: 0;
}
.zz-top svg, .zz-bot svg { display: block; width: 100%; }

.ticket-body {
  background: var(--parchment);
  padding: 1.2rem 1.6rem 1rem;
  position: relative;
  overflow: hidden;
}

/* Ruled lines texture */
.ticket-body::after {
  content: '';
  position: absolute; inset: 0;
  background-image: repeating-linear-gradient(
    0deg, transparent, transparent 27px,
    rgba(139,90,43,0.07) 27px, rgba(139,90,43,0.07) 28px
  );
  pointer-events: none;
}

.ticket-watermark {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%) rotate(-28deg);
  font-family: 'Playfair Display', serif;
  font-size: 4.5rem; font-style: italic;
  color: rgba(196,96,122,0.06);
  white-space: nowrap; pointer-events: none; user-select: none;
}

/* Header */
.ticket-header {
  display: flex; justify-content: space-between; align-items: flex-start;
  margin-bottom: 0.75rem; position: relative; z-index: 1;
}
.t-logo-icon { font-size: 1.7rem; line-height: 1; }
.t-logo-text {
  font-family: 'Special Elite', monospace; font-size: 0.55rem;
  letter-spacing: 0.25em; text-transform: uppercase; color: var(--ink-light); margin-top: 3px;
}
.t-serial-label {
  font-family: 'Special Elite', monospace; font-size: 0.5rem;
  letter-spacing: 0.15em; color: var(--ink-light); opacity: 0.55;
  text-transform: uppercase; text-align: right;
}
.t-serial-num {
  font-family: 'Special Elite', monospace; font-size: 0.85rem;
  color: var(--ink); letter-spacing: 0.1em;
}

.t-hr { border: none; border-top: 1px dashed rgba(139,90,43,0.3); margin: 0.65rem 0; position: relative; z-index:1; }

/* Parties */
.ticket-parties {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 0.8rem; position: relative; z-index: 1;
}
.t-party { text-align: center; flex: 1; }
.t-avatar { display: flex; justify-content: center; margin-bottom: 0.3rem; }
.t-avatar svg { filter: drop-shadow(0 2px 6px rgba(42,138,154,0.2)); transition: transform 0.3s; }
.t-avatar svg:hover { transform: scale(1.08); }
.t-party-label {
  font-family: 'Special Elite', monospace; font-size: 0.52rem;
  letter-spacing: 0.2em; text-transform: uppercase;
  color: var(--ink-light); opacity: 0.55; display: block; margin-bottom: 2px;
}
.t-party-name {
  font-family: 'Playfair Display', serif; font-size: 1.15rem;
  font-style: italic; color: var(--ink);
}
.t-arrow { font-size: 1.2rem; opacity: 0.4; padding: 0 0.4rem; }

/* Vale box */
.ticket-vale {
  background: rgba(139,90,43,0.07);
  border: 1px dashed rgba(139,90,43,0.28);
  border-radius: 5px;
  padding: 0.9rem 4.5rem 0.9rem 1.1rem; /* right padding for stamp */
  margin: 0.6rem 0;
  position: relative; z-index: 1;
  text-align: center;
  min-height: 90px;
  display: flex; flex-direction: column; justify-content: center; align-items: center;
}
.t-vale-label {
  font-family: 'Special Elite', monospace; font-size: 0.58rem;
  letter-spacing: 0.3em; text-transform: uppercase;
  color: var(--ink-light); opacity: 0.5; margin-bottom: 0.35rem;
}
.t-vale-por {
  font-family: 'Playfair Display', serif; font-size: 0.82rem;
  font-style: italic; color: var(--ink-light); margin-bottom: 0.2rem;
}
.t-vale-concept {
  font-family: 'Playfair Display', serif; font-size: 1.4rem;
  font-weight: 700; color: var(--ink); line-height: 1.3;
}

/* Stamp */
.ticket-stamp {
  position: absolute; right: 0.8rem; top: 50%;
  transform: translateY(-50%) rotate(12deg);
  width: 68px; height: 68px;
  border: 2.5px solid rgba(196,96,122,0.5);
  border-radius: 50%;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  text-align: center;
}
.ticket-stamp::before {
  content: '';
  position: absolute; inset: 3px;
  border: 1px solid rgba(196,96,122,0.3);
  border-radius: 50%;
}
.t-stamp-icon { font-size: 1.3rem; position: relative; z-index: 1; line-height: 1; }
.t-stamp-text {
  font-family: 'Special Elite', monospace; font-size: 0.42rem;
  letter-spacing: 0.1em; text-transform: uppercase;
  color: rgba(196,96,122,0.65); position: relative; z-index: 1; line-height: 1.3;
}

/* Deco row */
.ticket-deco {
  display: flex; justify-content: center; gap: 0.35rem;
  font-size: 1rem; margin: 0.55rem 0; opacity: 0.45;
  position: relative; z-index: 1;
}

/* Footer row */
.ticket-footer {
  display: flex; justify-content: space-between; align-items: flex-end;
  position: relative; z-index: 1;
}
.t-footer-l, .t-footer-r {
  font-family: 'Special Elite', monospace; font-size: 0.52rem;
  letter-spacing: 0.08em; color: var(--ink-light); opacity: 0.5; line-height: 1.6;
}
.t-footer-r { text-align: right; }

/* Tear-off stub */
.zz-mid-wrap {
  background: var(--parchment);
  position: relative;
}
.stub-scissors {
  position: absolute; left: 1rem; top: -0.6rem;
  font-size: 0.9rem; opacity: 0.35; z-index: 2;
  background: var(--parchment-dark); padding: 0 3px;
}

.ticket-stub {
  background: linear-gradient(135deg, #f0e0cc, var(--parchment-dark));
  border-top: 1px dashed rgba(139,90,43,0.3);
  padding: 0.75rem 1.4rem;
  display: flex; align-items: center; justify-content: space-between; gap: 0.8rem;
}
.stub-info { flex: 1; }
.stub-title {
  font-family: 'Playfair Display', serif; font-size: 0.78rem;
  font-style: italic; font-weight: 700; color: var(--ink);
}
.stub-sub {
  font-family: 'Special Elite', monospace; font-size: 0.52rem;
  letter-spacing: 0.1em; color: var(--ink-light); opacity: 0.55;
  text-transform: uppercase; margin-top: 2px;
}
.stub-right {
  font-family: 'Special Elite', monospace; font-size: 0.5rem;
  color: var(--ink-light); opacity: 0.45; text-align: right; line-height: 1.6;
}

/* Barcode */
.barcode { display: flex; gap: 1.5px; align-items: stretch; height: 32px; opacity: 0.35; flex-shrink: 0; }
.bc-bar { background: var(--ink); border-radius: 1px; }

/* Action buttons */
.action-btns { display: flex; gap: 1rem; margin-top: 1.5rem; }
.action-btn {
  flex: 1; padding: 0.8rem; border-radius: 0.75rem;
  border: 1px solid rgba(196,96,122,0.3); background: rgba(255,255,255,0.6);
  color: var(--cream); font-family: 'Cormorant Garamond', serif; font-size: 0.95rem;
  cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.4rem;
  backdrop-filter: blur(8px);
}
.action-btn:hover { background: rgba(196,96,122,0.1); border-color: var(--rose); transform: translateY(-2px); }
.new-btn { border-color: rgba(196,96,122,0.3); }
.new-btn:hover { background: rgba(196,96,122,0.1); border-color: var(--rose); }

.whatsapp-btn {
  border-color: rgba(37,211,102,0.4) !important;
  color: #25d366 !important;
}
.whatsapp-btn:hover {
  background: rgba(37,211,102,0.1) !important;
  border-color: #25d366 !important;
  transform: translateY(-2px);
}

footer { margin-top: 2.5rem; text-align: center; font-size: 0.7rem; opacity: 0.25; letter-spacing: 0.15em; }

.expiry-section { margin-top: 0.2rem; }

.expiry-select {
  width: 100%;
  background: rgba(255,255,255,0.8);
  border: 1px solid rgba(42,138,154,0.3);
  border-radius: 0.75rem;
  color: var(--cream);
  font-family: 'Playfair Display', serif;
  font-size: 1rem;
  font-style: italic;
  padding: 0.7rem 1rem;
  outline: none;
  cursor: pointer;
  transition: border-color 0.3s, box-shadow 0.3s;
  appearance: none;
  -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%232a8a9a' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 1rem center;
  background-size: 12px;
  padding-right: 2.5rem;
}
.expiry-select:focus { border-color: var(--rose); box-shadow: 0 0 15px rgba(42,138,154,0.2); }

.expiry-custom {
  display: none;
  width: 100%;
  margin-top: 0.6rem;
  background: rgba(255,255,255,0.8);
  border: 1px solid rgba(42,138,154,0.3);
  border-radius: 0.75rem;
  color: var(--cream);
  font-family: 'Playfair Display', serif;
  font-size: 1rem;
  padding: 0.7rem 1rem;
  outline: none;
  transition: border-color 0.3s, box-shadow 0.3s;
}
.expiry-custom:focus { border-color: var(--rose); box-shadow: 0 0 15px rgba(42,138,154,0.2); }
</style>
</head>
<body>

<div class="stars" id="stars"></div>
<div class="floaters" id="floaters"></div>

<div class="app">
  <header>
    <span class="moon-icon">üåô</span>
    <h1>Vales de Amor</h1>
    <p class="subtitle">para Florecilla &amp; Chiquit√≠n</p>
  </header>

  <div class="install-banner" id="installBanner" onclick="installApp()">
    <div style="font-size:2rem">üì≤</div>
    <div class="install-text">
      <strong>Instalar en tu m√≥vil</strong>
      <span>A√±adir a pantalla de inicio</span>
    </div>
    <div>‚ûï</div>
  </div>

  <div class="sender-section">
    <div class="sender-label">¬øQui√©n env√≠a el vale?</div>
    <div class="sender-avatars-preview">
      <div class="sender-avatar-wrap">
        <div id="previewAvatarFrom"></div>
        <span id="previewNameFrom" class="sender-avatar-name">Florecilla</span>
      </div>
      <div style="font-size:1.4rem;opacity:0.45;align-self:center;">üíå</div>
      <div class="sender-avatar-wrap">
        <div id="previewAvatarTo"></div>
        <span id="previewNameTo" class="sender-avatar-name">Chiquit√≠n</span>
      </div>
    </div>
    <div class="sender-btns">
      <button class="sender-btn active" onclick="setSender('Florecilla', this)">üå∏ Florecilla</button>
      <button class="sender-btn" onclick="setSender('Chiquit√≠n', this)">üêæ Chiquit√≠n</button>
    </div>
  </div>

  <div class="form-card">
    <label class="form-label">‚ú¶ El vale dice...</label>
    <textarea class="concept-input" id="conceptInput"
      placeholder="un abrazo eterno, un beso sorpresa, una tarde de pelis juntos..."
      rows="3"></textarea>
    <button class="generate-btn" onclick="generateFlyer()">üåô Crear mi Vale de Amor</button>

    <div class="expiry-section">
      <label class="form-label" style="margin-top:1.1rem;">üìÖ Fecha de caducidad</label>
      <select class="expiry-select" id="expirySelect" onchange="toggleCustomDate(this)">
        <option value="nunca">‚ú® No caduca nunca</option>
        <option value="hoy">Hoy mismo</option>
        <option value="1semana">En 1 semana</option>
        <option value="1mes">En 1 mes</option>
        <option value="3meses">En 3 meses</option>
        <option value="6meses">En 6 meses</option>
        <option value="1a√±o">En 1 a√±o</option>
        <option value="custom">üìÜ Elegir fecha...</option>
      </select>
      <input type="date" class="expiry-custom" id="expiryCustom">
    </div>
  </div>

  <div class="suggestions">
    <div class="suggestions-title">‚ú¶ ideas para tu vale</div>
    <div class="tags" id="tags"></div>
  </div>

  <!-- TICKET -->
  <div class="flyer-container" id="flyerContainer">
    <div class="ticket-shadow">
      <div class="ticket">

        <!-- Zigzag top -->
        <div style="line-height:0;overflow:hidden;height:14px;">
          <svg viewBox="0 0 400 14" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
            <polygon points="0,0 400,0 400,14 390,0 380,14 370,0 360,14 350,0 340,14 330,0 320,14 310,0 300,14 290,0 280,14 270,0 260,14 250,0 240,14 230,0 220,14 210,0 200,14 190,0 180,14 170,0 160,14 150,0 140,14 130,0 120,14 110,0 100,14 90,0 80,14 70,0 60,14 50,0 40,14 30,0 20,14 10,0 0,14"
              fill="#f5ead0"/>
          </svg>
        </div>

        <!-- Main body -->
        <div class="ticket-body">
          <div class="ticket-watermark">Vale de Amor</div>

          <div class="ticket-header">
            <div>
              <div class="t-logo-icon">üåô</div>
              <div class="t-logo-text">Vale de amor</div>
            </div>
            <div>
              <div class="t-serial-label">N¬∫ de serie</div>
              <div class="t-serial-num" id="serialNum">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
            </div>
          </div>

          <hr class="t-hr">

          <div class="ticket-parties">
            <div class="t-party">
              <div class="t-avatar" id="avatarFrom">
                <!-- Florecilla avatar (default) -->
                <svg width="52" height="52" viewBox="0 0 52 52" xmlns="http://www.w3.org/2000/svg">
                  <!-- Circle bg -->
                  <circle cx="26" cy="26" r="25" fill="#e8f5f0" stroke="rgba(42,138,154,0.3)" stroke-width="1.5"/>
                  <!-- Neck -->
                  <rect x="21" y="33" width="10" height="8" rx="4" fill="#f5c8a0"/>
                  <!-- Body -->
                  <ellipse cx="26" cy="47" rx="13" ry="8" fill="#2a2a2a"/>
                  <!-- Face -->
                  <circle cx="26" cy="26" r="11" fill="#f5c8a0"/>
                  <!-- Hair top bun - back -->
                  <ellipse cx="26" cy="13" rx="8" ry="5" fill="#6b3a1f"/>
                  <!-- Hair sides -->
                  <ellipse cx="17" cy="22" rx="3" ry="6" fill="#7a4020"/>
                  <ellipse cx="35" cy="22" rx="3" ry="6" fill="#7a4020"/>
                  <!-- Hair top -->
                  <ellipse cx="26" cy="17" rx="9" ry="7" fill="#7a4020"/>
                  <!-- Bun -->
                  <circle cx="26" cy="12" r="5" fill="#6b3a1f"/>
                  <!-- Fringe -->
                  <path d="M17 20 Q26 16 35 20" fill="#7a4020"/>
                  <!-- Eyes -->
                  <ellipse cx="22" cy="26" rx="1.8" ry="2" fill="#3a2010"/>
                  <ellipse cx="30" cy="26" rx="1.8" ry="2" fill="#3a2010"/>
                  <!-- Eye shine -->
                  <circle cx="23" cy="25" r="0.6" fill="white"/>
                  <circle cx="31" cy="25" r="0.6" fill="white"/>
                  <!-- Smile -->
                  <path d="M21 30 Q26 34 31 30" stroke="#c47a5a" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                  <!-- Cheeks -->
                  <circle cx="19" cy="29" r="2.5" fill="rgba(255,150,120,0.25)"/>
                  <circle cx="33" cy="29" r="2.5" fill="rgba(255,150,120,0.25)"/>
                </svg>
              </div>
              <span class="t-party-label">de</span>
              <div class="t-party-name" id="ticketFrom">Florecilla</div>
            </div>
            <div class="t-arrow">üíå</div>
            <div class="t-party">
              <div class="t-avatar" id="avatarTo">
                <!-- Chiquit√≠n avatar (default) -->
                <svg width="52" height="52" viewBox="0 0 52 52" xmlns="http://www.w3.org/2000/svg">
                  <!-- Circle bg -->
                  <circle cx="26" cy="26" r="25" fill="#e8f0f8" stroke="rgba(42,138,154,0.3)" stroke-width="1.5"/>
                  <!-- Neck -->
                  <rect x="21" y="33" width="10" height="8" rx="4" fill="#d4a882"/>
                  <!-- Body -->
                  <ellipse cx="26" cy="47" rx="13" ry="8" fill="#1a1a1a"/>
                  <!-- Face -->
                  <circle cx="26" cy="26" r="11" fill="#d4a882"/>
                  <!-- Shaved head (very short, almost skin) -->
                  <circle cx="26" cy="21" r="11" fill="#c09070"/>
                  <!-- Very subtle stubble on head -->
                  <circle cx="26" cy="19" r="10.5" fill="#c89878"/>
                  <!-- Short beard -->
                  <path d="M18 30 Q26 38 34 30 Q30 35 26 36 Q22 35 18 30Z" fill="#b8a898"/>
                  <!-- Moustache area -->
                  <ellipse cx="26" cy="30" rx="5" ry="2" fill="#b0a090"/>
                  <!-- Sunglasses frame -->
                  <rect x="16" y="23" width="8" height="5.5" rx="2.5" fill="#1a1a2e" opacity="0.95"/>
                  <rect x="28" y="23" width="8" height="5.5" rx="2.5" fill="#1a1a2e" opacity="0.95"/>
                  <!-- Bridge -->
                  <line x1="24" y1="25.5" x2="28" y2="25.5" stroke="#1a1a2e" stroke-width="1.5"/>
                  <!-- Temple arms -->
                  <line x1="16" y1="25.5" x2="14" y2="25" stroke="#1a1a2e" stroke-width="1.5"/>
                  <line x1="36" y1="25.5" x2="38" y2="25" stroke="#1a1a2e" stroke-width="1.5"/>
                  <!-- Blue lens shine -->
                  <rect x="17" y="23.5" width="6" height="4" rx="2" fill="#3a6aee" opacity="0.6"/>
                  <rect x="29" y="23.5" width="6" height="4" rx="2" fill="#3a6aee" opacity="0.6"/>
                  <!-- Lens glare -->
                  <line x1="18" y1="24.5" x2="21" y2="24.5" stroke="rgba(255,255,255,0.4)" stroke-width="0.8"/>
                  <line x1="30" y1="24.5" x2="33" y2="24.5" stroke="rgba(255,255,255,0.4)" stroke-width="0.8"/>
                  <!-- Subtle smile -->
                  <path d="M22 31.5 Q26 34 30 31.5" stroke="#9a7a5a" stroke-width="1.2" fill="none" stroke-linecap="round"/>
                </svg>
              </div>
              <span class="t-party-label">para</span>
              <div class="t-party-name" id="ticketTo">Chiquit√≠n</div>
            </div>
          </div>

          <div class="ticket-vale">
            <div class="t-vale-label">‚ú¶ ¬∑ ¬∑ ¬∑ vale por ¬∑ ¬∑ ¬∑ ‚ú¶</div>
            <div class="t-vale-por">Este vale te da derecho a</div>
            <div class="t-vale-concept" id="ticketConcept">...</div>
            <div class="ticket-stamp">
              <div class="t-stamp-icon">üíú</div>
              <div class="t-stamp-text">con todo<br>mi amor</div>
            </div>
          </div>

          <div class="ticket-deco">üå∏ üåô üåπ üêæ üí´ ‚ù§Ô∏è üå∫ üê∂</div>

          <hr class="t-hr">

          <div class="ticket-footer">
            <div class="t-footer-l">Emitido con amor ‚ô•<br>
            <span id="ticketEmitido">--/--/----</span></div>
            <div class="t-footer-r">Caduca: <span id="ticketCaduca">nunca ‚ú®</span><br>Canjeable cuando quieras</div>
          </div>
        </div>

        <!-- Stub divider (zigzag bottom of main + top of stub) -->
        <div class="zz-mid-wrap">
          <div class="stub-scissors">‚úÇ</div>
          <div style="line-height:0;overflow:hidden;height:14px;">
            <svg viewBox="0 0 400 14" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
              <polygon points="0,14 400,14 400,0 390,14 380,0 370,14 360,0 350,14 340,0 330,14 320,0 310,14 300,0 290,14 280,0 270,14 260,0 250,14 240,0 230,14 220,0 210,14 200,0 190,14 180,0 170,14 160,0 150,14 140,0 130,14 120,0 110,14 100,0 90,14 80,0 70,14 60,0 50,14 40,0 30,14 20,0 10,14 0,0"
                fill="#e8d5a3"/>
            </svg>
          </div>
          <div class="ticket-stub">
            <div class="stub-info">
              <div class="stub-title" id="stubFrom">De Florecilla</div>
              <div class="stub-sub" id="stubConcept">vale por...</div>
            </div>
            <div class="barcode" id="barcode"></div>
            <div class="stub-right">
              <div id="stubSerial">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
              <div id="stubCaduca">No caduca üåô</div>
            </div>
          </div>
          <div style="line-height:0;overflow:hidden;height:14px;">
            <svg viewBox="0 0 400 14" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
              <polygon points="0,0 400,0 400,14 390,0 380,14 370,0 360,14 350,0 340,14 330,0 320,14 310,0 300,14 290,0 280,14 270,0 260,14 250,0 240,14 230,0 220,14 210,0 200,14 190,0 180,14 170,0 160,14 150,0 140,14 130,0 120,14 110,0 100,14 90,0 80,14 70,0 60,14 50,0 40,14 30,0 20,14 10,0 0,14"
                fill="#e8d5a3"/>
            </svg>
          </div>
        </div>

      </div>
    </div>

    <div class="action-btns">
      <button class="action-btn new-btn" onclick="resetForm()">üå∏ Nuevo Vale</button>
      <button class="action-btn" id="shareBtn" onclick="shareAsImage()">üì∏ Guardar imagen</button>
    </div>
    <div class="action-btns" style="margin-top:0.6rem;">
      <button class="action-btn whatsapp-btn" id="waBtn" onclick="shareWhatsapp()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
        Enviar por WhatsApp
      </button>
    </div>
  </div>

  <footer>üåô hecho con amor ¬∑ para siempre vuestro üåπ</footer>
</div>

<script>
const ideas = {
  Florecilla: [
    "un abrazo de oso muy largo","elegir la peli esta noche","un beso sorpresa",
    "un masaje en los pies","una tarde de mimos","preparo yo la cena",
    "un d√≠a sin quejas üòá","te dejo el mando",
  ],
  Chiquit√≠n: [
    "un paseo rom√°ntico","flores inesperadas","desayuno en la cama",
    "un beso cuando llegues","una sorpresa secreta","bailar contigo esta noche",
    "te escribo una carta","un d√≠a tuyo entero",
  ]
};

let sender = 'Florecilla';
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); deferredPrompt = e;
  document.getElementById('installBanner').classList.add('show');
});

function installApp() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(() => { deferredPrompt = null; document.getElementById('installBanner').classList.remove('show'); });
  } else {
    alert('Para instalar:\n‚Ä¢ iPhone: Compartir ‚Üí A√±adir a pantalla de inicio\n‚Ä¢ Android: Men√∫ ‚ãÆ ‚Üí A√±adir a pantalla de inicio');
  }
}

function setSender(name, btn) {
  sender = name;
  document.querySelectorAll('.sender-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTags();
  updateAvatars();
}

function renderTags() {
  document.getElementById('tags').innerHTML = ideas[sender].map(idea =>
    `<span class="tag" onclick="useSuggestion('${idea}')">${idea}</span>`
  ).join('');
}

function useSuggestion(text) {
  document.getElementById('conceptInput').value = text;
  document.getElementById('conceptInput').focus();
}

const AVATAR_FLORECILLA = `<svg width="52" height="52" viewBox="0 0 52 52" xmlns="http://www.w3.org/2000/svg">
  <circle cx="26" cy="26" r="25" fill="#e8f5f0" stroke="rgba(42,138,154,0.3)" stroke-width="1.5"/>
  <rect x="21" y="33" width="10" height="8" rx="4" fill="#f5c8a0"/>
  <ellipse cx="26" cy="47" rx="13" ry="8" fill="#2a2a2a"/>
  <circle cx="26" cy="26" r="11" fill="#f5c8a0"/>
  <ellipse cx="26" cy="13" rx="8" ry="5" fill="#6b3a1f"/>
  <ellipse cx="17" cy="22" rx="3" ry="6" fill="#7a4020"/>
  <ellipse cx="35" cy="22" rx="3" ry="6" fill="#7a4020"/>
  <ellipse cx="26" cy="17" rx="9" ry="7" fill="#7a4020"/>
  <circle cx="26" cy="12" r="5" fill="#6b3a1f"/>
  <path d="M17 20 Q26 16 35 20" fill="#7a4020"/>
  <ellipse cx="22" cy="26" rx="1.8" ry="2" fill="#3a2010"/>
  <ellipse cx="30" cy="26" rx="1.8" ry="2" fill="#3a2010"/>
  <circle cx="23" cy="25" r="0.6" fill="white"/>
  <circle cx="31" cy="25" r="0.6" fill="white"/>
  <path d="M21 30 Q26 34 31 30" stroke="#c47a5a" stroke-width="1.5" fill="none" stroke-linecap="round"/>
  <circle cx="19" cy="29" r="2.5" fill="rgba(255,150,120,0.25)"/>
  <circle cx="33" cy="29" r="2.5" fill="rgba(255,150,120,0.25)"/>
</svg>`;

const AVATAR_CHIQUTIN = `<svg width="52" height="52" viewBox="0 0 52 52" xmlns="http://www.w3.org/2000/svg">
  <circle cx="26" cy="26" r="25" fill="#e8f0f8" stroke="rgba(42,138,154,0.3)" stroke-width="1.5"/>
  <rect x="21" y="33" width="10" height="8" rx="4" fill="#d4a882"/>
  <ellipse cx="26" cy="47" rx="13" ry="8" fill="#1a1a1a"/>
  <circle cx="26" cy="26" r="11" fill="#d4a882"/>
  <circle cx="26" cy="21" r="11" fill="#c09070"/>
  <circle cx="26" cy="19" r="10.5" fill="#c89878"/>
  <path d="M18 30 Q26 38 34 30 Q30 35 26 36 Q22 35 18 30Z" fill="#b8a898"/>
  <ellipse cx="26" cy="30" rx="5" ry="2" fill="#b0a090"/>
  <rect x="16" y="23" width="8" height="5.5" rx="2.5" fill="#1a1a2e" opacity="0.95"/>
  <rect x="28" y="23" width="8" height="5.5" rx="2.5" fill="#1a1a2e" opacity="0.95"/>
  <line x1="24" y1="25.5" x2="28" y2="25.5" stroke="#1a1a2e" stroke-width="1.5"/>
  <line x1="16" y1="25.5" x2="14" y2="25" stroke="#1a1a2e" stroke-width="1.5"/>
  <line x1="36" y1="25.5" x2="38" y2="25" stroke="#1a1a2e" stroke-width="1.5"/>
  <rect x="17" y="23.5" width="6" height="4" rx="2" fill="#3a6aee" opacity="0.6"/>
  <rect x="29" y="23.5" width="6" height="4" rx="2" fill="#3a6aee" opacity="0.6"/>
  <line x1="18" y1="24.5" x2="21" y2="24.5" stroke="rgba(255,255,255,0.4)" stroke-width="0.8"/>
  <line x1="30" y1="24.5" x2="33" y2="24.5" stroke="rgba(255,255,255,0.4)" stroke-width="0.8"/>
  <path d="M22 31.5 Q26 34 30 31.5" stroke="#9a7a5a" stroke-width="1.2" fill="none" stroke-linecap="round"/>
</svg>`;

function updateAvatars() {
  const fromFlor = sender === 'Florecilla';
  const avatarA = fromFlor ? AVATAR_FLORECILLA : AVATAR_CHIQUTIN;
  const avatarB = fromFlor ? AVATAR_CHIQUTIN : AVATAR_FLORECILLA;
  const nameA   = fromFlor ? 'Florecilla' : 'Chiquit√≠n';
  const nameB   = fromFlor ? 'Chiquit√≠n' : 'Florecilla';

  // Ticket avatars
  const elFrom = document.getElementById('avatarFrom');
  const elTo   = document.getElementById('avatarTo');
  if (elFrom) elFrom.innerHTML = avatarA;
  if (elTo)   elTo.innerHTML   = avatarB;

  // Sender section previews (always visible)
  const pFrom = document.getElementById('previewAvatarFrom');
  const pTo   = document.getElementById('previewAvatarTo');
  const nFrom = document.getElementById('previewNameFrom');
  const nTo   = document.getElementById('previewNameTo');
  if (pFrom) pFrom.innerHTML = avatarA;
  if (pTo)   pTo.innerHTML   = avatarB;
  if (nFrom) nFrom.textContent = nameA;
  if (nTo)   nTo.textContent   = nameB;
}

function toggleCustomDate(sel) {
  const custom = document.getElementById('expiryCustom');
  custom.style.display = sel.value === 'custom' ? 'block' : 'none';
}

function getExpiryText() {
  const sel = document.getElementById('expirySelect').value;
  const now = new Date();
  const fmt = (d) => d.toLocaleDateString('es-ES', {day:'2-digit', month:'2-digit', year:'numeric'});

  if (sel === 'nunca') return 'nunca ‚ú®';
  if (sel === 'hoy') return fmt(now);
  if (sel === 'custom') {
    const val = document.getElementById('expiryCustom').value;
    if (!val) return 'nunca ‚ú®';
    return fmt(new Date(val + 'T12:00:00'));
  }
  const d = new Date(now);
  if (sel === '1semana') d.setDate(d.getDate() + 7);
  if (sel === '1mes')    d.setMonth(d.getMonth() + 1);
  if (sel === '3meses')  d.setMonth(d.getMonth() + 3);
  if (sel === '6meses')  d.setMonth(d.getMonth() + 6);
  if (sel === '1a√±o')    d.setFullYear(d.getFullYear() + 1);
  return fmt(d);
}

function generateSerial() {
  const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let s = '';
  for (let i = 0; i < 8; i++) { if (i===4) s+='-'; s += c[Math.floor(Math.random()*c.length)]; }
  return s;
}

function generateBarcode() {
  const c = document.getElementById('barcode');
  c.innerHTML = '';
  [1,2,1,3,1,2,2,1,3,1,2,1,1,3,2,1,2,1,3,1,2].forEach(w => {
    const b = document.createElement('div');
    b.className = 'bc-bar';
    b.style.width = w + 'px';
    c.appendChild(b);
  });
}

function generateFlyer() {
  const concept = document.getElementById('conceptInput').value.trim();
  if (!concept) {
    document.getElementById('conceptInput').style.borderColor = 'var(--rose)';
    setTimeout(() => document.getElementById('conceptInput').style.borderColor = '', 1500);
    return;
  }
  const receiver = sender === 'Florecilla' ? 'Chiquit√≠n' : 'Florecilla';
  const serial = generateSerial();
  const dateStr = new Date().toLocaleDateString('es-ES', {day:'2-digit',month:'2-digit',year:'numeric'});
  const expiryText = getExpiryText();

  document.getElementById('ticketFrom').textContent = sender;
  document.getElementById('ticketTo').textContent = receiver;
  document.getElementById('ticketConcept').textContent = concept;
  document.getElementById('serialNum').textContent = serial;
  document.getElementById('ticketEmitido').textContent = dateStr;
  document.getElementById('ticketCaduca').textContent = expiryText;
  document.getElementById('stubFrom').textContent = 'De ' + sender;
  document.getElementById('stubConcept').textContent = concept.length > 22 ? concept.slice(0,22)+'‚Ä¶' : concept;
  document.getElementById('stubSerial').textContent = serial;
  document.getElementById('stubCaduca').textContent = expiryText === 'nunca ‚ú®' ? 'No caduca ‚ú®' : 'Caduca: ' + expiryText;

  generateBarcode();

  const container = document.getElementById('flyerContainer');
  container.classList.remove('visible');
  void container.offsetWidth;
  container.classList.add('visible');
  container.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function resetForm() {
  document.getElementById('conceptInput').value = '';
  document.getElementById('flyerContainer').classList.remove('visible');
  document.querySelector('.form-card').scrollIntoView({ behavior: 'smooth' });
}

async function captureTicket() {
  const ticket = document.querySelector('.ticket-shadow');
  // Temporarily add a white padding wrapper so shadow isn't clipped
  const canvas = await html2canvas(ticket, {
    scale: 3,
    useCORS: true,
    allowTaint: true,
    backgroundColor: '#1a0a2e',
    logging: false,
    onclone: (doc) => {
      // Ensure fonts render in clone
      doc.querySelectorAll('*').forEach(el => {
        el.style.webkitPrintColorAdjust = 'exact';
      });
    }
  });
  return canvas;
}

async function shareAsImage() {
  const btn = document.getElementById('shareBtn');
  btn.textContent = '‚è≥ Generando...';
  btn.disabled = true;
  try {
    const canvas = await captureTicket();
    canvas.toBlob(async (blob) => {
      const file = new File([blob], 'vale-de-amor.png', { type: 'image/png' });
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({ files: [file], title: 'Vale de Amor üåô' });
      } else {
        // Fallback: download the image
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'vale-de-amor.png'; a.click();
        URL.revokeObjectURL(url);
      }
      btn.textContent = '‚úÖ ¬°Listo!';
      setTimeout(() => { btn.textContent = 'üì∏ Guardar imagen'; btn.disabled = false; }, 2000);
    }, 'image/png');
  } catch(e) {
    btn.textContent = 'üì∏ Guardar imagen';
    btn.disabled = false;
  }
}

async function shareWhatsapp() {
  const waBtn = document.getElementById('waBtn');
  waBtn.innerHTML = '‚è≥ Generando imagen...';
  waBtn.disabled = true;
  try {
    const canvas = await captureTicket();
    canvas.toBlob(async (blob) => {
      const file = new File([blob], 'vale-de-amor.png', { type: 'image/png' });
      // Try Web Share API with file (works on Android Chrome & iOS Safari 15+)
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({ files: [file], title: 'üíú Te env√≠o un Vale de Amor üåô' });
          waBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg> ¬°Enviado!`;
          setTimeout(() => {
            waBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg> Enviar por WhatsApp`;
            waBtn.disabled = false;
          }, 2500);
          return;
        } catch(e) { /* user cancelled or error, fall through */ }
      }
      // Fallback: download image + open WhatsApp
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'vale-de-amor.png'; a.click();
      URL.revokeObjectURL(url);
      setTimeout(() => {
        window.open('https://wa.me/?text=' + encodeURIComponent('üíú Te env√≠o un Vale de Amor üåô (adjunta la imagen que acaba de descargarse)'), '_blank');
      }, 800);
      waBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg> Enviar por WhatsApp`;
      waBtn.disabled = false;
    }, 'image/png');
  } catch(e) {
    waBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg> Enviar por WhatsApp`;
    waBtn.disabled = false;
  }
}

function createStars() {
  const c = document.getElementById('stars');
  const colors = ['rgba(42,138,154,0.45)','rgba(26,122,102,0.4)','rgba(80,180,200,0.4)','rgba(42,160,130,0.35)','rgba(100,200,220,0.3)'];
  for (let i = 0; i < 55; i++) {
    const s = document.createElement('div'); s.className = 'star';
    const sz = Math.random()*3+1;
    s.style.cssText = `width:${sz}px;height:${sz}px;top:${Math.random()*100}%;left:${Math.random()*100}%;background:${colors[Math.floor(Math.random()*colors.length)]};--d:${2+Math.random()*4}s;animation-delay:${Math.random()*4}s`;
    c.appendChild(s);
  }
}
function createFloaters() {
  const emojis = ['üå∏','üåô','üíú','üåπ','üêæ','üí´','‚ù§Ô∏è','üå∫','‚≠ê','üê∂'];
  const c = document.getElementById('floaters');
  for (let i = 0; i < 10; i++) {
    const el = document.createElement('div'); el.className = 'floater';
    el.textContent = emojis[i%emojis.length];
    el.style.cssText = `top:${Math.random()*100}%;left:${Math.random()*100}%;--d:${3+Math.random()*5}s;animation-delay:${Math.random()*3}s;font-size:${1+Math.random()*2}rem`;
    c.appendChild(el);
  }
}

createStars(); createFloaters(); renderTags(); updateAvatars();

if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Vales de Amor para Florecilla y Chiquit√≠n">
<meta name="theme-color" content="#d0eef8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Vales de Amor">
<title>Vales de Amor üåô</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Special+Elite&display=swap" rel="stylesheet">
<script src="pocketbase.js" defer></script>
<style>
:root {
  --rose: #1a6070;
  --blush: #1a6a5a;
  --gold: #0a4a5a;
  --cream: #062535;
  --moonlight: #0d3d50;
  --parchment: #f5ead0;
  --parchment-dark: #e8d5a3;
  --ink: #2c1810;
  --ink-light: #4a2e1a;
  --teal: #1a6a7a;
  --mint: #1a6a5a;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: linear-gradient(160deg, #d0eef8 0%, #c8f0e8 30%, #d8f0f0 55%, #b8e8f5 80%, #c0f0e0 100%);
  background-attachment: fixed;
  min-height: 100vh;
  font-family: 'Cormorant Garamond', serif;
  color: var(--cream);
  overflow-x: hidden;
}

/* ===== ONBOARDING OVERLAY ===== */
.onboarding-overlay {
  position: fixed; inset: 0; z-index: 1000;
  background: linear-gradient(160deg, #d0eef8 0%, #c8f0e8 40%, #b8e8f5 100%);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 2rem; text-align: center;
  animation: fadeIn 0.5s ease;
}
.onboarding-overlay.hidden { display: none; }
.onboarding-icon { font-size: 4rem; margin-bottom: 1rem; animation: float 3s ease-in-out infinite; }
.onboarding-title {
  font-family: 'Playfair Display', serif; font-size: 2rem; font-style: italic;
  background: linear-gradient(135deg, #1a7a8a, #2a9a7a, #1a6a9a);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  margin-bottom: 0.5rem;
}
.onboarding-sub {
  font-size: 1rem; color: var(--moonlight); margin-bottom: 2.5rem;
  font-style: italic; opacity: 0.8;
}
.onboarding-question {
  font-family: 'Playfair Display', serif; font-size: 1.15rem;
  color: var(--cream); margin-bottom: 1.5rem; font-weight: 700;
}
.onboarding-btns { display: flex; flex-direction: column; gap: 1rem; width: 100%; max-width: 280px; }
.onboarding-btn {
  display: flex; align-items: center; gap: 1rem;
  padding: 1rem 1.5rem; border-radius: 1rem;
  border: 1.5px solid rgba(42,138,154,0.3);
  background: rgba(255,255,255,0.7);
  backdrop-filter: blur(10px);
  cursor: pointer; transition: all 0.25s;
  box-shadow: 0 4px 16px rgba(42,138,154,0.1);
}
.onboarding-btn:hover {
  transform: translateY(-3px) scale(1.02);
  border-color: var(--teal);
  box-shadow: 0 8px 24px rgba(42,138,154,0.2);
}
.onboarding-btn-avatar { flex-shrink: 0; }
.onboarding-btn-name {
  font-family: 'Playfair Display', serif; font-size: 1.2rem;
  font-style: italic; font-weight: 700; color: var(--cream);
}
.onboarding-btn-sub { font-size: 0.75rem; color: var(--moonlight); opacity: 0.7; }

/* ===== NEW VALE NOTIFICATION ===== */
.new-vale-overlay {
  position: fixed; inset: 0; z-index: 900;
  background: rgba(0,0,0,0.5); backdrop-filter: blur(6px);
  display: flex; align-items: center; justify-content: center;
  padding: 1.5rem; opacity: 0;
  transition: opacity 0.4s;
  pointer-events: none;
}
.new-vale-overlay.visible { opacity: 1; pointer-events: all; }
.new-vale-popup {
  background: linear-gradient(160deg, #e8f8f0, #d8f5f8);
  border: 1.5px solid rgba(42,138,154,0.25);
  border-radius: 1.5rem;
  padding: 1.8rem 1.5rem;
  max-width: 360px; width: 100%;
  box-shadow: 0 20px 60px rgba(42,138,154,0.2);
  transform: scale(0.9) translateY(20px);
  transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1);
  text-align: center;
}
.new-vale-overlay.visible .new-vale-popup { transform: scale(1) translateY(0); }
.new-vale-popup-icon { font-size: 3rem; margin-bottom: 0.5rem; }
.new-vale-popup-title {
  font-family: 'Playfair Display', serif; font-size: 1.4rem; font-style: italic;
  color: var(--cream); font-weight: 700; margin-bottom: 0.3rem;
}
.new-vale-popup-sub { font-size: 0.9rem; color: var(--moonlight); margin-bottom: 1.2rem; font-style: italic; }
.new-vale-list { display: flex; flex-direction: column; gap: 0.6rem; margin-bottom: 1.4rem; text-align: left; }
.new-vale-item {
  background: rgba(255,255,255,0.7); border: 1px solid rgba(42,138,154,0.2);
  border-radius: 0.75rem; padding: 0.65rem 0.9rem;
  font-family: 'Playfair Display', serif; font-style: italic;
  font-size: 0.95rem; color: var(--cream);
}
.new-vale-item-from { font-size: 0.7rem; color: var(--moonlight); font-style: normal; margin-top: 2px; }
.new-vale-close {
  width: 100%; padding: 0.8rem;
  background: linear-gradient(135deg, #2a8a9a, #1a7a6a);
  border: none; border-radius: 0.75rem;
  color: white; font-family: 'Playfair Display', serif;
  font-size: 1rem; font-style: italic; cursor: pointer;
  box-shadow: 0 4px 14px rgba(42,138,154,0.35);
  transition: transform 0.2s, box-shadow 0.2s;
}
.new-vale-close:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(42,138,154,0.45); }

/* ===== WALLET UNREAD BADGE ===== */
.wallet-tab-badge {
  display: inline-flex; align-items: center; justify-content: center;
  background: #e03030; color: white;
  border-radius: 50%; width: 18px; height: 18px;
  font-size: 0.65rem; font-family: sans-serif; font-style: normal; font-weight: 700;
  margin-left: 0.35rem; vertical-align: middle;
  animation: pulse 1.5s ease-in-out infinite;
}
@keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.2); } }

/* Current user chip */
.current-user-chip {
  display: flex; align-items: center; gap: 0.5rem;
  background: rgba(255,255,255,0.6); border: 1px solid rgba(42,138,154,0.2);
  border-radius: 2rem; padding: 0.3rem 0.8rem 0.3rem 0.4rem;
  backdrop-filter: blur(8px); cursor: pointer;
  transition: all 0.2s; margin-bottom: 1rem;
  font-family: 'Playfair Display', serif; font-style: italic;
  font-size: 0.8rem; color: var(--moonlight);
}
.current-user-chip:hover { background: rgba(255,255,255,0.85); border-color: var(--teal); }
.current-user-chip-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: linear-gradient(135deg, #2a8a9a, #1a7a6a);
  flex-shrink: 0;
}


.stars { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
.star {
  position: absolute; border-radius: 50%;
  animation: twinkle var(--d, 3s) ease-in-out infinite alternate;
}
@keyframes twinkle { from { opacity: 0.2; transform: scale(0.8); } to { opacity: 0.8; transform: scale(1.2); } }
.floaters { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
.floater {
  position: absolute; opacity: 0.22;
  animation: floatUp var(--d, 4s) ease-in-out infinite alternate;
}
@keyframes floatUp { from { transform: translateY(0) rotate(-5deg); } to { transform: translateY(-18px) rotate(5deg); } }

/* ===== LAYOUT ===== */
.container {
  max-width: 520px; margin: 0 auto; padding: 2rem 1.2rem 3rem;
  display: flex; flex-direction: column; align-items: center;
  position: relative; z-index: 1;
}

/* ===== HEADER ===== */
.header { text-align: center; margin-bottom: 2rem; }
.moon-icon { font-size: 2.2rem; display: block; margin-bottom: 0.4rem;
  animation: moonGlow 3s ease-in-out infinite alternate;
  filter: drop-shadow(0 0 8px rgba(42,138,154,0.4));
}
@keyframes moonGlow {
  from { filter: drop-shadow(0 0 8px rgba(42,138,154,0.4)); }
  to   { filter: drop-shadow(0 0 25px rgba(42,154,122,0.7)); }
}
h1 {
  font-family: 'Playfair Display', serif;
  font-size: 2.1rem; font-style: italic;
  background: linear-gradient(135deg, #1a7a8a, #2a9a7a, #1a6a9a);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.subtitle {
  font-size: 0.85rem; color: var(--moonlight);
  letter-spacing: 0.25em; text-transform: uppercase; margin-top: 0.4rem;
}

/* ===== INSTALL BANNER ===== */
.install-banner {
  display: none; width: 100%; max-width: 480px;
  background: rgba(255,255,255,0.55); border: 1px solid rgba(42,138,154,0.2);
  border-radius: 0.75rem; padding: 0.8rem 1.2rem; margin-bottom: 1.2rem;
  cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s;
  display: flex; align-items: center; gap: 0.8rem;
}
.install-icon { font-size: 1.5rem; }
.install-text strong { display: block; font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--gold); }
.install-text span { font-size: 0.8rem; opacity: 0.7; }

/* ===== SENDER SECTION ===== */
.sender-section {
  display: flex; flex-direction: column; align-items: center; gap: 0.6rem;
  margin-bottom: 1.8rem;
  background: rgba(255,255,255,0.55); border: 1px solid rgba(42,138,154,0.2);
  border-radius: 1rem; padding: 1rem 1.5rem;
  backdrop-filter: blur(10px); width: 100%; max-width: 480px;
  box-shadow: 0 4px 20px rgba(42,138,154,0.1);
}
.sender-label { font-size: 0.8rem; color: var(--teal); letter-spacing: 0.18em; text-transform: uppercase; font-weight: 700; }
.sender-avatars-preview {
  display: flex; align-items: center; justify-content: center; gap: 1.2rem; margin-bottom: 0.8rem;
}
.sender-avatar-wrap { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; }
.sender-avatar-name {
  font-family: 'Playfair Display', serif; font-size: 0.75rem; font-style: italic; color: var(--moonlight);
}
.sender-avatar-wrap svg { filter: drop-shadow(0 3px 8px rgba(42,138,154,0.25)); transition: transform 0.3s; }
.sender-avatar-wrap svg:hover { transform: scale(1.1); }
.sender-btns { display: flex; gap: 0.7rem; }
.sender-btn {
  padding: 0.55rem 1.3rem; border: 1px solid rgba(42,138,154,0.35);
  border-radius: 2rem; background: rgba(255,255,255,0.5); color: var(--cream);
  font-family: 'Playfair Display', serif; font-size: 0.95rem; cursor: pointer; transition: all 0.3s;
}
.sender-btn.active {
  background: linear-gradient(135deg, #2a8a9a, #1a7a6a);
  border-color: #2a8a9a; box-shadow: 0 0 18px rgba(42,138,154,0.4); color: white;
}
.sender-btn:hover:not(.active) { background: rgba(42,138,154,0.1); }

/* ===== FORM CARD ===== */
.form-card {
  width: 100%; max-width: 480px; margin-bottom: 1.5rem;
  background: rgba(255,255,255,0.6); border: 1px solid rgba(42,138,154,0.2);
  border-radius: 1rem; padding: 1.5rem;
  backdrop-filter: blur(12px); box-shadow: 0 4px 20px rgba(42,138,154,0.1);
}
.form-label {
  font-size: 0.75rem; letter-spacing: 0.2em; text-transform: uppercase;
  color: var(--teal); margin-bottom: 0.5rem; display: block; font-weight: 700;
}
.concept-input {
  width: 100%; background: rgba(255,255,255,0.7);
  border: 1px solid rgba(42,138,154,0.25);
  border-radius: 0.75rem; color: var(--cream);
  font-family: 'Playfair Display', serif;
  font-size: 1.05rem; font-style: italic; font-weight: 600;
  padding: 0.75rem 1rem; outline: none; resize: none;
  transition: border-color 0.3s, box-shadow 0.3s;
}
.concept-input::placeholder { color: rgba(6,37,53,0.45); }
.concept-input:focus { border-color: var(--rose); box-shadow: 0 0 15px rgba(42,138,154,0.2); }

.generate-btn {
  width: 100%; padding: 0.95rem; margin-top: 1rem;
  background: linear-gradient(135deg, #2a8a9a 0%, #1a7a6a 50%, #1a6a9a 100%);
  border: none; border-radius: 0.75rem; color: white;
  font-family: 'Playfair Display', serif; font-size: 1.05rem; font-style: italic;
  cursor: pointer; transition: all 0.3s;
  box-shadow: 0 4px 20px rgba(42,138,154,0.35);
  overflow: hidden; position: relative;
}
.generate-btn::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.15), transparent);
  transform: translateX(-100%); transition: transform 0.5s;
}
.generate-btn:hover::before { transform: translateX(100%); }
.generate-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(42,138,154,0.5); }

/* ===== EXPIRY ===== */
.expiry-section { margin-top: 0.2rem; }
.expiry-select {
  width: 100%; background: rgba(255,255,255,0.8);
  border: 1px solid rgba(42,138,154,0.3); border-radius: 0.75rem;
  color: var(--cream); font-family: 'Playfair Display', serif;
  font-size: 1rem; font-style: italic; padding: 0.7rem 2.5rem 0.7rem 1rem;
  outline: none; cursor: pointer; transition: border-color 0.3s, box-shadow 0.3s;
  appearance: none; -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%232a8a9a' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 1rem center; background-size: 12px;
}
.expiry-select:focus { border-color: var(--rose); box-shadow: 0 0 15px rgba(42,138,154,0.2); }
.expiry-custom {
  display: none; width: 100%; margin-top: 0.6rem;
  background: rgba(255,255,255,0.8);
  border: 1px solid rgba(42,138,154,0.3); border-radius: 0.75rem;
  color: var(--cream); font-family: 'Playfair Display', serif;
  font-size: 1rem; padding: 0.7rem 1rem; outline: none;
  transition: border-color 0.3s, box-shadow 0.3s;
}
.expiry-custom:focus { border-color: var(--rose); box-shadow: 0 0 15px rgba(42,138,154,0.2); }

/* ===== SUGGESTIONS ===== */
.suggestions { width: 100%; max-width: 480px; margin-bottom: 2rem; }
.suggestions-title {
  font-size: 0.75rem; letter-spacing: 0.2em; text-transform: uppercase;
  color: var(--teal); margin-bottom: 0.7rem;
}
.tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
.tag {
  padding: 0.3rem 0.75rem; border: 1px solid rgba(42,138,154,0.25);
  border-radius: 2rem; background: rgba(255,255,255,0.5);
  font-family: 'Playfair Display', serif; font-size: 0.82rem; font-style: italic; color: var(--cream);
  cursor: pointer; transition: all 0.25s;
}
.tag:hover { background: rgba(42,138,154,0.1); border-color: var(--teal); color: var(--moonlight); }

/* ===== TICKET ===== */
.flyer-container { width: 100%; max-width: 460px; display: none; }
.flyer-container.visible { display: block; animation: fadeUp 0.7s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(40px) scale(0.95); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}
.ticket-shadow {
  filter: drop-shadow(0 20px 40px rgba(42,138,154,0.22)) drop-shadow(0 8px 20px rgba(0,0,0,0.12));
}
.ticket { border-radius: 0.8rem; overflow: hidden; }
.ticket-header {
  background: linear-gradient(135deg, #2a8a9a, #1a7a6a);
  padding: 0.7rem 1.2rem; display: flex; justify-content: space-between; align-items: center;
}
.t-logo { display: flex; align-items: center; gap: 0.4rem; }
.t-logo-icon { font-size: 1rem; }
.t-logo-text {
  font-family: 'Special Elite', monospace; font-size: 0.6rem;
  letter-spacing: 0.2em; text-transform: uppercase; color: rgba(255,255,255,0.9);
}
.t-serial { text-align: right; }
.t-serial-label {
  font-family: 'Special Elite', monospace; font-size: 0.45rem;
  letter-spacing: 0.25em; text-transform: uppercase; color: rgba(255,255,255,0.7);
}
.t-serial-num {
  font-family: 'Special Elite', monospace; font-size: 0.65rem;
  letter-spacing: 0.15em; color: rgba(255,255,255,0.95);
}
.ticket-body {
  background: var(--parchment); padding: 1rem 1.2rem; position: relative; overflow: hidden;
}
.ticket-body::after {
  content: ''; position: absolute; inset: 0; pointer-events: none;
  background-image: repeating-linear-gradient(0deg, transparent, transparent 27px, rgba(139,90,43,0.06) 27px, rgba(139,90,43,0.06) 28px);
}
.ticket-watermark {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%) rotate(-30deg);
  font-family: 'Playfair Display', serif; font-size: 4rem; font-style: italic; font-weight: 700;
  color: rgba(42,138,154,0.06); white-space: nowrap; pointer-events: none; z-index: 0; line-height: 1;
}
.t-hr { border: none; border-top: 1px solid rgba(139,90,43,0.15); margin: 0.6rem 0; }
.ticket-parties { display: flex; align-items: center; justify-content: space-between; margin: 0.5rem 0; position: relative; z-index: 1; }
.t-party { text-align: center; flex: 1; }
.t-avatar { display: flex; justify-content: center; margin-bottom: 0.3rem; }
.t-avatar svg { filter: drop-shadow(0 2px 6px rgba(42,138,154,0.2)); transition: transform 0.3s; }
.t-avatar svg:hover { transform: scale(1.08); }
.t-party-label { font-family: 'Special Elite', monospace; font-size: 0.5rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--ink-light); display: block; margin-bottom: 2px; }
.t-party-name { font-family: 'Playfair Display', serif; font-size: 0.9rem; font-style: italic; color: var(--ink); }
.t-arrow { font-size: 1.2rem; opacity: 0.7; padding: 0 0.4rem; }
.ticket-vale {
  background: rgba(42,138,154,0.06); border: 1px solid rgba(42,138,154,0.25);
  border-radius: 0.4rem; padding: 0.7rem 0.9rem; margin: 0.5rem 0; position: relative; z-index: 1;
}
.t-vale-label { font-family: 'Special Elite', monospace; font-size: 0.5rem; letter-spacing: 0.2em; color: var(--ink-light); margin-bottom: 0.35rem; }
.t-vale-por { font-family: 'Cormorant Garamond', serif; font-size: 0.7rem; font-style: italic; color: var(--ink-light); margin-bottom: 0.2rem; }
.t-vale-concept { font-family: 'Playfair Display', serif; font-size: 1rem; font-weight: 700; color: var(--ink); line-height: 1.3; }
.ticket-deco { text-align: center; font-size: 1rem; margin: 0.55rem 0; opacity: 0.7; position: relative; z-index: 1; }
.ticket-stamp {
  position: absolute; top: 1rem; right: 1rem;
  width: 52px; height: 52px; border: 2px solid rgba(42,138,154,0.5);
  border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center;
  transform: rotate(15deg); z-index: 2;
}
.t-stamp-icon { font-size: 1.1rem; }
.t-stamp-text { font-family: 'Special Elite', monospace; font-size: 0.3rem; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(42,138,154,0.7); text-align: center; line-height: 1.3; }
.ticket-footer { display: flex; justify-content: space-between; margin-top: 0.5rem; position: relative; z-index: 1; }
.t-footer-l, .t-footer-r {
  font-family: 'Special Elite', monospace; font-size: 0.5rem;
  letter-spacing: 0.08em; color: var(--ink-light); line-height: 1.6;
}
.t-footer-r { text-align: right; }

/* Zigzag tear */
.zz-mid-wrap { line-height: 0; position: relative; z-index: 2; }
.zz-mid-wrap svg { display: block; width: 100%; }

/* Stub */
.ticket-stub {
  background: linear-gradient(135deg, var(--parchment-dark), var(--parchment));
  padding: 0.65rem 1.2rem;
  display: flex; align-items: center; justify-content: space-between; gap: 1rem;
}
.stub-left { flex: 1; }
.stub-title { font-family: 'Playfair Display', serif; font-size: 0.78rem; font-style: italic; font-weight: 700; color: var(--ink); }
.stub-sub { font-family: 'Special Elite', monospace; font-size: 0.45rem; letter-spacing: 0.1em; color: var(--ink-light); text-transform: uppercase; margin-top: 2px; }
.stub-right { font-family: 'Special Elite', monospace; font-size: 0.45rem; letter-spacing: 0.08em; color: var(--ink-light); text-align: right; line-height: 1.6; }
.barcode { display: flex; gap: 1.5px; align-items: stretch; height: 32px; opacity: 0.35; flex-shrink: 0; }
.bc-bar { background: var(--ink); border-radius: 1px; }

/* ===== ACTION BTNS ===== */
.action-btns { display: flex; gap: 1rem; margin-top: 1.5rem; }
.action-btn {
  flex: 1; padding: 0.75rem; border: 1px solid rgba(42,138,154,0.25);
  border-radius: 0.75rem; background: rgba(255,255,255,0.6);
  color: var(--cream); font-weight: 600; font-family: 'Cormorant Garamond', serif; font-size: 0.95rem;
  cursor: pointer; transition: all 0.3s; backdrop-filter: blur(8px);
  display: flex; align-items: center; justify-content: center; gap: 0.4rem;
}
.action-btn:hover { background: rgba(42,138,154,0.1); border-color: var(--teal); }
.action-btn.whatsapp-btn {
  background: linear-gradient(135deg, #25d366, #128c7e);
  border-color: #25d366; color: white !important;
}
.action-btn.whatsapp-btn:hover { opacity: 0.9; transform: translateY(-1px); }

/* ===== WALLET ===== */
.wallet-section { width: 100%; max-width: 480px; margin-top: 2.5rem; }
.wallet-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
.wallet-title {
  font-family: 'Playfair Display', serif; font-size: 1.3rem; font-style: italic;
  background: linear-gradient(135deg, #0a5060, #0a6050);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.wallet-tabs { display: flex; gap: 0.5rem; margin-bottom: 0.8rem; }
.wallet-tab {
  flex: 1; padding: 0.55rem 0.5rem;
  border: 1px solid rgba(42,138,154,0.3); border-radius: 2rem;
  background: rgba(255,255,255,0.5); color: var(--cream);
  font-family: 'Playfair Display', serif; font-size: 0.85rem; font-style: italic;
  cursor: pointer; transition: all 0.25s; text-align: center;
}
.wallet-tab.active {
  background: linear-gradient(135deg, #2a8a9a, #1a7a6a);
  border-color: #2a8a9a; color: white; box-shadow: 0 0 14px rgba(42,138,154,0.35);
}
/* Subtabs para Emitidos/Recibidos */
.wallet-subtabs { display: flex; gap: 0.4rem; margin-bottom: 1rem; }
.wallet-subtab {
  flex: 1; padding: 0.4rem 0.4rem;
  border: 1px solid rgba(42,138,154,0.2); border-radius: 1.5rem;
  background: rgba(255,255,255,0.4); color: var(--moonlight);
  font-family: 'Playfair Display', serif; font-size: 0.75rem; font-style: italic;
  cursor: pointer; transition: all 0.2s; text-align: center;
}
.wallet-subtab:hover { background: rgba(255,255,255,0.6); }
.wallet-subtab.active {
  background: rgba(42,138,154,0.15);
  border-color: rgba(42,138,154,0.4); color: var(--teal); font-weight: 600;
}
.wallet-subtab .subtab-count {
  display: inline-block; min-width: 18px; height: 18px;
  background: rgba(42,138,154,0.2); border-radius: 50%;
  font-size: 0.65rem; line-height: 18px; margin-left: 0.3rem;
  font-weight: 600; font-style: normal;
}
.wallet-subtab.active .subtab-count { background: rgba(42,138,154,0.3); }
.wallet-empty {
  text-align: center; padding: 2rem 1rem;
  background: rgba(255,255,255,0.4); border: 1px dashed rgba(42,138,154,0.25);
  border-radius: 1rem; backdrop-filter: blur(8px);
}
.wallet-empty-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
.wallet-empty-text { font-family: 'Playfair Display', serif; font-size: 0.95rem; font-style: italic; color: var(--moonlight); }
.wallet-cards { display: flex; flex-direction: column; gap: 0.8rem; }
.vale-card {
  background: rgba(255,255,255,0.65); border: 1px solid rgba(42,138,154,0.2);
  border-radius: 1rem; padding: 0.9rem 1.1rem;
  backdrop-filter: blur(10px); box-shadow: 0 3px 14px rgba(42,138,154,0.08);
  display: flex; align-items: center; gap: 0.9rem;
  transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden;
}
.vale-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(42,138,154,0.15); }
.vale-card.status-caducado  { opacity: 0.6; border-color: rgba(180,60,60,0.25); background: rgba(255,235,235,0.55); }
.vale-card.status-caduca-1  { border-color: rgba(200,80,80,0.35); background: rgba(255,245,240,0.75); }
.vale-card.status-caduca-2  { border-color: rgba(210,140,40,0.35); background: rgba(255,250,235,0.75); }
.vale-card.status-caduca-3  { border-color: rgba(200,170,40,0.3);  background: rgba(255,253,230,0.75); }
.vale-card.status-en-fecha  { border-color: rgba(42,138,100,0.25); }
.vale-card.status-eterna    { }

.vale-card-badge {
  font-size: 0.62rem; font-family: 'Special Elite', monospace;
  padding: 0.2rem 0.45rem; border-radius: 0.4rem; text-align: center;
  letter-spacing: 0.03em; white-space: nowrap;
}
/* Badge colours per state */
.status-eterna-badge   { background: rgba(42,138,154,0.1);  color: var(--teal); }
.status-en-fecha-badge { background: rgba(42,160,100,0.12); color: #1a7a4a; }
.status-caduca-3-badge { background: rgba(190,160,20,0.15); color: #7a6010; font-weight: 700; }
.status-caduca-2-badge { background: rgba(210,130,20,0.18); color: #8a5010; font-weight: 700; }
.status-caduca-1-badge { background: rgba(200,60,40,0.15);  color: #8a2010; font-weight: 700; animation: pulse 1.2s ease-in-out infinite; }
.status-caducado-badge { background: rgba(180,50,50,0.12);  color: rgba(160,40,40,0.8); text-decoration: line-through; }

/* New vale item expiry tint in popup */
.status-caduca-1-item { border-left: 3px solid rgba(200,60,40,0.5); padding-left: 0.6rem; }
.status-caduca-2-item { border-left: 3px solid rgba(210,130,20,0.5); padding-left: 0.6rem; }
.status-caduca-3-item { border-left: 3px solid rgba(190,160,20,0.5); padding-left: 0.6rem; }
.status-caducado-item { border-left: 3px solid rgba(180,50,50,0.5); padding-left: 0.6rem; opacity: 0.75; }
.vale-card-avatar { flex-shrink: 0; }
.vale-card-body { flex: 1; min-width: 0; }
.vale-card-concept {
  font-family: 'Playfair Display', serif; font-size: 1rem; font-weight: 700; font-style: italic;
  color: var(--cream); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.vale-card-from { font-size: 0.72rem; font-family: 'Playfair Display', serif; font-style: italic; color: var(--moonlight); margin-top: 2px; }
.vale-card-meta { font-family: 'Special Elite', monospace; font-size: 0.52rem; letter-spacing: 0.1em; color: var(--moonlight); margin-top: 3px; }
.vale-card-status { flex-shrink: 0; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; }

/* ===== DELETE CONFIRM DIALOG ===== */
.delete-confirm-overlay {
  position: fixed; inset: 0; z-index: 950;
  background: rgba(0,0,0,0.55); backdrop-filter: blur(8px);
  display: flex; align-items: center; justify-content: center;
  padding: 1.5rem; opacity: 0; pointer-events: none;
  transition: opacity 0.35s;
}
.delete-confirm-overlay.visible { opacity: 1; pointer-events: all; }
.delete-confirm-box {
  background: linear-gradient(160deg, #eef8f0, #e8f5f8);
  border: 1.5px solid rgba(42,138,154,0.25);
  border-radius: 1.6rem; padding: 2rem 1.6rem 1.6rem;
  max-width: 340px; width: 100%; text-align: center;
  box-shadow: 0 24px 60px rgba(42,138,154,0.18);
  transform: scale(0.88) translateY(24px);
  transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1);
}
.delete-confirm-overlay.visible .delete-confirm-box { transform: scale(1) translateY(0); }
.delete-confirm-heart { font-size: 3.2rem; margin-bottom: 0.4rem; animation: float 3s ease-in-out infinite; }
.delete-confirm-title {
  font-family: 'Playfair Display', serif; font-style: italic; font-weight: 700;
  font-size: 1.3rem; color: var(--cream); margin-bottom: 0.4rem;
}
.delete-confirm-concept {
  font-family: 'Playfair Display', serif; font-style: italic;
  font-size: 0.95rem; color: var(--moonlight);
  background: rgba(255,255,255,0.6); border-radius: 0.6rem;
  padding: 0.4rem 0.8rem; margin: 0.5rem 0 0.9rem;
  border: 1px solid rgba(42,138,154,0.15);
}
.delete-confirm-ADMV {
  font-family: 'Special Elite', monospace; font-size: 0.72rem;
  letter-spacing: 0.18em; color: var(--teal);
  margin-bottom: 0.3rem; text-transform: uppercase;
}
.delete-confirm-ilysm {
  font-family: 'Playfair Display', serif; font-style: italic;
  font-size: 1rem; color: var(--rose); margin-bottom: 1.4rem;
  opacity: 0.85;
}
.delete-confirm-step {
  font-size: 0.8rem; color: var(--moonlight); margin-bottom: 1rem;
  font-style: italic; opacity: 0.75;
}
.delete-confirm-btns { display: flex; flex-direction: column; gap: 0.65rem; }
.delete-confirm-btn {
  padding: 0.75rem 1rem; border-radius: 0.85rem; border: none;
  font-family: 'Playfair Display', serif; font-size: 0.95rem;
  font-style: italic; cursor: pointer; transition: all 0.2s;
}
.delete-confirm-btn.cancel {
  background: linear-gradient(135deg, #2a8a9a, #1a7a6a);
  color: white; box-shadow: 0 4px 14px rgba(42,138,154,0.3);
}
.delete-confirm-btn.cancel:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(42,138,154,0.4); }
.delete-confirm-btn.confirm-step {
  background: rgba(255,255,255,0.6); color: var(--moonlight);
  border: 1px solid rgba(42,138,154,0.2);
}
.delete-confirm-btn.confirm-step:hover { background: rgba(255,255,255,0.85); }
.delete-confirm-btn.danger {
  background: rgba(180,60,60,0.1); color: #8a2020;
  border: 1px solid rgba(180,60,60,0.25);
}
.delete-confirm-btn.danger:hover { background: rgba(180,60,60,0.18); }

/* ADMV tag inside card */
.ADMV-tag {
  display: inline-block; font-family: 'Special Elite', monospace;
  font-size: 0.55rem; letter-spacing: 0.15em; text-transform: uppercase;
  background: rgba(42,138,154,0.12); color: var(--teal);
  border: 1px solid rgba(42,138,154,0.2); border-radius: 0.3rem;
  padding: 1px 5px; vertical-align: middle; margin-left: 0.3rem;
}

/* ===== CANJE SYSTEM STYLES ===== */
.vale-card-canjear {
  background: linear-gradient(135deg, #2a9a6a, #1a8a5a);
  color: white; border: none; border-radius: 0.5rem;
  padding: 0.35rem 0.6rem; font-family: 'Playfair Display', serif;
  font-size: 0.72rem; font-style: italic; font-weight: 600;
  cursor: pointer; transition: all 0.25s;
  box-shadow: 0 2px 8px rgba(42,154,106,0.3);
  display: flex; align-items: center; gap: 0.3rem;
}
.vale-card-canjear:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 4px 12px rgba(42,154,106,0.4); }
.vale-card-canjear:disabled {
  background: linear-gradient(135deg, #888, #666);
  cursor: not-allowed; opacity: 0.6;
  box-shadow: none;
}
.vale-card-canjear.pendiente {
  background: linear-gradient(135deg, #d4a020, #c09018);
  animation: pulse 2s ease-in-out infinite;
}
.vale-card-canjear.canjeado {
  background: linear-gradient(135deg, #6a6a6a, #5a5a5a);
  text-decoration: line-through; opacity: 0.7;
}
.vale-card-canjear.aceptado {
  background: linear-gradient(135deg, #4a90d9, #3a7ac9);
  font-size: 0.7rem;
}
.canje-status-tag {
  font-family: 'Special Elite', monospace; font-size: 0.5rem;
  letter-spacing: 0.08em; padding: 2px 6px; border-radius: 0.3rem;
  margin-left: 0.3rem; vertical-align: middle;
}
.canje-status-tag.pendiente {
  background: rgba(212,160,32,0.2); color: #8a6010;
  border: 1px solid rgba(212,160,32,0.3);
}
.canje-status-tag.canjeado {
  background: rgba(42,154,106,0.15); color: #1a6a4a;
  border: 1px solid rgba(42,154,106,0.25);
}
.canje-status-tag.aceptado {
  background: rgba(100,149,237,0.15); color: #2a5a9a;
  border: 1px solid rgba(100,149,237,0.25);
}

/* Canje Request Overlay (for emisor) */
.canje-request-overlay {
  position: fixed; inset: 0; z-index: 960;
  background: rgba(0,0,0,0.55); backdrop-filter: blur(8px);
  display: flex; align-items: center; justify-content: center;
  padding: 1.5rem; opacity: 0; pointer-events: none;
  transition: opacity 0.4s;
}
.canje-request-overlay.visible { opacity: 1; pointer-events: all; }
.canje-request-box {
  background: linear-gradient(160deg, #f0f8e8, #e8f5f0);
  border: 2px solid rgba(42,154,106,0.3);
  border-radius: 1.6rem; padding: 2rem 1.6rem 1.6rem;
  max-width: 360px; width: 100%; text-align: center;
  box-shadow: 0 24px 60px rgba(42,154,106,0.2);
  transform: scale(0.88) translateY(24px);
  transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1);
}
.canje-request-overlay.visible .canje-request-box { transform: scale(1) translateY(0); }
.canje-request-icon { font-size: 3.5rem; margin-bottom: 0.5rem; animation: float 3s ease-in-out infinite; }
.canje-request-title {
  font-family: 'Playfair Display', serif; font-style: italic; font-weight: 700;
  font-size: 1.35rem; color: var(--cream); margin-bottom: 0.3rem;
}
.canje-request-from {
  font-family: 'Playfair Display', serif; font-style: italic;
  font-size: 0.95rem; color: var(--moonlight); margin-bottom: 0.8rem;
}
.canje-request-concept {
  font-family: 'Playfair Display', serif; font-style: italic;
  font-size: 1.1rem; color: var(--cream); font-weight: 700;
  background: rgba(255,255,255,0.7); border-radius: 0.8rem;
  padding: 0.7rem 1rem; margin: 0.5rem 0 1rem;
  border: 1px solid rgba(42,154,106,0.2);
  box-shadow: 0 2px 10px rgba(42,154,106,0.1);
}
.canje-request-date {
  font-family: 'Special Elite', monospace; font-size: 0.7rem;
  letter-spacing: 0.1em; color: var(--moonlight);
  margin-bottom: 1.2rem;
}
.canje-request-btns { display: flex; flex-direction: column; gap: 0.7rem; }
.canje-request-btn {
  padding: 0.8rem 1rem; border-radius: 0.9rem; border: none;
  font-family: 'Playfair Display', serif; font-size: 1rem;
  font-style: italic; cursor: pointer; transition: all 0.25s;
}
.canje-request-btn.accept {
  background: linear-gradient(135deg, #2a9a6a, #1a8a5a);
  color: white; box-shadow: 0 4px 16px rgba(42,154,106,0.35);
}
.canje-request-btn.accept:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(42,154,106,0.45); }
.canje-request-btn.decline {
  background: rgba(255,255,255,0.6); color: var(--moonlight);
  border: 1px solid rgba(42,138,154,0.2);
}
.canje-request-btn.decline:hover { background: rgba(255,255,255,0.85); }

/* Canje Success Overlay (for receptor) */
.canje-success-overlay {
  position: fixed; inset: 0; z-index: 970;
  background: rgba(0,0,0,0.5); backdrop-filter: blur(10px);
  display: flex; align-items: center; justify-content: center;
  padding: 1.5rem; opacity: 0; pointer-events: none;
  transition: opacity 0.4s;
}
.canje-success-overlay.visible { opacity: 1; pointer-events: all; }
.canje-success-box {
  background: linear-gradient(160deg, #e8f8e0, #d8f5e8, #e0f8f0);
  border: 2px solid rgba(42,180,106,0.35);
  border-radius: 1.8rem; padding: 2.2rem 1.8rem 1.8rem;
  max-width: 380px; width: 100%; text-align: center;
  box-shadow: 0 24px 70px rgba(42,180,106,0.25);
  transform: scale(0.85) translateY(30px);
  transition: transform 0.5s cubic-bezier(0.34,1.56,0.64,1);
}
.canje-success-overlay.visible .canje-success-box { transform: scale(1) translateY(0); }
.canje-success-confetti { font-size: 3rem; margin-bottom: 0.3rem; }
.canje-success-icon { font-size: 4rem; margin-bottom: 0.5rem; animation: bounce 1s ease-in-out infinite; }
.canje-success-title {
  font-family: 'Playfair Display', serif; font-style: italic; font-weight: 700;
  font-size: 1.5rem;
  background: linear-gradient(135deg, #1a8a5a, #2a9a7a, #1a7a6a);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  margin-bottom: 0.4rem;
}
.canje-success-sub {
  font-family: 'Playfair Display', serif; font-style: italic;
  font-size: 1rem; color: var(--moonlight); margin-bottom: 1rem;
}
.canje-success-concept {
  font-family: 'Playfair Display', serif; font-style: italic;
  font-size: 1.15rem; color: var(--cream); font-weight: 700;
  background: rgba(255,255,255,0.75); border-radius: 1rem;
  padding: 0.9rem 1.2rem; margin: 0.5rem 0 0.8rem;
  border: 1.5px solid rgba(42,180,106,0.25);
  box-shadow: 0 4px 16px rgba(42,180,106,0.15);
}
.canje-success-date {
  font-family: 'Special Elite', monospace; font-size: 0.75rem;
  letter-spacing: 0.12em; color: var(--teal);
  background: rgba(42,180,106,0.1); border-radius: 0.5rem;
  padding: 0.4rem 0.8rem; margin-bottom: 1.3rem;
}
.canje-success-msg {
  font-family: 'Playfair Display', serif; font-style: italic;
  font-size: 0.95rem; color: var(--moonlight);
  line-height: 1.5; margin-bottom: 1.4rem;
}
.canje-success-btn {
  background: linear-gradient(135deg, #2a9a6a, #1a8a5a);
  color: white; border: none; border-radius: 1rem;
  padding: 0.9rem 1.5rem; font-family: 'Playfair Display', serif;
  font-size: 1.05rem; font-style: italic; cursor: pointer;
  box-shadow: 0 4px 18px rgba(42,154,106,0.35);
  transition: all 0.25s;
}
.canje-success-btn:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 24px rgba(42,154,106,0.45); }

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

/* ===== IMPORT VALE OVERLAY ===== */
.import-vale-overlay {
  position: fixed; inset: 0; z-index: 980;
  background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
  display: flex; align-items: center; justify-content: center;
  padding: 1.5rem; opacity: 0; pointer-events: none;
  transition: opacity 0.4s;
}
.import-vale-overlay.visible { opacity: 1; pointer-events: all; }
.import-vale-popup {
  background: linear-gradient(160deg, #e8f8f0, #d8f5f8);
  border: 2px solid rgba(42,138,154,0.3);
  border-radius: 1.5rem; padding: 1.8rem 1.5rem;
  max-width: 360px; width: 100%;
  box-shadow: 0 24px 70px rgba(42,138,154,0.25);
  transform: scale(0.9) translateY(20px);
  transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1);
  text-align: center;
}
.import-vale-overlay.visible .import-vale-popup { transform: scale(1) translateY(0); }
.import-vale-icon { font-size: 3.5rem; margin-bottom: 0.6rem; animation: float 3s ease-in-out infinite; }
.import-vale-title {
  font-family: 'Playfair Display', serif; font-size: 1.4rem; font-style: italic;
  color: var(--cream); font-weight: 700; margin-bottom: 0.3rem;
}
.import-vale-from {
  font-size: 0.85rem; color: var(--moonlight); margin-bottom: 0.8rem;
  font-style: italic;
}
.import-vale-concept {
  background: rgba(255,255,255,0.7); border: 1px solid rgba(42,138,154,0.2);
  border-radius: 0.75rem; padding: 0.8rem 1rem;
  font-family: 'Playfair Display', serif; font-style: italic;
  font-size: 1.1rem; font-weight: 600; color: var(--cream);
  margin-bottom: 0.6rem;
}
.import-vale-meta {
  font-family: 'Special Elite', monospace; font-size: 0.65rem;
  letter-spacing: 0.1em; color: var(--moonlight); margin-bottom: 1.2rem;
}
.import-vale-btns { display: flex; flex-direction: column; gap: 0.7rem; }
.import-vale-btn {
  width: 100%; padding: 0.85rem;
  border-radius: 0.75rem; border: none;
  font-family: 'Playfair Display', serif; font-size: 1rem;
  font-style: italic; cursor: pointer; transition: all 0.2s;
}
.import-vale-btn.accept {
  background: linear-gradient(135deg, #2a8a9a, #1a7a6a);
  color: white; box-shadow: 0 4px 16px rgba(42,138,154,0.35);
}
.import-vale-btn.accept:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(42,138,154,0.45); }
.import-vale-btn.decline {
  background: rgba(255,255,255,0.6); color: var(--moonlight);
  border: 1px solid rgba(42,138,154,0.2);
}
.import-vale-btn.decline:hover { background: rgba(255,255,255,0.85); }

/* Locked delete button */
.vale-card-delete--locked {
  cursor: not-allowed !important; opacity: 0.15 !important; filter: grayscale(1);
}
.vale-card-delete--locked:hover { opacity: 0.2 !important; transform: none !important; }
.vale-card-delete { background: none; border: none; font-size: 0.9rem; cursor: pointer; opacity: 0.3; transition: opacity 0.2s; padding: 2px; }
.vale-card-delete:hover { opacity: 0.8; }
.vale-card-action { background: none; border: none; font-size: 0.9rem; cursor: pointer; opacity: 0.5; transition: opacity 0.2s, transform 0.15s; padding: 2px; }
.vale-card-action:hover { opacity: 1; transform: scale(1.2); }

.wallet-save-btn {
  width: 100%; margin-top: 0.8rem; padding: 0.75rem;
  border: 1px dashed rgba(42,138,154,0.4); border-radius: 0.75rem;
  background: rgba(255,255,255,0.4); color: var(--cream);
  font-family: 'Playfair Display', serif; font-size: 0.95rem; font-style: italic;
  cursor: pointer; transition: all 0.3s; display: none;
}
.wallet-save-btn.visible { display: block; }
.wallet-save-btn:hover { background: rgba(42,138,154,0.1); border-color: var(--teal); }

footer { margin-top: 2.5rem; text-align: center; font-size: 0.7rem; opacity: 0.25; letter-spacing: 0.15em; }
</style>
</head>
<body>
<div class="stars" id="stars"></div>
<div class="floaters" id="floaters"></div>

<div class="container">
  <!-- ONBOARDING OVERLAY -->
  <div class="onboarding-overlay hidden" id="onboardingOverlay">
    <div class="onboarding-icon">üíå</div>
    <div class="onboarding-title">Vales de Amor</div>
    <div class="onboarding-sub">para Florecilla &amp; Chiquit√≠n</div>
    <div class="onboarding-question">¬øQui√©n eres t√∫?</div>
    <div class="onboarding-btns">
      <button class="onboarding-btn" onclick="setIdentity('Florecilla')">
        <div class="onboarding-btn-avatar" id="onboardAvatarFlor"></div>
        <div>
          <div class="onboarding-btn-name">üå∏ Florecilla</div>
          <div class="onboarding-btn-sub">Recibir√°s los vales de Chiquit√≠n</div>
        </div>
      </button>
      <button class="onboarding-btn" onclick="setIdentity('Chiquit√≠n')">
        <div class="onboarding-btn-avatar" id="onboardAvatarChiq"></div>
        <div>
          <div class="onboarding-btn-name">üêæ Chiquit√≠n</div>
          <div class="onboarding-btn-sub">Recibir√°s los vales de Florecilla</div>
        </div>
      </button>
    </div>
  </div>

  <!-- DELETE CONFIRM DIALOG -->
  <div class="delete-confirm-overlay" id="deleteConfirmOverlay">
    <div class="delete-confirm-box">
      <div class="delete-confirm-heart">üíù</div>
      <div class="delete-confirm-title" id="deleteConfirmTitle">¬øSeguro que quieres borrar?</div>
      <div class="delete-confirm-concept" id="deleteConfirmConcept"></div>
      <div class="delete-confirm-ADMV">ADMV ‚Äî Amor De Mi Vida</div>
      <div class="delete-confirm-ilysm" id="deleteConfirmMsg">"I Love You So Much‚Ä¶<br>¬øde verdad quieres borrar esto?"</div>
      <div class="delete-confirm-step" id="deleteConfirmStep"></div>
      <div class="delete-confirm-btns" id="deleteConfirmBtns"></div>
    </div>
  </div>

  <!-- NEW VALE NOTIFICATION POPUP -->
  <div class="new-vale-overlay" id="newValeOverlay">
    <div class="new-vale-popup">
      <div class="new-vale-popup-icon">üíå</div>
      <div class="new-vale-popup-title" id="newValeTitle">¬°Tienes vales nuevos!</div>
      <div class="new-vale-popup-sub" id="newValeSub">Tu pareja te ha enviado:</div>
      <div class="new-vale-list" id="newValeList"></div>
      <button class="new-vale-close" onclick="dismissNewVales()">üíô Ver mi Wallet</button>
    </div>
  </div>

  <!-- IMPORT VALE FROM LINK POPUP -->
  <div class="import-vale-overlay" id="importValeOverlay">
    <div class="import-vale-popup">
      <div class="import-vale-icon">üíù</div>
      <div class="import-vale-title" id="importValeTitle">¬°Te han enviado un Vale!</div>
      <div class="import-vale-from" id="importValeFrom">De Florecilla para ti</div>
      <div class="import-vale-concept" id="importValeConcept">Un abrazo eterno</div>
      <div class="import-vale-meta" id="importValeMeta">N¬∫ ABC-1234 ¬∑ Caduca: nunca ‚ú®</div>
      <div class="import-vale-btns">
        <button class="import-vale-btn accept" onclick="acceptImportedVale()">üíú ¬°Guardar en mi Wallet!</button>
        <button class="import-vale-btn decline" onclick="declineImportedVale()">Ahora no</button>
      </div>
    </div>
  </div>

  <!-- CANJE REQUEST POPUP (for emisor) -->
  <div class="canje-request-overlay" id="canjeRequestOverlay">
    <div class="canje-request-box">
      <div class="canje-request-icon">üéÅ</div>
      <div class="canje-request-title" id="canjeRequestTitle">¬°Quieren canjear un vale!</div>
      <div class="canje-request-from" id="canjeRequestFrom">Florecilla quiere usar:</div>
      <div class="canje-request-concept" id="canjeRequestConcept">Un masaje relajante</div>
      <div class="canje-request-date" id="canjeRequestDate">Solicitado: 28/02/2026</div>
      <div class="canje-request-btns">
        <button class="canje-request-btn accept" onclick="acceptCanje()">‚ú® ¬°Conceder el deseo!</button>
        <button class="canje-request-btn decline" onclick="declineCanje()">Ahora no puedo</button>
      </div>
    </div>
  </div>

  <!-- CANJE SUCCESS POPUP (for receptor) -->
  <div class="canje-success-overlay" id="canjeSuccessOverlay">
    <div class="canje-success-box">
      <div class="canje-success-confetti">üéä‚ú®üéâ</div>
      <div class="canje-success-icon">üíö</div>
      <div class="canje-success-title" id="canjeSuccessTitle">¬°Vale Canjeado!</div>
      <div class="canje-success-sub" id="canjeSuccessSub">Tu deseo ha sido concedido</div>
      <div class="canje-success-concept" id="canjeSuccessConcept">Un masaje relajante</div>
      <div class="canje-success-date" id="canjeSuccessDate">üìÖ Canjeable hoy: 28/02/2026</div>
      <div class="canje-success-msg" id="canjeSuccessMsg">
        üåü <em>¬°Enhorabuena!</em><br>
        Tu pareja ha aceptado tu solicitud.<br>
        Disfruta de este momento especial juntos üíï
      </div>
      <button class="canje-success-btn" onclick="dismissCanjeSuccess()">üíö ¬°Gracias mi amor!</button>
    </div>
  </div>

  <div class="header">
    <span class="moon-icon">üåô</span>
    <h1>Vales de Amor</h1>
    <p class="subtitle">para Florecilla &amp; Chiquit√≠n</p>
  </div>
  <div class="install-banner" id="installBanner" onclick="installApp()">
    <div class="install-icon">üì±</div>
    <div class="install-text">
      <strong>Instalar app</strong>
      <span>A√±adir a pantalla de inicio</span>
    </div>
  </div>

  <!-- Current user chip -->
  <div class="current-user-chip" id="currentUserChip" onclick="showOnboarding(true)" style="display:none;">
    <div class="current-user-chip-dot"></div>
    <span id="currentUserChipLabel">T√∫: Florecilla</span>
    <span style="opacity:0.4;margin-left:0.2rem;font-size:0.7rem;">‚úèÔ∏è</span>
  </div>

  <div class="sender-section">
    <div class="sender-label" id="senderLabel">¬øQui√©n env√≠a el vale?</div>
    <div class="sender-avatars-preview">
      <div class="sender-avatar-wrap">
        <div id="previewAvatarFrom"></div>
        <span id="previewNameFrom" class="sender-avatar-name">Florecilla</span>
      </div>
      <div style="font-size:1.4rem;opacity:0.45;align-self:center;">üíå</div>
      <div class="sender-avatar-wrap">
        <div id="previewAvatarTo"></div>
        <span id="previewNameTo" class="sender-avatar-name">Chiquit√≠n</span>
      </div>
    </div>
    <div class="sender-btns" id="senderBtns">
      <button class="sender-btn active" onclick="setSender('Florecilla', this)">üå∏ Florecilla</button>
      <button class="sender-btn" onclick="setSender('Chiquit√≠n', this)">üêæ Chiquit√≠n</button>
    </div>
  </div>

  <div class="form-card">
    <label class="form-label">‚ú¶ el vale dice...</label>
    <textarea class="concept-input" id="conceptInput" rows="2"
      placeholder="un abrazo eterno, un beso sorpresa, una tarde de pelis juntos..."></textarea>
    <button class="generate-btn" onclick="generateFlyer()">üåô Crear mi Vale de Amor</button>
    <div class="expiry-section">
      <label class="form-label" style="margin-top:1.1rem;">üìÖ Fecha de caducidad</label>
      <select class="expiry-select" id="expirySelect" onchange="toggleCustomDate(this)">
        <option value="nunca">‚ú® No caduca nunca</option>
        <option value="hoy">Hoy mismo</option>
        <option value="1semana">En 1 semana</option>
        <option value="1mes">En 1 mes</option>
        <option value="3meses">En 3 meses</option>
        <option value="6meses">En 6 meses</option>
        <option value="1a√±o">En 1 a√±o</option>
        <option value="custom">üìÜ Elegir fecha...</option>
      </select>
      <input type="date" class="expiry-custom" id="expiryCustom">
    </div>
  </div>

  <div class="suggestions" id="suggestionsSection">
    <div class="suggestions-title" id="suggestionsTitle">‚ú¶ ideas para tu vale</div>
    <div class="tags" id="tags"></div>
  </div>

  <div class="flyer-container" id="flyerContainer">
    <div class="ticket-shadow">
      <div class="ticket">
        <div class="ticket-header">
          <div class="t-logo">
            <div class="t-logo-icon">üåô</div>
            <div class="t-logo-text">Vale de amor</div>
          </div>
          <div class="t-serial">
            <div class="t-serial-label">N¬∫ de serie</div>
            <div class="t-serial-num" id="serialNum">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
          </div>
        </div>
        <div class="ticket-body">
          <div class="ticket-watermark">Vale</div>
          <div class="ticket-stamp">
            <div class="t-stamp-icon">üíú</div>
            <div class="t-stamp-text">con todo<br>mi amor</div>
          </div>
          <hr class="t-hr">
          <div class="ticket-parties">
            <div class="t-party">
              <div class="t-avatar" id="avatarFrom">
                <img src="img/florecilla.jpeg" alt="Florecilla" style="width:52px;height:52px;border-radius:50%;object-fit:cover;object-position:center 5%;border:1.5px solid rgba(42,138,154,0.3);box-shadow:0 2px 6px rgba(42,138,154,0.2);">
              </div>
              <span class="t-party-label">de</span>
              <div class="t-party-name" id="ticketFrom">Florecilla</div>
            </div>
            <div class="t-arrow">üíå</div>
            <div class="t-party">
              <div class="t-avatar" id="avatarTo">
                <img src="img/chiqutin.jpeg" alt="Chiquit√≠n" style="width:52px;height:52px;border-radius:50%;object-fit:cover;object-position:center 10%;border:1.5px solid rgba(42,138,154,0.3);box-shadow:0 2px 6px rgba(42,138,154,0.2);">
              </div>
              <span class="t-party-label">para</span>
              <div class="t-party-name" id="ticketTo">Chiquit√≠n</div>
            </div>
          </div>
          <hr class="t-hr">
          <div class="ticket-vale">
            <div class="t-vale-label">‚ú¶ ¬∑ ¬∑ ¬∑ vale por ¬∑ ¬∑ ¬∑ ‚ú¶</div>
            <div class="t-vale-por">Este vale te da derecho a</div>
            <div class="t-vale-concept" id="ticketConcept">...</div>
          </div>
          <div class="ticket-deco">üå∏ üåô üåπ üêæ üí´ üíô üå∫ üê∂</div>
          <div class="ticket-footer">
            <div class="t-footer-l">Emitido con amor ‚ô•<br><span id="ticketEmitido">--/--/----</span></div>
            <div class="t-footer-r">Caduca: <span id="ticketCaduca">nunca ‚ú®</span><br>Canjeable cuando quieras</div>
          </div>
        </div>
        <div class="zz-mid-wrap">
          <svg viewBox="0 0 400 12" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
            <polygon points="0,0 400,0 400,12 390,6 380,12 370,6 360,12 350,6 340,12 330,6 320,12 310,6 300,12 290,6 280,12 270,6 260,12 250,6 240,12 230,6 220,12 210,6 200,12 190,6 180,12 170,6 160,12 150,6 140,12 130,6 120,12 110,6 100,12 90,6 80,12 70,6 60,12 50,6 40,12 30,6 20,12 10,6 0,12" fill="#f5ead0"/>
          </svg>
        </div>
        <div class="ticket-stub">
          <div class="stub-left">
            <div class="stub-title" id="stubFrom">De Florecilla</div>
            <div class="stub-sub" id="stubConcept">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
          </div>
          <canvas class="barcode" id="barcode" width="60" height="32"></canvas>
          <div class="stub-right">
            <div id="stubSerial">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
            <div id="stubCaduca">No caduca ‚ú®</div>
          </div>
        </div>
      </div>
    </div>

    <button class="wallet-save-btn" id="walletSaveBtn" onclick="saveToWallet()">
      üíæ Guardar vale en la Wallet
    </button>

    <div class="action-btns">
      <button class="action-btn" id="shareBtn" onclick="shareAsImage()">üì∏ Guardar imagen</button>
    </div>
    <div class="action-btns" style="margin-top:0.6rem;">
      <button class="action-btn whatsapp-btn" id="waBtn" onclick="shareWhatsapp()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
        Enviar por WhatsApp
      </button>
    </div>
  </div>

  <!-- WALLET -->
  <div class="wallet-section">
    <div class="wallet-header">
      <div class="wallet-title" id="walletTitleEl">üí≥ Mi Wallet de Amor</div>
    </div>
    <div class="wallet-subtabs" id="walletSubtabs">
      <button class="wallet-subtab active" onclick="switchWalletSubtab('recibidos', this)">üì• Recibidos <span class="subtab-count" id="countRecibidos">0</span></button>
      <button class="wallet-subtab" onclick="switchWalletSubtab('emitidos', this)">üì§ Emitidos <span class="subtab-count" id="countEmitidos">0</span></button>
    </div>
    <div id="walletCards" class="wallet-cards"></div>
  </div>

  <footer id="footerEl">üåô hecho con amor ¬∑ para siempre vuestro üåπ</footer>
</div>

<script>
// ===== STATE =====
let sender = 'Florecilla';
// ===== IDENTITY & ONBOARDING =====
let currentUser = localStorage.getItem('vales-identity') || null;

function setIdentity(name) {
  currentUser = name;
  localStorage.setItem('vales-identity', name);
  // Lock sender to current user
  lockSender();
  // Hide onboarding
  document.getElementById('onboardingOverlay').classList.add('hidden');
  // Show user chip
  showUserChip();
  // Check for new vales
  checkNewVales();
  // Refrescar wallet
  renderWallet();
  // Verificar canjes pendientes despu√©s de un peque√±o delay
  setTimeout(() => {
    checkPendingCanjes();
    checkAcceptedCanjes();
  }, 500);
}

function showOnboarding(forceShow = false) {
  const overlay = document.getElementById('onboardingOverlay');
  const oFlor = document.getElementById('onboardAvatarFlor');
  const oChiq = document.getElementById('onboardAvatarChiq');
  // Avatares peque√±os para onboarding (44px)
  const smallFlor = `<img src="img/florecilla.jpeg" alt="Florecilla" style="width:44px;height:44px;border-radius:50%;object-fit:cover;object-position:center 5%;border:1.5px solid rgba(42,138,154,0.3);">`;
  const smallChiq = `<img src="img/chiqutin.jpeg" alt="Chiquit√≠n" style="width:44px;height:44px;border-radius:50%;object-fit:cover;object-position:center 10%;border:1.5px solid rgba(42,138,154,0.3);">`;
  if (oFlor) oFlor.innerHTML = smallFlor;
  if (oChiq) oChiq.innerHTML = smallChiq;

  if (!currentUser || forceShow) {
    // Temporarily restore buttons so identity can be re-chosen
    const btns = document.getElementById('senderBtns');
    if (btns) btns.style.display = 'flex';
    const label = document.getElementById('senderLabel');
    if (label) label.textContent = '¬øQui√©n env√≠a el vale?';
    overlay.classList.remove('hidden');
  } else {
    overlay.classList.add('hidden');
    showUserChip();
    checkNewVales();
  }
}

function showUserChip() {
  if (!currentUser) return;
  const chip = document.getElementById('currentUserChip');
  const label = document.getElementById('currentUserChipLabel');
  if (chip) chip.style.display = 'flex';
  if (label) label.textContent = (currentUser === 'Florecilla' ? 'üå∏' : 'üêæ') + ' T√∫: ' + currentUser;
  
  // Actualizar t√≠tulo de wallet
  const walletTitle = document.getElementById('walletTitleEl');
  if (walletTitle) {
    const icon = currentUser === 'Florecilla' ? 'üå∏' : 'üêæ';
    walletTitle.textContent = `${icon} Wallet de ${currentUser}`;
  }
  
  // Actualizar contadores
  updateWalletCounts();
}

// ===== NEW VALE DETECTION =====
// We track which serials the user has "seen" via localStorage
function seenKey(user) { return 'vales-seen:' + user; }

function getSeenSerials(user) {
  try { return JSON.parse(localStorage.getItem(seenKey(user)) || '[]'); } catch(e) { return []; }
}
function markAllSeen(user, data) {
  const serials = data.map(v => v.serial);
  localStorage.setItem(seenKey(user), JSON.stringify(serials));
}

// ===== SOUND & VIBRATION =====
function playNotificationSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    // Sweet two-note chime: C5 then E5
    [[523.25, 0, 0.15], [659.25, 0.18, 0.2]].forEach(([freq, delay, dur]) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime + delay);
      gain.gain.setValueAtTime(0, ctx.currentTime + delay);
      gain.gain.linearRampToValueAtTime(0.18, ctx.currentTime + delay + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + dur);
      osc.start(ctx.currentTime + delay);
      osc.stop(ctx.currentTime + delay + dur);
    });
  } catch(e) {}
}

function vibrateDevice() {
  try {
    if (navigator.vibrate) navigator.vibrate([120, 60, 80]);
  } catch(e) {}
}

async function checkNewVales() {
  if (!currentUser) return;
  const data = await loadWalletData(currentUser);
  const seen = getSeenSerials(currentUser);
  const newVales = data.filter(v => !seen.includes(v.serial));

  // Update tab badge
  updateBadge(currentUser, newVales.length);

  // Update PWA app icon badge
  if (newVales.length > 0 && navigator.setAppBadge) {
    navigator.setAppBadge(newVales.length).catch(() => {});
  } else if (newVales.length === 0 && navigator.clearAppBadge) {
    navigator.clearAppBadge().catch(() => {});
  }

  if (newVales.length > 0) {
    playNotificationSound();
    vibrateDevice();
    showNewValePopup(newVales);
  } else {
    // No new vales ‚Äî check expiry alerts instead
    await checkExpiryAlerts(currentUser);
  }
}

function updateBadge(user, count) {
  const badgeId = user === 'Florecilla' ? 'badgeFlorecilla' : 'badgeChiquitin';
  const badge = document.getElementById(badgeId);
  if (!badge) return;
  if (count > 0) {
    badge.textContent = count;
    badge.style.display = 'inline-flex';
  } else {
    badge.style.display = 'none';
  }
}

function showNewValePopup(newVales) {
  const overlay = document.getElementById('newValeOverlay');
  const title = document.getElementById('newValeTitle');
  const sub = document.getElementById('newValeSub');
  const list = document.getElementById('newValeList');
  if (!overlay) return;

  const partner = currentUser === 'Florecilla' ? 'Chiquit√≠n' : 'Florecilla';
  title.textContent = newVales.length === 1 ? '¬°Tienes un vale nuevo! üíå' : `¬°Tienes ${newVales.length} vales nuevos! üíå`;
  sub.textContent = partner + ' te ha enviado:';
  list.innerHTML = newVales.map(v => `
    <div class="new-vale-item">
      <div>‚ú® ${v.concept}</div>
      <div class="new-vale-item-from">De ${v.from} ¬∑ ${v.emitido}</div>
    </div>`).join('');

  overlay.classList.add('visible');
}

function dismissNewVales() {
  if (!currentUser) return;
  const overlay = document.getElementById('newValeOverlay');
  overlay.classList.remove('visible');

  // Mark all current vales as seen
  loadWalletData(currentUser).then(data => {
    markAllSeen(currentUser, data);
    updateBadge(currentUser, 0);
    if (navigator.clearAppBadge) navigator.clearAppBadge().catch(() => {});
  });

  // Switch wallet to current user's tab
  walletTab = currentUser;
  document.querySelectorAll('.wallet-tab').forEach(b => {
    b.classList.toggle('active', b.textContent.includes(currentUser));
  });
  renderWallet();

  // Scroll to wallet
  setTimeout(() => {
    document.querySelector('.wallet-section')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 300);
}

// Polling: check for new vales every 30s while app is open
// Also play sound+vibrate if new vales appear during polling
let _lastSeenCount = 0;
let pollingInterval = null;
function startPolling() {
  if (pollingInterval) clearInterval(pollingInterval);
  pollingInterval = setInterval(async () => {
    if (!currentUser) return;
    const data = await loadWalletData(currentUser);
    const seen = getSeenSerials(currentUser);
    const newVales = data.filter(v => !seen.includes(v.serial));
    const newCount = newVales.length;
    updateBadge(currentUser, newCount);
    if (newCount > 0 && navigator.setAppBadge) navigator.setAppBadge(newCount).catch(() => {});
    // New vale arrived during session
    if (newCount > _lastSeenCount) {
      playNotificationSound();
      vibrateDevice();
      showNewValePopup(newVales);
    }
    _lastSeenCount = newCount;
    // Always check expiry alerts on each poll
    await checkExpiryAlerts(currentUser);
    // Check for pending canjes and accepted canjes
    await checkPendingCanjes();
    await checkAcceptedCanjes();
    // Update counts
    updateWalletCounts();
  }, 30000);
}


let walletTab = 'Florecilla';
let walletSubtab = 'recibidos'; // 'recibidos' o 'emitidos'
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); deferredPrompt = e;
  // Only show if not already running as installed PWA
  if (!isInstalledPWA()) {
    document.getElementById('installBanner').style.display = 'flex';
  }
});

function isInstalledPWA() {
  return window.matchMedia('(display-mode: standalone)').matches
    || window.matchMedia('(display-mode: fullscreen)').matches
    || window.navigator.standalone === true  // iOS Safari
    || document.referrer.startsWith('android-app://');
}

function installApp() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(() => {
      deferredPrompt = null;
      document.getElementById('installBanner').style.display = 'none';
    });
  }
}

// ===== SENDER =====
function setSender(name, btn) {
  // If identity is fixed, ignore attempts to change sender
  if (currentUser && name !== currentUser) return;
  sender = name;
  document.querySelectorAll('.sender-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTags();
  updateAvatars();
}

function lockSender() {
  if (!currentUser) return;
  // Force sender to currentUser
  sender = currentUser;
  // Activate the correct button
  document.querySelectorAll('.sender-btn').forEach(b => {
    b.classList.toggle('active', b.textContent.includes(currentUser));
  });
  // Hide selector buttons ‚Äî direction is fixed
  const btns = document.getElementById('senderBtns');
  if (btns) btns.style.display = 'none';
  // Update label to show fixed direction
  const label = document.getElementById('senderLabel');
  const icon    = currentUser === 'Florecilla' ? 'üå∏' : 'üêæ';
  const partner = currentUser === 'Florecilla' ? 'Chiquit√≠n' : 'Florecilla';
  const partnerIcon = partner === 'Florecilla' ? 'üå∏' : 'üêæ';
  if (label) label.textContent = `${icon} ${currentUser} ‚Üí ${partnerIcon} ${partner}`;
}

// ===== AVATARS =====
const AVATAR_FLORECILLA = `<img src="img/florecilla.jpeg" alt="Florecilla" style="width:52px;height:52px;border-radius:50%;object-fit:cover;object-position:center 5%;border:1.5px solid rgba(42,138,154,0.3);box-shadow:0 2px 8px rgba(42,138,154,0.2);">`;

const AVATAR_CHIQUTIN = `<img src="img/chiqutin.jpeg" alt="Chiquit√≠n" style="width:52px;height:52px;border-radius:50%;object-fit:cover;object-position:center 10%;border:1.5px solid rgba(42,138,154,0.3);box-shadow:0 2px 8px rgba(42,138,154,0.2);">`;

function updateAvatars() {
  const fromFlor = sender === 'Florecilla';
  const avatarA = fromFlor ? AVATAR_FLORECILLA : AVATAR_CHIQUTIN;
  const avatarB = fromFlor ? AVATAR_CHIQUTIN : AVATAR_FLORECILLA;
  const nameA = fromFlor ? 'Florecilla' : 'Chiquit√≠n';
  const nameB = fromFlor ? 'Chiquit√≠n' : 'Florecilla';

  const elFrom = document.getElementById('avatarFrom');
  const elTo = document.getElementById('avatarTo');
  if (elFrom) elFrom.innerHTML = avatarA;
  if (elTo) elTo.innerHTML = avatarB;

  const pFrom = document.getElementById('previewAvatarFrom');
  const pTo = document.getElementById('previewAvatarTo');
  if (pFrom) pFrom.innerHTML = avatarA;
  if (pTo) pTo.innerHTML = avatarB;

  const nFrom = document.getElementById('previewNameFrom');
  const nTo = document.getElementById('previewNameTo');
  if (nFrom) nFrom.textContent = nameA;
  if (nTo) nTo.textContent = nameB;
}

// ===== TAGS =====
const ideas = {
  Florecilla: ['un abrazo de oso muy largo','elegir la peli esta noche','un beso sorpresa','un masaje en los pies','una tarde de mimos','preparo yo la cena','un d√≠a sin quejas üòá','te dejo el mando'],
  Chiquit√≠n:  ['un paseo rom√°ntico','flores inesperadas','desayuno en la cama','un beso cuando llegues','una sorpresa secreta','bailar contigo esta noche','te escribo una carta','un d√≠a tuyo entero']
};
function renderTags() {
  const currentIdeas = ideas;
  document.getElementById('tags').innerHTML = currentIdeas[sender].map(idea =>
    `<span class="tag" onclick="useSuggestion(this)" data-idea="${idea.replace(/"/g,'&quot;')}">${idea}</span>`
  ).join('');
}
function useSuggestion(el) {
  document.getElementById('conceptInput').value = el.dataset.idea;
  document.getElementById('conceptInput').focus();
}

// ===== EXPIRY =====
function toggleCustomDate(sel) {
  document.getElementById('expiryCustom').style.display = sel.value === 'custom' ? 'block' : 'none';
}
function getExpiryText() {
  const sel = document.getElementById('expirySelect').value;
  const now = new Date();
  const fmt = d => d.toLocaleDateString('es-ES', {day:'2-digit', month:'2-digit', year:'numeric'});
  if (sel === 'nunca') return 'nunca ‚ú®';
  if (sel === 'hoy') return fmt(now);
  if (sel === 'custom') {
    const val = document.getElementById('expiryCustom').value;
    return val ? fmt(new Date(val + 'T12:00:00')) : 'nunca ‚ú®';
  }
  const d = new Date(now);
  if (sel === '1semana') d.setDate(d.getDate() + 7);
  if (sel === '1mes')    d.setMonth(d.getMonth() + 1);
  if (sel === '3meses')  d.setMonth(d.getMonth() + 3);
  if (sel === '6meses')  d.setMonth(d.getMonth() + 6);
  if (sel === '1a√±o')    d.setFullYear(d.getFullYear() + 1);
  return fmt(d);
}

// ===== SERIAL & BARCODE =====
function generateSerial() {
  const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let s = '';
  for (let i = 0; i < 8; i++) { if (i===4) s+='-'; s += c[Math.floor(Math.random()*c.length)]; }
  return s;
}
function generateBarcode() {
  const canvas = document.getElementById('barcode');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#2c1810';
  let x = 0;
  [1,2,1,3,1,2,2,1,3,1,2,1,1,3,2,1,2,1,3,1,2].forEach((w,i) => {
    if (i % 2 === 0) ctx.fillRect(x, 0, w*2, canvas.height);
    x += w*2 + 1.5;
  });
}

// ===== GENERATE FLYER =====
function generateFlyer() {
  const concept = document.getElementById('conceptInput').value.trim();
  if (!concept) {
    document.getElementById('conceptInput').style.borderColor = 'var(--rose)';
    setTimeout(() => document.getElementById('conceptInput').style.borderColor = '', 1500);
    return;
  }
  const receiver = sender === 'Florecilla' ? 'Chiquit√≠n' : 'Florecilla';
  const serial = generateSerial();
  const dateStr = new Date().toLocaleDateString('es-ES', {day:'2-digit',month:'2-digit',year:'numeric'});
  const expiryText = getExpiryText();

  document.getElementById('ticketFrom').textContent = sender;
  document.getElementById('ticketTo').textContent = receiver;
  document.getElementById('ticketConcept').textContent = concept;
  document.getElementById('serialNum').textContent = serial;
  document.getElementById('ticketEmitido').textContent = dateStr;
  document.getElementById('ticketCaduca').textContent = expiryText;
  document.getElementById('stubFrom').textContent = 'De ' + sender;
  document.getElementById('stubConcept').textContent = concept.length > 22 ? concept.slice(0,22)+'‚Ä¶' : concept;
  document.getElementById('stubSerial').textContent = serial;
  document.getElementById('stubCaduca').textContent = expiryText === 'nunca ‚ú®' ? 'No caduca ‚ú®' : 'Caduca: ' + expiryText;

  updateAvatars();
  generateBarcode();

  const container = document.getElementById('flyerContainer');
  container.classList.remove('visible');
  void container.offsetWidth;
  container.classList.add('visible');

  // Show wallet save button
  const saveBtn = document.getElementById('walletSaveBtn');
  if (saveBtn) {
    saveBtn.classList.add('visible');
    saveBtn.textContent = 'üíæ Guardar vale en la Wallet';
  }

  container.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ===== WALLET STORAGE =====
// localStorage = persistente en el dispositivo (siempre disponible)
// window.storage = bonus sync si est√° en Claude.ai artifacts (compartido)

function walletKey(owner) {
  return 'vales-amor:' + owner;
}

async function loadWalletData(owner) {
  const key = walletKey(owner);
  let localData = [];

  // 1. Try window.storage first (Claude.ai artifact env ‚Äî shared between users)
  if (window.storage) {
    try {
      const result = await window.storage.get(key);
      if (result && result.value) {
        localData = JSON.parse(result.value);
        // Mirror to localStorage so it survives if window.storage disappears
        try { localStorage.setItem(key, result.value); } catch(e) {}
      }
    } catch(e) {
      // key not found in window.storage ‚Äî fall through to localStorage
    }
  }

  // 2. localStorage ‚Äî always works, persists across sessions on same device
  if (localData.length === 0) {
    try {
      const raw = localStorage.getItem(key);
      if (raw) localData = JSON.parse(raw);
    } catch(e) {}
  }

  // 3. Si PocketBase est√° disponible, obtener datos frescos y mergear estados de canje
  if (window.PB && window.PB.isConnected()) {
    try {
      const pbData = await window.PB.getVales(owner);
      if (pbData && pbData.length > 0) {
        // Mergear: actualizar estados de canje de PocketBase a datos locales
        pbData.forEach(pbVale => {
          const localVale = localData.find(v => v.serial === pbVale.serial);
          if (localVale) {
            // Actualizar estado de canje desde PocketBase
            localVale.canje_status = pbVale.canje_status;
            localVale.canje_fecha = pbVale.canje_fecha;
            localVale.canje_aceptado = pbVale.canje_aceptado;
          } else {
            // Vale nuevo de PocketBase que no est√° local
            localData.unshift(pbVale);
          }
        });
      }
    } catch(e) {
      console.warn('Error sincronizando con PocketBase:', e);
    }
  }

  return localData;
}

async function saveWalletData(owner, data) {
  const key  = walletKey(owner);
  const json = JSON.stringify(data);

  // Always save to localStorage first ‚Äî guaranteed persistence on this device
  try {
    localStorage.setItem(key, json);
    // Verify it actually saved
    const check = localStorage.getItem(key);
    if (check !== json) console.warn('‚ö†Ô∏è localStorage verify failed for', key);
  } catch(e) {
    console.warn('localStorage.setItem failed:', e);
  }

  // Also save to window.storage if available ‚Äî enables cross-device sync
  if (window.storage) {
    try { await window.storage.set(key, json); } catch(e) {
      console.warn('window.storage.set failed (non-critical):', e);
    }
  }

  // Sincronizar con PocketBase si est√° disponible
  if (window.PB && window.PB.isConnected()) {
    // Guardar cada vale individualmente en PocketBase
    for (const vale of data) {
      await window.PB.save(vale);
    }
  }
}

// Diagnostic + persistence self-test
async function diagStorage() {
  // Test localStorage works
  try {
    const TEST = '__vales_test__';
    localStorage.setItem(TEST, '1');
    const ok = localStorage.getItem(TEST) === '1';
    localStorage.removeItem(TEST);
    if (!ok) {
      console.error('‚ùå localStorage NO funciona ‚Äî los vales no se guardar√°n');
      showStorageError();
      return;
    }
  } catch(e) {
    console.error('‚ùå localStorage bloqueado:', e);
    showStorageError();
    return;
  }

  console.log('‚úÖ localStorage OK ‚Äî vales persistentes en este dispositivo');
  if (window.storage) console.log('‚úÖ window.storage disponible ‚Äî sync entre usuarios activo');
}

function showStorageError() {
  // Show a visible warning banner at the top
  const banner = document.createElement('div');
  banner.style.cssText = `
    position:fixed; top:0; left:0; right:0; z-index:9999;
    background:#c0392b; color:white; text-align:center;
    padding:0.8rem 1rem; font-family:sans-serif; font-size:0.85rem;
    box-shadow:0 2px 8px rgba(0,0,0,0.3);
  `;
  banner.textContent = '‚ö†Ô∏è Tu navegador bloquea el almacenamiento ‚Äî activa las cookies o sal del modo inc√≥gnito para guardar vales.';
  document.body.prepend(banner);
}

async function saveToWallet() {
  const concept = document.getElementById('ticketConcept')?.textContent?.trim();
  const from    = document.getElementById('ticketFrom')?.textContent?.trim();
  const to      = document.getElementById('ticketTo')?.textContent?.trim();
  const serial  = document.getElementById('serialNum')?.textContent?.trim();
  const caduca  = document.getElementById('ticketCaduca')?.textContent?.trim();
  const emitido = document.getElementById('ticketEmitido')?.textContent?.trim();

  const btn = document.getElementById('walletSaveBtn');
  const modeText = 'üíæ Guardar vale en la Wallet';

  // Guard: must have a real generated ticket
  if (!concept || concept === '...' || !to || !serial || serial.startsWith('‚îÄ')) {
    if (btn) { btn.textContent = '‚ö†Ô∏è Primero genera un vale'; setTimeout(() => btn.textContent = modeText, 2000); }
    return;
  }

  const vale = { id: Date.now(), concept, from, to, serial, caduca, emitido };

  // Save ONLY to recipient's wallet (not sender's)
  let savedAny = false;
  const recipientData = await loadWalletData(to);
  if (!recipientData.find(v => v.serial === serial)) {
    recipientData.unshift(vale);
    await saveWalletData(to, recipientData);
    savedAny = true;
  }

  if (btn) {
    if (savedAny) {
      btn.textContent = `‚úÖ Enviado a ${to}`;
    } else {
      btn.textContent = '‚úÖ Ya estaba guardado';
    }
    setTimeout(() => btn.textContent = modeText, 2500);
  }

  // Update badge for recipient (they have unseen vales now)
  const recipientSeen = getSeenSerials(to);
  const recipientNew = recipientData.filter(v => !recipientSeen.includes(v.serial)).length;
  updateBadge(to, recipientNew);

  // Switch wallet tab to recipient so user sees it immediately
  walletTab = to;
  document.querySelectorAll('.wallet-tab').forEach(b => {
    b.classList.toggle('active', b.textContent.includes(to));
  });
  renderWallet();
}

// ===== WALLET DISPLAY =====
function switchWalletTab(name, btn) {
  walletTab = name;
  document.querySelectorAll('.wallet-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderWallet();
}

// ===== VALE STATUS =====
function parseExpiryDate(caduca) {
  if (!caduca || caduca.includes('nunca') || caduca.includes('‚ú®')) return null;
  const clean = caduca.replace('Caduca: ', '').trim();
  const parts = clean.split('/');
  if (parts.length !== 3) return null;
  const d = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
  d.setHours(23, 59, 59, 0); // end of that day
  return isNaN(d.getTime()) ? null : d;
}

function getValeStatus(caduca) {
  const expiry = parseExpiryDate(caduca);
  if (!expiry) return { key: 'eterna',   label: '‚ú® Sin caducidad', css: 'status-eterna' };
  const now   = new Date();
  const days  = Math.ceil((expiry - now) / 86400000);
  if (days < 0)  return { key: 'caducado', label: 'üíÄ Caducado',      css: 'status-caducado' };
  if (days === 0) return { key: 'caduca-1', label: '‚ö†Ô∏è Caduca hoy',    css: 'status-caduca-1' };
  if (days === 1) return { key: 'caduca-1', label: '‚ö†Ô∏è Caduca en 1 d√≠a', css: 'status-caduca-1' };
  if (days === 2) return { key: 'caduca-2', label: 'üî∂ Caduca en 2 d√≠as', css: 'status-caduca-2' };
  if (days === 3) return { key: 'caduca-3', label: 'üîî Caduca en 3 d√≠as', css: 'status-caduca-3' };
  return { key: 'en-fecha', label: `‚úÖ En fecha ¬∑ ${days}d`, css: 'status-en-fecha' };
}

// Keep these for backward compat with previewFromWallet
function isExpired(caduca) { return getValeStatus(caduca).key === 'caducado'; }
function daysLeft(caduca) {
  const expiry = parseExpiryDate(caduca);
  if (!expiry) return null;
  return Math.ceil((expiry - new Date()) / 86400000);
}

// ===== EXPIRY ALERT SYSTEM =====
function expiryAlertKey(user) { return 'vales-expiry-alerted:' + user; }

function getAlertedSerials(user) {
  try { return JSON.parse(localStorage.getItem(expiryAlertKey(user)) || '[]'); } catch(e) { return []; }
}
function setAlertedSerials(user, serials) {
  try { localStorage.setItem(expiryAlertKey(user), JSON.stringify(serials)); } catch(e) {}
}

async function checkExpiryAlerts(user) {
  if (!user) return;
  const data = await loadWalletData(user);
  const alerted = getAlertedSerials(user);
  const toAlert = [];

  data.forEach(vale => {
    const status = getValeStatus(vale.caduca);
    const alertKeys = ['caduca-1', 'caduca-2', 'caduca-3', 'caducado'];
    if (!alertKeys.includes(status.key)) return;
    // Alert once per (serial + status key) combo ‚Äî re-alerts if status changes
    const alertId = vale.serial + ':' + status.key;
    if (!alerted.includes(alertId)) toAlert.push({ vale, status, alertId });
  });

  if (toAlert.length === 0) return;

  // Mark as alerted
  const newAlerted = [...alerted, ...toAlert.map(a => a.alertId)];
  setAlertedSerials(user, newAlerted);

  // Play sound + vibrate
  playNotificationSound();
  vibrateDevice();

  // Show expiry popup
  showExpiryPopup(toAlert);
}

function showExpiryPopup(alerts) {
  const overlay = document.getElementById('newValeOverlay');
  const title   = document.getElementById('newValeTitle');
  const sub     = document.getElementById('newValeSub');
  const list    = document.getElementById('newValeList');
  if (!overlay) return;

  title.textContent = alerts.length === 1 ? '‚è∞ Aviso de caducidad' : `‚è∞ ${alerts.length} vales con aviso`;
  sub.textContent   = 'Revisa el estado de tus vales:';
  list.innerHTML    = alerts.map(({ vale, status }) => `
    <div class="new-vale-item ${status.css}-item">
      <div>${status.label} ¬∑ <em>${vale.concept}</em></div>
      <div class="new-vale-item-from">De ${vale.from} ¬∑ vence ${vale.caduca}</div>
    </div>`).join('');

  overlay.classList.add('visible');
}


// ===== DELETE CONFIRM FLOW =====
let _deleteTarget = null; // { owner, id, vale, step }

async function deleteFromWallet(owner, id) {
  const data = await loadWalletData(owner);
  const vale = data.find(v => v.id === id);
  if (!vale) return;

  const status = getValeStatus(vale.caduca);

  // Vales with a date cannot be deleted until caducado
  if (status.key !== 'eterna' && status.key !== 'caducado') {
    shakeCard(id);
    return;
  }

  // Store target and start confirmation flow
  _deleteTarget = { owner, id, vale, step: 1 };
  showDeleteConfirmStep(1);
}

function showDeleteConfirmStep(step) {
  const overlay  = document.getElementById('deleteConfirmOverlay');
  const titleEl  = document.getElementById('deleteConfirmTitle');
  const conceptEl= document.getElementById('deleteConfirmConcept');
  const msgEl    = document.getElementById('deleteConfirmMsg');
  const stepEl   = document.getElementById('deleteConfirmStep');
  const btnsEl   = document.getElementById('deleteConfirmBtns');
  if (!overlay || !_deleteTarget) return;

  const { vale } = _deleteTarget;
  const isADMV   = getValeStatus(vale.caduca).key === 'eterna';
  const label    = isADMV ? 'ADMV ‚Äî Amor De Mi Vida' : 'üíÄ Vale caducado';
  document.getElementById('deleteConfirmTitle').textContent = step === 1
    ? '¬øSeguro que quieres borrar?' : step === 2
    ? '¬øEst√°s completamente seguro?' : '‚ö†Ô∏è √öltima oportunidad';
  conceptEl.textContent = `"${vale.concept}"`;
  document.querySelector('.delete-confirm-ADMV').textContent = label;

  if (step === 1) {
    msgEl.innerHTML = 'üíù <em>ILYSM ‚Äî I Love You So Much‚Ä¶</em><br>este vale naci√≥ del amor. ¬øDe verdad quieres borrarlo?';
    stepEl.textContent = 'Paso 1 de 3';
    btnsEl.innerHTML = `
      <button class="delete-confirm-btn cancel" onclick="cancelDelete()">üíô No, lo guardo con cari√±o</button>
      <button class="delete-confirm-btn confirm-step" onclick="showDeleteConfirmStep(2)">S√≠, continuar‚Ä¶</button>`;
  } else if (step === 2) {
    msgEl.innerHTML = 'üåπ <em>ADMV ‚Äî Amor De Mi Vida‚Ä¶</em><br>una vez borrado, esta semilla de amor desaparece para siempre.';
    stepEl.textContent = 'Paso 2 de 3';
    btnsEl.innerHTML = `
      <button class="delete-confirm-btn cancel" onclick="cancelDelete()">üíô Mejor no, lo conservo</button>
      <button class="delete-confirm-btn confirm-step" onclick="showDeleteConfirmStep(3)">Entiendo, continuar‚Ä¶</button>`;
  } else {
    msgEl.innerHTML = 'üíî <em>¬øSeguro? No habr√° vuelta atr√°s.</em><br>Pulsa el icono de borrar para confirmar.';
    stepEl.textContent = 'Paso 3 de 3 ‚Äî ahora aparece el bot√≥n';
    btnsEl.innerHTML = `
      <button class="delete-confirm-btn cancel" onclick="cancelDelete()">üíô Me arrepiento, lo guardo</button>
      <button class="delete-confirm-btn danger" onclick="confirmDelete()">üóë Borrar para siempre</button>`;
  }

  overlay.classList.add('visible');
}

function cancelDelete() {
  _deleteTarget = null;
  document.getElementById('deleteConfirmOverlay').classList.remove('visible');
}

async function confirmDelete() {
  if (!_deleteTarget) return;
  const { owner, id } = _deleteTarget;
  document.getElementById('deleteConfirmOverlay').classList.remove('visible');
  
  // Obtener el serial antes de eliminar para sincronizar con PocketBase
  const data = await loadWalletData(owner);
  const valeToDelete = data.find(v => v.id === id);
  const serial = valeToDelete?.serial;
  
  _deleteTarget = null;
  await saveWalletData(owner, data.filter(v => v.id !== id));
  
  // Eliminar tambi√©n de PocketBase
  if (serial && window.PB && window.PB.isConnected()) {
    await window.PB.delete(serial);
  }
  
  renderWallet();
}

function shakeCard(id) {
  // Find card by its delete button and shake it
  const allBtns = document.querySelectorAll('.vale-card-delete--locked');
  allBtns.forEach(btn => {
    if (btn.getAttribute('data-id') == id) {
      const card = btn.closest('.vale-card');
      if (!card) return;
      card.style.transition = 'transform 0.08s';
      card.style.transform  = 'translateX(6px)';
      setTimeout(() => card.style.transform = 'translateX(-5px)', 80);
      setTimeout(() => card.style.transform = 'translateX(4px)',  160);
      setTimeout(() => card.style.transform = 'translateX(-3px)', 240);
      setTimeout(() => { card.style.transform = 'translateX(0)'; card.style.transition = ''; }, 320);
    }
  });
}



async function renderWallet() {
  if (!currentUser) {
    const container = document.getElementById('walletCards');
    container.innerHTML = `<div class="wallet-empty">
      <div class="wallet-empty-icon">üë§</div>
      <div class="wallet-empty-text">Selecciona tu perfil para ver tus vales</div>
    </div>`;
    return;
  }

  // Cargar vales seg√∫n el subtab activo
  let data = [];
  if (walletSubtab === 'recibidos') {
    data = await loadWalletData(currentUser); // Vales donde to === currentUser
  } else {
    data = await loadEmitidosData(currentUser); // Vales donde from === currentUser
  }

  const container = document.getElementById('walletCards');

  // Actualizar contadores
  updateWalletCounts();

  if (!data.length) {
    const emptyMsg = walletSubtab === 'recibidos' 
      ? 'A√∫n no has recibido ning√∫n vale üíå'
      : 'A√∫n no has emitido ning√∫n vale ‚ú®';
    container.innerHTML = `<div class="wallet-empty">
      <div class="wallet-empty-icon">${walletSubtab === 'recibidos' ? 'üì•' : 'üì§'}</div>
      <div class="wallet-empty-text">${emptyMsg}</div>
    </div>`;
    return;
  }

  // Funci√≥n para redimensionar avatares
  const smallAv = av => av.replace(/width[=:]["']?52(px)?["']?/gi, 'width:36px').replace(/height[=:]["']?52(px)?["']?/gi, 'height:36px').replace('width="52"', 'width="36"').replace('height="52"', 'height="36"').replace('width:52px', 'width:36px').replace('height:52px', 'height:36px');

  container.innerHTML = data.map(vale => {
    const status   = getValeStatus(vale.caduca);
    // Avatar seg√∫n si es emitido o recibido
    const avatarUser = walletSubtab === 'recibidos' ? vale.from : vale.to;
    const avatarImg = avatarUser === 'Florecilla' ? AVATAR_FLORECILLA : AVATAR_CHIQUTIN;
    const av = smallAv(avatarImg);
    const idSafe   = vale.id;
    const canDelete= status.key === 'eterna' || status.key === 'caducado';

    const ADMVTag  = status.key === 'eterna'
      ? `<span class="ADMV-tag" title="Amor De Mi Vida ‚Äî sin caducidad">ADMV</span>`
      : '';

    const deleteBtn = canDelete
      ? `<button class="vale-card-delete" onclick="deleteFromWallet('${currentUser}', ${idSafe})" title="Eliminar este vale">üóë</button>`
      : `<button class="vale-card-delete vale-card-delete--locked" data-id="${idSafe}" onclick="deleteFromWallet('${currentUser}', ${idSafe})" title="Solo puedes borrar este vale cuando caduque">üîí</button>`;

    // Bot√≥n de canjear - SOLO en vales recibidos
    const esRecibido = walletSubtab === 'recibidos';
    const canCanjear = status.key !== 'caducado' && esRecibido;
    const canjeStatus = vale.canje_status || null;
    let canjearBtn = '';
    
    // Funci√≥n para verificar si la fecha de canje ya pas√≥
    const fechaCanjePasada = () => {
      if (!vale.canje_aceptado) return false;
      const partes = vale.canje_aceptado.split('/');
      if (partes.length !== 3) return false;
      const fechaCanje = new Date(partes[2], partes[1] - 1, partes[0]);
      const hoy = new Date();
      hoy.setHours(0, 0, 0, 0);
      return fechaCanje < hoy;
    };
    
    if (!esRecibido) {
      // En emitidos: mostrar estado seg√∫n canje
      if (canjeStatus === 'pendiente') {
        canjearBtn = `<span class="canje-status-tag pendiente" style="padding:0.35rem 0.6rem;">‚è≥ Solicitud pendiente</span>`;
      } else if (canjeStatus === 'canjeado') {
        if (fechaCanjePasada()) {
          canjearBtn = `<span class="canje-status-tag canjeado" style="padding:0.35rem 0.6rem;">‚úì Vale canjeado</span>`;
        } else {
          canjearBtn = `<span class="canje-status-tag aceptado" style="padding:0.35rem 0.6rem;">üìÖ Se canjear√° el ${vale.canje_aceptado}</span>`;
        }
      }
    } else if (canjeStatus === 'canjeado') {
      if (fechaCanjePasada()) {
        canjearBtn = `<button class="vale-card-canjear canjeado" disabled title="Ya canjeado">‚úì Vale canjeado</button>`;
      } else {
        canjearBtn = `<button class="vale-card-canjear aceptado" disabled title="Canje aprobado">üìÖ Se canjear√° el ${vale.canje_aceptado}</button>`;
      }
    } else if (canjeStatus === 'pendiente') {
      canjearBtn = `<button class="vale-card-canjear pendiente" disabled title="Esperando respuesta...">‚è≥ Pendiente</button>`;
    } else if (canCanjear) {
      canjearBtn = `<button class="vale-card-canjear" onclick="solicitarCanje('${vale.serial}')" title="Solicitar canjear este vale">üéÅ Canjear</button>`;
    } else if (esRecibido) {
      canjearBtn = `<button class="vale-card-canjear" disabled title="Vale caducado">‚ùå Caducado</button>`;
    }

    // Tag de estado de canje
    const canjeTag = canjeStatus === 'pendiente' 
      ? `<span class="canje-status-tag pendiente">‚è≥ PENDIENTE</span>`
      : canjeStatus === 'canjeado'
        ? (fechaCanjePasada() 
            ? `<span class="canje-status-tag canjeado">‚úì CANJEADO</span>`
            : `<span class="canje-status-tag aceptado">üìÖ ${vale.canje_aceptado}</span>`)
        : '';

    // Texto de "De" o "Para" seg√∫n el subtab
    const fromToText = walletSubtab === 'recibidos' 
      ? `De ${vale.from}` 
      : `Para ${vale.to}`;

    return `<div class="vale-card ${status.css}" data-serial="${vale.serial}">
      <div class="vale-card-avatar">${av}</div>
      <div class="vale-card-body">
        <div class="vale-card-concept">${vale.concept}${ADMVTag}${canjeTag}</div>
        <div class="vale-card-from">${fromToText} ¬∑ ${vale.emitido}</div>
        <div class="vale-card-meta">N¬∫ ${vale.serial}</div>
      </div>
      <div class="vale-card-status">
        <div class="vale-card-badge ${status.css}-badge">${status.label}</div>
        <div style="display:flex;flex-direction:column;gap:0.3rem;margin-top:0.2rem;">
          ${canjearBtn}
          <div style="display:flex;gap:0.3rem;">
            <button class="vale-card-action" onclick="previewFromWallet(${idSafe})" title="Ver y compartir">üëÅ</button>
            ${deleteBtn}
          </div>
        </div>
      </div>
    </div>`;
  }).join('');
}

// Funci√≥n para cargar vales emitidos por el usuario
async function loadEmitidosData(user) {
  // Primero intentar de PocketBase
  if (window.PB && window.PB.isConnected()) {
    try {
      const result = await window.PB.getEmitidos(user);
      if (result && result.length > 0) return result;
    } catch(e) { console.warn('PB emitidos error:', e); }
  }
  
  // Fallback: buscar en localStorage del otro usuario
  const partner = user === 'Florecilla' ? 'Chiquit√≠n' : 'Florecilla';
  const partnerData = await loadWalletData(partner);
  // Filtrar los que yo emit√≠ (from === user)
  return partnerData.filter(v => v.from === user);
}

// Funci√≥n para cambiar subtab
function switchWalletSubtab(subtab, btn) {
  walletSubtab = subtab;
  document.querySelectorAll('.wallet-subtab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderWallet();
}

// Actualizar contadores de vales
async function updateWalletCounts() {
  if (!currentUser) return;
  
  const recibidos = await loadWalletData(currentUser);
  const emitidos = await loadEmitidosData(currentUser);
  
  document.getElementById('countRecibidos').textContent = recibidos.length;
  document.getElementById('countEmitidos').textContent = emitidos.length;
}

async function previewFromWallet(id) {
  // Find the vale across both wallets
  let vale = null;
  for (const owner of ['Florecilla', 'Chiquit√≠n']) {
    const data = await loadWalletData(owner);
    const found = data.find(v => v.id === id);
    if (found) { vale = found; break; }
  }
  if (!vale) return;

  // Populate ticket fields
  document.getElementById('ticketFrom').textContent    = vale.from;
  document.getElementById('ticketTo').textContent      = vale.to;
  document.getElementById('ticketConcept').textContent = vale.concept;
  document.getElementById('serialNum').textContent     = vale.serial;
  document.getElementById('ticketEmitido').textContent = vale.emitido;
  document.getElementById('ticketCaduca').textContent  = vale.caduca;
  document.getElementById('stubFrom').textContent      = 'De ' + vale.from;
  document.getElementById('stubSerial').textContent    = vale.serial;
  document.getElementById('stubCaduca').textContent    = vale.caduca.includes('nunca') ? 'No caduca ‚ú®' : 'Caduca: ' + vale.caduca;
  const conceptShort = vale.concept.length > 22 ? vale.concept.slice(0, 22) + '‚Ä¶' : vale.concept;
  document.getElementById('stubConcept').textContent   = conceptShort;

  // Update avatars in ticket
  const isFlor = vale.from === 'Florecilla';
  document.getElementById('avatarFrom').innerHTML = isFlor ? AVATAR_FLORECILLA : AVATAR_CHIQUTIN;
  document.getElementById('avatarTo').innerHTML   = isFlor ? AVATAR_CHIQUTIN : AVATAR_FLORECILLA;

  generateBarcode();

  // Show ticket and scroll to it
  const container = document.getElementById('flyerContainer');
  container.classList.remove('visible');
  void container.offsetWidth;
  container.classList.add('visible');
  container.scrollIntoView({ behavior: 'smooth', block: 'start' });

  // Show share buttons
  showWalletSaveBtn();

  // Visual feedback on card
  document.querySelectorAll('.vale-card-action').forEach(b => b.textContent = 'üëÅ');
  event.target.textContent = '‚úÖ';
  setTimeout(() => { event.target.textContent = 'üëÅ'; }, 1500);
}

// ===== VALE ENCODING/DECODING FOR DEEP LINKS =====
function encodeValeForURL(vale) {
  // Create a compact object with shortened keys
  const compact = {
    c: vale.concept,
    f: vale.from,
    t: vale.to,
    s: vale.serial,
    x: vale.caduca,
    e: vale.emitido,
    i: vale.id
  };
  // Encode to base64 (URL-safe)
  const json = JSON.stringify(compact);
  const base64 = btoa(unescape(encodeURIComponent(json)));
  // Make URL-safe: replace + with -, / with _, remove =
  return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

function decodeValeFromURL(encoded) {
  try {
    // Restore standard base64
    let base64 = encoded.replace(/-/g, '+').replace(/_/g, '/');
    // Add padding if needed
    while (base64.length % 4) base64 += '=';
    // Decode
    const json = decodeURIComponent(escape(atob(base64)));
    const compact = JSON.parse(json);
    // Expand to full vale object
    return {
      id: compact.i || Date.now(),
      concept: compact.c,
      from: compact.f,
      to: compact.t,
      serial: compact.s,
      caduca: compact.x,
      emitido: compact.e
    };
  } catch (e) {
    console.error('Error decoding vale:', e);
    return null;
  }
}

function getAppBaseURL() {
  // Get the base URL of the app (works for GitHub Pages, localhost, etc.)
  const url = new URL(window.location.href);
  url.search = ''; // Remove query params
  url.hash = '';   // Remove hash
  return url.toString();
}

function generateValeLink(vale) {
  const encoded = encodeValeForURL(vale);
  return getAppBaseURL() + '?vale=' + encoded;
}

// ===== IMPORT VALE FROM URL =====
let _pendingImportVale = null;

function checkURLForVale() {
  const params = new URLSearchParams(window.location.search);
  const valeParam = params.get('vale');
  
  if (!valeParam) return;
  
  const vale = decodeValeFromURL(valeParam);
  if (!vale) {
    console.warn('Invalid vale in URL');
    return;
  }
  
  // Clean URL without reloading (remove the vale param)
  const cleanURL = getAppBaseURL();
  window.history.replaceState({}, document.title, cleanURL);
  
  // Store and show import popup
  _pendingImportVale = vale;
  showImportPopup(vale);
}

function showImportPopup(vale) {
  const overlay = document.getElementById('importValeOverlay');
  if (!overlay) return;
  
  document.getElementById('importValeTitle').textContent = '¬°Te han enviado un Vale! üíå';
  document.getElementById('importValeFrom').textContent = `De ${vale.from} para ${vale.to}`;
  document.getElementById('importValeConcept').textContent = vale.concept;
  document.getElementById('importValeMeta').textContent = `N¬∫ ${vale.serial} ¬∑ Caduca: ${vale.caduca}`;
  
  // Play notification
  playNotificationSound();
  vibrateDevice();
  
  overlay.classList.add('visible');
}

async function acceptImportedVale() {
  if (!_pendingImportVale) return;
  
  const vale = _pendingImportVale;
  const overlay = document.getElementById('importValeOverlay');
  
  // Save ONLY to the recipient's wallet (not sender's)
  const recipientData = await loadWalletData(vale.to);
  if (!recipientData.find(v => v.serial === vale.serial)) {
    recipientData.unshift(vale);
    await saveWalletData(vale.to, recipientData);
  }
  
  // Mark as seen for recipient
  const seenSerials = getSeenSerials(vale.to);
  if (!seenSerials.includes(vale.serial)) {
    seenSerials.push(vale.serial);
    localStorage.setItem(seenKey(vale.to), JSON.stringify(seenSerials));
  }
  
  overlay.classList.remove('visible');
  _pendingImportVale = null;
  
  // Switch to recipient's wallet tab and refresh
  walletTab = vale.to;
  document.querySelectorAll('.wallet-tab').forEach(b => {
    b.classList.toggle('active', b.textContent.includes(vale.to));
  });
  renderWallet();
  
  // Scroll to wallet
  setTimeout(() => {
    document.querySelector('.wallet-section')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 300);
}

function declineImportedVale() {
  _pendingImportVale = null;
  document.getElementById('importValeOverlay').classList.remove('visible');
}

// ===== SHARE / EXPORT =====
async function captureTicket() {
  const script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
  document.head.appendChild(script);
  await new Promise(r => script.onload = r);
  const ticket = document.querySelector('.ticket-shadow');
  return html2canvas(ticket, { scale: 3, backgroundColor: null, useCORS: true });
}
async function shareAsImage() {
  const btn = document.getElementById('shareBtn');
  btn.textContent = '‚è≥ Generando...'; btn.disabled = true;
  try {
    const canvas = await captureTicket();
    canvas.toBlob(async blob => {
      const file = new File([blob], 'vale-de-amor.png', {type:'image/png'});
      if (navigator.canShare && navigator.canShare({files:[file]})) {
        await navigator.share({files:[file], title:'Vale de Amor üåô'});
      } else {
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = 'vale-de-amor.png'; a.click();
      }
    }, 'image/png');
  } catch(e) { console.error(e); }
  btn.textContent = 'üì∏ Guardar imagen'; btn.disabled = false;
}
async function shareWhatsapp() {
  const waBtn = document.getElementById('waBtn');
  waBtn.innerHTML = '‚è≥ Generando...'; waBtn.disabled = true;
  
  // Get current vale data to create the deep link
  const vale = {
    id: Date.now(),
    concept: document.getElementById('ticketConcept')?.textContent?.trim(),
    from: document.getElementById('ticketFrom')?.textContent?.trim(),
    to: document.getElementById('ticketTo')?.textContent?.trim(),
    serial: document.getElementById('serialNum')?.textContent?.trim(),
    caduca: document.getElementById('ticketCaduca')?.textContent?.trim(),
    emitido: document.getElementById('ticketEmitido')?.textContent?.trim()
  };
  
  // Generate the deep link
  const valeLink = generateValeLink(vale);
  const shareMessage = `üíú ¬°Te env√≠o un Vale de Amor! üåô

‚ú® "${vale.concept}"

üëÜ Abre este enlace para guardarlo en tu Wallet:
${valeLink}`;
  
  // Always copy link to clipboard first
  try {
    await navigator.clipboard.writeText(shareMessage);
    console.log('‚úÖ Mensaje copiado al portapapeles');
  } catch(e) {
    console.warn('No se pudo copiar al portapapeles:', e);
  }
  
  // Open WhatsApp directly with the message (most reliable method)
  const waURL = 'https://wa.me/?text=' + encodeURIComponent(shareMessage);
  window.open(waURL, '_blank');
  
  // Show success with instructions
  const waIcon = `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>`;
  waBtn.innerHTML = `${waIcon} ‚úÖ ¬°Enlace copiado!`;
  setTimeout(() => { 
    waBtn.innerHTML = `${waIcon} Enviar por WhatsApp`; 
    waBtn.disabled = false; 
  }, 3000);
}

// ===== PARTICLES =====
function createStars() {
  const c = document.getElementById('stars');
  const colors = ['rgba(42,138,154,0.45)','rgba(26,122,102,0.4)','rgba(80,180,200,0.4)','rgba(42,160,130,0.35)','rgba(100,200,220,0.3)'];
  for (let i = 0; i < 55; i++) {
    const s = document.createElement('div'); s.className = 'star';
    const sz = Math.random()*3+1;
    s.style.cssText = `width:${sz}px;height:${sz}px;top:${Math.random()*100}%;left:${Math.random()*100}%;background:${colors[Math.floor(Math.random()*colors.length)]};--d:${2+Math.random()*4}s;animation-delay:${Math.random()*4}s`;
    c.appendChild(s);
  }
}
function createFloaters() {
  const emojis = ['üå∏','üåô','üíú','üåπ','üêæ','üí´','‚ù§Ô∏è','üå∫','‚≠ê','üê∂'];
  const c = document.getElementById('floaters');
  for (let i = 0; i < 10; i++) {
    const el = document.createElement('div'); el.className = 'floater';
    el.textContent = emojis[i % emojis.length];
    el.style.cssText = `top:${Math.random()*100}%;left:${Math.random()*100}%;--d:${3+Math.random()*5}s;animation-delay:${Math.random()*3}s;font-size:${1+Math.random()*2}rem`;
    c.appendChild(el);
  }
}

// ===== CANJE SYSTEM =====
let _pendingCanje = null; // { serial, vale }

// Funci√≥n de debug para probar el flujo manualmente
window.testCanje = {
  // Ver estado completo de ambos usuarios
  status: () => {
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üë§ USUARIO ACTUAL:', currentUser);
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    // Leer ambos localStorage directamente
    ['Florecilla', 'Chiquit√≠n'].forEach(user => {
      const key = 'vales-amor:' + user;
      const raw = localStorage.getItem(key);
      if (raw) {
        const data = JSON.parse(raw);
        console.log(`\nüì¶ WALLET de ${user}: (${data.length} vales)`);
        data.forEach((v, i) => {
          console.log(`  ${i+1}. "${v.concept}"`);
          console.log(`     from: ${v.from} ‚Üí to: ${v.to}`);
          console.log(`     serial: ${v.serial}`);
          console.log(`     canje_status: ${v.canje_status || '(null)'}`);
          console.log(`     canje_fecha: ${v.canje_fecha || '(null)'}`);
        });
      } else {
        console.log(`\nüì¶ WALLET de ${user}: (vac√≠a)`);
      }
    });
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  },
  
  // Forzar verificaci√≥n de canjes
  check: async () => {
    console.log('üîç Forzando verificaci√≥n de canjes...');
    await checkPendingCanjes();
    await checkAcceptedCanjes();
    console.log('‚úÖ Verificaci√≥n completada');
  },
  
  // Simular solicitud de canje
  request: (serial) => {
    console.log('üì§ Solicitando canje para:', serial);
    solicitarCanje(serial);
  },
  
  // Simular popup directamente
  showPopup: (serial) => {
    const partner = currentUser === 'Florecilla' ? 'Chiquit√≠n' : 'Florecilla';
    const key = 'vales-amor:' + partner;
    const raw = localStorage.getItem(key);
    if (raw) {
      const data = JSON.parse(raw);
      const vale = data.find(v => v.serial === serial);
      if (vale) {
        console.log('üéÅ Mostrando popup para:', vale.concept);
        showCanjeRequest(vale);
      } else {
        console.error('‚ùå Vale no encontrado');
      }
    }
  },
  
  // Ver pendientes del usuario actual (como emisor)
  pending: () => {
    const partner = currentUser === 'Florecilla' ? 'Chiquit√≠n' : 'Florecilla';
    const key = 'vales-amor:' + partner;
    const raw = localStorage.getItem(key);
    if (raw) {
      const data = JSON.parse(raw);
      const pending = data.filter(v => v.from === currentUser && v.canje_status === 'pendiente');
      console.log(`üì¨ Canjes pendientes que ${currentUser} debe aprobar:`, pending.length);
      pending.forEach(v => console.log(`  - "${v.concept}" solicitado por ${v.to}`));
      return pending;
    }
    return [];
  }
};

/**
 * Solicitar canje de un vale (receptor solicita al emisor)
 */
async function solicitarCanje(serial) {
  if (!currentUser) {
    console.error('‚ùå No hay usuario actual');
    return;
  }
  
  console.log('üéÅ Solicitando canje para serial:', serial);
  
  // Buscar el vale en los recibidos del usuario actual
  const data = await loadWalletData(currentUser);
  const vale = data.find(v => v.serial === serial);
  if (!vale) {
    console.error('‚ùå Vale no encontrado:', serial);
    return;
  }

  console.log('üìù Vale encontrado:', vale.concept);

  // Verificar que no est√© caducado
  const status = getValeStatus(vale.caduca);
  if (status.key === 'caducado') {
    alert('Este vale ha caducado y no se puede canjear.');
    return;
  }

  // Verificar que no est√© ya en proceso
  if (vale.canje_status === 'pendiente' || vale.canje_status === 'canjeado') {
    console.log('‚ö†Ô∏è Vale ya tiene estado:', vale.canje_status);
    return;
  }

  // Actualizar estado a pendiente
  vale.canje_status = 'pendiente';
  vale.canje_fecha = new Date().toLocaleDateString('es-ES');
  
  console.log('üíæ Guardando estado pendiente en localStorage...');
  await saveWalletData(currentUser, data);

  // Guardar en PocketBase si est√° disponible
  if (window.PB && window.PB.isConnected()) {
    console.log('‚òÅÔ∏è Actualizando en PocketBase...');
    const result = await window.PB.updateCanjeStatus(serial, 'pendiente', vale.canje_fecha);
    console.log('‚òÅÔ∏è PocketBase resultado:', result);
  }

  // Feedback visual
  playNotificationSound();
  vibrateDevice();

  // Refrescar la wallet
  renderWallet();

  // Mostrar confirmaci√≥n
  alert(`‚ú® ¬°Solicitud enviada!\n\n${vale.from} recibir√° la notificaci√≥n para aprobar tu canje de:\n\n"${vale.concept}"`);
  
  console.log('‚úÖ Solicitud de canje completada');
}

/**
 * Mostrar popup de solicitud de canje (para el emisor)
 */
function showCanjeRequest(vale) {
  console.log('üéÅ Mostrando popup de solicitud:', vale);
  
  _pendingCanje = { serial: vale.serial, vale };

  const overlay = document.getElementById('canjeRequestOverlay');
  const solicitante = vale.to; // Quien solicita el canje (el receptor del vale)

  document.getElementById('canjeRequestTitle').textContent = '¬°Quieren canjear un vale!';
  document.getElementById('canjeRequestFrom').textContent = `${solicitante} quiere usar:`;
  document.getElementById('canjeRequestConcept').textContent = vale.concept;
  document.getElementById('canjeRequestDate').textContent = `Solicitado: ${vale.canje_fecha || new Date().toLocaleDateString('es-ES')}`;

  overlay.classList.add('visible');

  playNotificationSound();
  vibrateDevice();
}

/**
 * Aceptar solicitud de canje (emisor acepta)
 */
async function acceptCanje() {
  if (!_pendingCanje) return;

  const { serial, vale } = _pendingCanje;
  const recipient = vale.to; // Quien recibe el vale (quien solicit√≥ el canje)

  // Actualizar el vale del receptor a "canjeado"
  const recipientData = await loadWalletData(recipient);
  const recipientVale = recipientData.find(v => v.serial === serial);
  if (recipientVale) {
    recipientVale.canje_status = 'canjeado';
    recipientVale.canje_aceptado = new Date().toLocaleDateString('es-ES');
    await saveWalletData(recipient, recipientData);
  }

  // Actualizar en PocketBase
  if (window.PB && window.PB.isConnected()) {
    await window.PB.updateCanjeStatus(serial, 'canjeado', vale.canje_fecha);
  }

  // Cerrar popup
  document.getElementById('canjeRequestOverlay').classList.remove('visible');
  _pendingCanje = null;

  // Feedback
  playNotificationSound();
  
  // Refrescar wallet
  renderWallet();

  console.log('‚úÖ Canje aceptado para:', serial);
}

/**
 * Rechazar solicitud de canje (emisor no puede ahora)
 */
async function declineCanje() {
  if (!_pendingCanje) return;

  const { serial, vale } = _pendingCanje;
  const recipient = vale.to;

  // Volver el estado a null (no pendiente)
  const recipientData = await loadWalletData(recipient);
  const recipientVale = recipientData.find(v => v.serial === serial);
  if (recipientVale) {
    recipientVale.canje_status = null;
    recipientVale.canje_fecha = null;
    await saveWalletData(recipient, recipientData);
  }

  // Actualizar en PocketBase
  if (window.PB && window.PB.isConnected()) {
    await window.PB.updateCanjeStatus(serial, null, null);
  }

  // Cerrar popup
  document.getElementById('canjeRequestOverlay').classList.remove('visible');
  _pendingCanje = null;

  // Refrescar wallet
  renderWallet();
}

/**
 * Mostrar popup de √©xito de canje (para el receptor)
 */
function showCanjeSuccess(vale) {
  const overlay = document.getElementById('canjeSuccessOverlay');

  document.getElementById('canjeSuccessTitle').textContent = '¬°Vale Canjeado!';
  document.getElementById('canjeSuccessSub').textContent = `${vale.from} ha aceptado tu solicitud`;
  document.getElementById('canjeSuccessConcept').textContent = vale.concept;
  document.getElementById('canjeSuccessDate').textContent = `üìÖ Canjeable hoy: ${vale.canje_aceptado || new Date().toLocaleDateString('es-ES')}`;

  overlay.classList.add('visible');

  playNotificationSound();
  vibrateDevice();
}

/**
 * Cerrar popup de √©xito de canje
 */
function dismissCanjeSuccess() {
  document.getElementById('canjeSuccessOverlay').classList.remove('visible');
  renderWallet();
}

/**
 * Verificar si hay solicitudes de canje pendientes para el usuario actual (como emisor)
 */
async function checkPendingCanjes() {
  if (!currentUser) return;
  
  // Evitar mostrar si ya hay un popup visible
  if (document.getElementById('canjeRequestOverlay').classList.contains('visible')) return;

  let pendingCanjes = [];

  // Siempre intentar desde PocketBase primero (es la √∫nica forma de sincronizar entre dispositivos)
  if (window.PB && window.PB.isConnected()) {
    try {
      pendingCanjes = await window.PB.getPendingCanjes(currentUser);
      if (pendingCanjes.length > 0) {
        console.log('üîç ¬°Canje pendiente encontrado en PB!', pendingCanjes[0].concept);
      }
    } catch(e) {
      console.warn('Error obteniendo canjes pendientes de PB:', e);
    }
  }

  // Fallback a localStorage solo para modo offline (mismo dispositivo)
  if (pendingCanjes.length === 0) {
    const partner = currentUser === 'Florecilla' ? 'Chiquit√≠n' : 'Florecilla';
    const partnerKey = 'vales-amor:' + partner;
    try {
      const raw = localStorage.getItem(partnerKey);
      if (raw) {
        const partnerData = JSON.parse(raw);
        pendingCanjes = partnerData.filter(v => 
          v.from === currentUser && v.canje_status === 'pendiente'
        );
        if (pendingCanjes.length > 0) {
          console.log('üîç Canje pendiente encontrado en localStorage');
        }
      }
    } catch(e) {
      console.warn('Error leyendo localStorage del partner:', e);
    }
  }

  if (pendingCanjes.length > 0) {
    console.log('üì¨ Mostrando solicitud de canje:', pendingCanjes[0].concept);
    showCanjeRequest(pendingCanjes[0]);
  }
}

/**
 * Verificar si hay canjes aceptados para notificar al receptor
 */
async function checkAcceptedCanjes() {
  if (!currentUser) return;

  const myData = await loadWalletData(currentUser);

  // Buscar vales con canje reci√©n aceptado (tiene canje_aceptado pero no se ha mostrado popup)
  const acceptedCanjes = myData.filter(v => 
    v.canje_status === 'canjeado' && v.canje_aceptado && !v.canje_notified
  );

  if (acceptedCanjes.length > 0) {
    // Marcar como notificado
    acceptedCanjes.forEach(v => v.canje_notified = true);
    await saveWalletData(currentUser, myData);

    // Mostrar popup para el primero
    showCanjeSuccess(acceptedCanjes[0]);
  }
}

// ===== INIT =====
(async () => {
  diagStorage();
  createStars(); createFloaters();
  renderTags(); updateAvatars(); renderWallet();

  // Hide install banner immediately if already running as PWA
  if (isInstalledPWA()) {
    document.getElementById('installBanner').style.display = 'none';
  }

  // Lock sender direction if identity already known
  if (currentUser) lockSender();

  // Check if there's a vale in the URL (from a shared link)
  checkURLForVale();

  // Onboarding / identity check (only if no vale import popup is showing)
  if (!_pendingImportVale) {
    showOnboarding();
  }

  // Start polling for new vales
  startPolling();

  // ===== POCKETBASE INTEGRATION =====
  // Inicializar PocketBase despu√©s de un peque√±o delay para no bloquear
  setTimeout(async () => {
    if (window.PB) {
      const connected = await window.PB.init();
      if (connected && currentUser) {
        // Sincronizar vales con PocketBase
        await window.PB.sync(currentUser);
        
        // Suscribirse a cambios en tiempo real
        window.PB.subscribe(currentUser, (newVale) => {
          // Cuando llega un vale nuevo por realtime
          playNotificationSound();
          vibrateDevice();
          showNewValePopup([newVale]);
        });
        
        // Refrescar wallet despu√©s de sincronizar
        renderWallet();
        
        // Verificar canjes pendientes (si alguien me pidi√≥ canjear un vale que yo emit√≠)
        checkPendingCanjes();
        
        // Verificar canjes aceptados (si aceptaron mi solicitud de canje)
        checkAcceptedCanjes();
        
        console.log('üîó PocketBase integrado correctamente');
      }
    }
    
    // Iniciar polling de canjes cada 5 segundos (para notificaciones entre usuarios)
    setInterval(() => {
      if (currentUser) {
        checkPendingCanjes();
        checkAcceptedCanjes();
      }
    }, 5000);
    
  }, 1000);
})();

if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Vales de Amor para Florecilla y Chiquit√≠n">
<meta name="theme-color" content="#d0eef8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Vales de Amor">
<title>Vales de Amor üåô</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Special+Elite&display=swap" rel="stylesheet">
<style>
:root {
  --rose: #1a6070;
  --blush: #1a6a5a;
  --gold: #0a4a5a;
  --cream: #062535;
  --moonlight: #0d3d50;
  --parchment: #f5ead0;
  --parchment-dark: #e8d5a3;
  --ink: #2c1810;
  --ink-light: #4a2e1a;
  --teal: #1a6a7a;
  --mint: #1a6a5a;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: linear-gradient(160deg, #d0eef8 0%, #c8f0e8 30%, #d8f0f0 55%, #b8e8f5 80%, #c0f0e0 100%);
  background-attachment: fixed;
  min-height: 100vh;
  font-family: 'Cormorant Garamond', serif;
  color: var(--cream);
  overflow-x: hidden;
}

/* ===== ONBOARDING OVERLAY ===== */
.onboarding-overlay {
  position: fixed; inset: 0; z-index: 1000;
  background: linear-gradient(160deg, #d0eef8 0%, #c8f0e8 40%, #b8e8f5 100%);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 2rem; text-align: center;
  animation: fadeIn 0.5s ease;
}
.onboarding-overlay.hidden { display: none; }
.onboarding-icon { font-size: 4rem; margin-bottom: 1rem; animation: float 3s ease-in-out infinite; }
.onboarding-title {
  font-family: 'Playfair Display', serif; font-size: 2rem; font-style: italic;
  background: linear-gradient(135deg, #1a7a8a, #2a9a7a, #1a6a9a);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  margin-bottom: 0.5rem;
}
.onboarding-sub {
  font-size: 1rem; color: var(--moonlight); margin-bottom: 2.5rem;
  font-style: italic; opacity: 0.8;
}
.onboarding-question {
  font-family: 'Playfair Display', serif; font-size: 1.15rem;
  color: var(--cream); margin-bottom: 1.5rem; font-weight: 700;
}
.onboarding-btns { display: flex; flex-direction: column; gap: 1rem; width: 100%; max-width: 280px; }
.onboarding-btn {
  display: flex; align-items: center; gap: 1rem;
  padding: 1rem 1.5rem; border-radius: 1rem;
  border: 1.5px solid rgba(42,138,154,0.3);
  background: rgba(255,255,255,0.7);
  backdrop-filter: blur(10px);
  cursor: pointer; transition: all 0.25s;
  box-shadow: 0 4px 16px rgba(42,138,154,0.1);
}
.onboarding-btn:hover {
  transform: translateY(-3px) scale(1.02);
  border-color: var(--teal);
  box-shadow: 0 8px 24px rgba(42,138,154,0.2);
}
.onboarding-btn-avatar { flex-shrink: 0; }
.onboarding-btn-name {
  font-family: 'Playfair Display', serif; font-size: 1.2rem;
  font-style: italic; font-weight: 700; color: var(--cream);
}
.onboarding-btn-sub { font-size: 0.75rem; color: var(--moonlight); opacity: 0.7; }

/* ===== NEW VALE NOTIFICATION ===== */
.new-vale-overlay {
  position: fixed; inset: 0; z-index: 900;
  background: rgba(0,0,0,0.5); backdrop-filter: blur(6px);
  display: flex; align-items: center; justify-content: center;
  padding: 1.5rem; opacity: 0;
  transition: opacity 0.4s;
  pointer-events: none;
}
.new-vale-overlay.visible { opacity: 1; pointer-events: all; }
.new-vale-popup {
  background: linear-gradient(160deg, #e8f8f0, #d8f5f8);
  border: 1.5px solid rgba(42,138,154,0.25);
  border-radius: 1.5rem;
  padding: 1.8rem 1.5rem;
  max-width: 360px; width: 100%;
  box-shadow: 0 20px 60px rgba(42,138,154,0.2);
  transform: scale(0.9) translateY(20px);
  transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1);
  text-align: center;
}
.new-vale-overlay.visible .new-vale-popup { transform: scale(1) translateY(0); }
.new-vale-popup-icon { font-size: 3rem; margin-bottom: 0.5rem; }
.new-vale-popup-title {
  font-family: 'Playfair Display', serif; font-size: 1.4rem; font-style: italic;
  color: var(--cream); font-weight: 700; margin-bottom: 0.3rem;
}
.new-vale-popup-sub { font-size: 0.9rem; color: var(--moonlight); margin-bottom: 1.2rem; font-style: italic; }
.new-vale-list { display: flex; flex-direction: column; gap: 0.6rem; margin-bottom: 1.4rem; text-align: left; }
.new-vale-item {
  background: rgba(255,255,255,0.7); border: 1px solid rgba(42,138,154,0.2);
  border-radius: 0.75rem; padding: 0.65rem 0.9rem;
  font-family: 'Playfair Display', serif; font-style: italic;
  font-size: 0.95rem; color: var(--cream);
}
.new-vale-item-from { font-size: 0.7rem; color: var(--moonlight); font-style: normal; margin-top: 2px; }
.new-vale-close {
  width: 100%; padding: 0.8rem;
  background: linear-gradient(135deg, #2a8a9a, #1a7a6a);
  border: none; border-radius: 0.75rem;
  color: white; font-family: 'Playfair Display', serif;
  font-size: 1rem; font-style: italic; cursor: pointer;
  box-shadow: 0 4px 14px rgba(42,138,154,0.35);
  transition: transform 0.2s, box-shadow 0.2s;
}
.new-vale-close:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(42,138,154,0.45); }

/* ===== WALLET UNREAD BADGE ===== */
.wallet-tab-badge {
  display: inline-flex; align-items: center; justify-content: center;
  background: #e03030; color: white;
  border-radius: 50%; width: 18px; height: 18px;
  font-size: 0.65rem; font-family: sans-serif; font-style: normal; font-weight: 700;
  margin-left: 0.35rem; vertical-align: middle;
  animation: pulse 1.5s ease-in-out infinite;
}
@keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.2); } }

/* Current user chip */
.current-user-chip {
  display: flex; align-items: center; gap: 0.5rem;
  background: rgba(255,255,255,0.6); border: 1px solid rgba(42,138,154,0.2);
  border-radius: 2rem; padding: 0.3rem 0.8rem 0.3rem 0.4rem;
  backdrop-filter: blur(8px); cursor: pointer;
  transition: all 0.2s; margin-bottom: 1rem;
  font-family: 'Playfair Display', serif; font-style: italic;
  font-size: 0.8rem; color: var(--moonlight);
}
.current-user-chip:hover { background: rgba(255,255,255,0.85); border-color: var(--teal); }
.current-user-chip-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: linear-gradient(135deg, #2a8a9a, #1a7a6a);
  flex-shrink: 0;
}


.stars { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
.star {
  position: absolute; border-radius: 50%;
  animation: twinkle var(--d, 3s) ease-in-out infinite alternate;
}
@keyframes twinkle { from { opacity: 0.2; transform: scale(0.8); } to { opacity: 0.8; transform: scale(1.2); } }
.floaters { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
.floater {
  position: absolute; opacity: 0.22;
  animation: floatUp var(--d, 4s) ease-in-out infinite alternate;
}
@keyframes floatUp { from { transform: translateY(0) rotate(-5deg); } to { transform: translateY(-18px) rotate(5deg); } }

/* ===== LAYOUT ===== */
.container {
  max-width: 520px; margin: 0 auto; padding: 2rem 1.2rem 3rem;
  display: flex; flex-direction: column; align-items: center;
  position: relative; z-index: 1;
}

/* ===== HEADER ===== */
.header { text-align: center; margin-bottom: 2rem; }
.moon-icon { font-size: 2.2rem; display: block; margin-bottom: 0.4rem;
  animation: moonGlow 3s ease-in-out infinite alternate;
  filter: drop-shadow(0 0 8px rgba(42,138,154,0.4));
}
@keyframes moonGlow {
  from { filter: drop-shadow(0 0 8px rgba(42,138,154,0.4)); }
  to   { filter: drop-shadow(0 0 25px rgba(42,154,122,0.7)); }
}
h1 {
  font-family: 'Playfair Display', serif;
  font-size: 2.1rem; font-style: italic;
  background: linear-gradient(135deg, #1a7a8a, #2a9a7a, #1a6a9a);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.subtitle {
  font-size: 0.85rem; color: var(--moonlight);
  letter-spacing: 0.25em; text-transform: uppercase; margin-top: 0.4rem;
}

/* ===== INSTALL BANNER ===== */
.install-banner {
  display: none; width: 100%; max-width: 480px;
  background: rgba(255,255,255,0.55); border: 1px solid rgba(42,138,154,0.2);
  border-radius: 0.75rem; padding: 0.8rem 1.2rem; margin-bottom: 1.2rem;
  cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s;
  display: flex; align-items: center; gap: 0.8rem;
}
.install-icon { font-size: 1.5rem; }
.install-text strong { display: block; font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--gold); }
.install-text span { font-size: 0.8rem; opacity: 0.7; }

/* ===== SENDER SECTION ===== */
.sender-section {
  display: flex; flex-direction: column; align-items: center; gap: 0.6rem;
  margin-bottom: 1.8rem;
  background: rgba(255,255,255,0.55); border: 1px solid rgba(42,138,154,0.2);
  border-radius: 1rem; padding: 1rem 1.5rem;
  backdrop-filter: blur(10px); width: 100%; max-width: 480px;
  box-shadow: 0 4px 20px rgba(42,138,154,0.1);
}
.sender-label { font-size: 0.8rem; color: var(--teal); letter-spacing: 0.18em; text-transform: uppercase; font-weight: 700; }
.sender-avatars-preview {
  display: flex; align-items: center; justify-content: center; gap: 1.2rem; margin-bottom: 0.8rem;
}
.sender-avatar-wrap { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; }
.sender-avatar-name {
  font-family: 'Playfair Display', serif; font-size: 0.75rem; font-style: italic; color: var(--moonlight);
}
.sender-avatar-wrap svg { filter: drop-shadow(0 3px 8px rgba(42,138,154,0.25)); transition: transform 0.3s; }
.sender-avatar-wrap svg:hover { transform: scale(1.1); }
.sender-btns { display: flex; gap: 0.7rem; }
.sender-btn {
  padding: 0.55rem 1.3rem; border: 1px solid rgba(42,138,154,0.35);
  border-radius: 2rem; background: rgba(255,255,255,0.5); color: var(--cream);
  font-family: 'Playfair Display', serif; font-size: 0.95rem; cursor: pointer; transition: all 0.3s;
}
.sender-btn.active {
  background: linear-gradient(135deg, #2a8a9a, #1a7a6a);
  border-color: #2a8a9a; box-shadow: 0 0 18px rgba(42,138,154,0.4); color: white;
}
.sender-btn:hover:not(.active) { background: rgba(42,138,154,0.1); }

/* ===== FORM CARD ===== */
.form-card {
  width: 100%; max-width: 480px; margin-bottom: 1.5rem;
  background: rgba(255,255,255,0.6); border: 1px solid rgba(42,138,154,0.2);
  border-radius: 1rem; padding: 1.5rem;
  backdrop-filter: blur(12px); box-shadow: 0 4px 20px rgba(42,138,154,0.1);
}
.form-label {
  font-size: 0.75rem; letter-spacing: 0.2em; text-transform: uppercase;
  color: var(--teal); margin-bottom: 0.5rem; display: block; font-weight: 700;
}
.concept-input {
  width: 100%; background: rgba(255,255,255,0.7);
  border: 1px solid rgba(42,138,154,0.25);
  border-radius: 0.75rem; color: var(--cream);
  font-family: 'Playfair Display', serif;
  font-size: 1.05rem; font-style: italic; font-weight: 600;
  padding: 0.75rem 1rem; outline: none; resize: none;
  transition: border-color 0.3s, box-shadow 0.3s;
}
.concept-input::placeholder { color: rgba(6,37,53,0.45); }
.concept-input:focus { border-color: var(--rose); box-shadow: 0 0 15px rgba(42,138,154,0.2); }

.generate-btn {
  width: 100%; padding: 0.95rem; margin-top: 1rem;
  background: linear-gradient(135deg, #2a8a9a 0%, #1a7a6a 50%, #1a6a9a 100%);
  border: none; border-radius: 0.75rem; color: white;
  font-family: 'Playfair Display', serif; font-size: 1.05rem; font-style: italic;
  cursor: pointer; transition: all 0.3s;
  box-shadow: 0 4px 20px rgba(42,138,154,0.35);
  overflow: hidden; position: relative;
}
.generate-btn::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.15), transparent);
  transform: translateX(-100%); transition: transform 0.5s;
}
.generate-btn:hover::before { transform: translateX(100%); }
.generate-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(42,138,154,0.5); }

/* ===== EXPIRY ===== */
.expiry-section { margin-top: 0.2rem; }
.expiry-select {
  width: 100%; background: rgba(255,255,255,0.8);
  border: 1px solid rgba(42,138,154,0.3); border-radius: 0.75rem;
  color: var(--cream); font-family: 'Playfair Display', serif;
  font-size: 1rem; font-style: italic; padding: 0.7rem 2.5rem 0.7rem 1rem;
  outline: none; cursor: pointer; transition: border-color 0.3s, box-shadow 0.3s;
  appearance: none; -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%232a8a9a' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 1rem center; background-size: 12px;
}
.expiry-select:focus { border-color: var(--rose); box-shadow: 0 0 15px rgba(42,138,154,0.2); }
.expiry-custom {
  display: none; width: 100%; margin-top: 0.6rem;
  background: rgba(255,255,255,0.8);
  border: 1px solid rgba(42,138,154,0.3); border-radius: 0.75rem;
  color: var(--cream); font-family: 'Playfair Display', serif;
  font-size: 1rem; padding: 0.7rem 1rem; outline: none;
  transition: border-color 0.3s, box-shadow 0.3s;
}
.expiry-custom:focus { border-color: var(--rose); box-shadow: 0 0 15px rgba(42,138,154,0.2); }

/* ===== SUGGESTIONS ===== */
.suggestions { width: 100%; max-width: 480px; margin-bottom: 2rem; }
.suggestions-title {
  font-size: 0.75rem; letter-spacing: 0.2em; text-transform: uppercase;
  color: var(--teal); margin-bottom: 0.7rem;
}
.tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
.tag {
  padding: 0.3rem 0.75rem; border: 1px solid rgba(42,138,154,0.25);
  border-radius: 2rem; background: rgba(255,255,255,0.5);
  font-family: 'Playfair Display', serif; font-size: 0.82rem; font-style: italic; color: var(--cream);
  cursor: pointer; transition: all 0.25s;
}
.tag:hover { background: rgba(42,138,154,0.1); border-color: var(--teal); color: var(--moonlight); }

/* ===== TICKET ===== */
.flyer-container { width: 100%; max-width: 460px; display: none; }
.flyer-container.visible { display: block; animation: fadeUp 0.7s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(40px) scale(0.95); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}
.ticket-shadow {
  filter: drop-shadow(0 20px 40px rgba(42,138,154,0.22)) drop-shadow(0 8px 20px rgba(0,0,0,0.12));
}
.ticket { border-radius: 0.8rem; overflow: hidden; }
.ticket-header {
  background: linear-gradient(135deg, #2a8a9a, #1a7a6a);
  padding: 0.7rem 1.2rem; display: flex; justify-content: space-between; align-items: center;
}
.t-logo { display: flex; align-items: center; gap: 0.4rem; }
.t-logo-icon { font-size: 1rem; }
.t-logo-text {
  font-family: 'Special Elite', monospace; font-size: 0.6rem;
  letter-spacing: 0.2em; text-transform: uppercase; color: rgba(255,255,255,0.9);
}
.t-serial { text-align: right; }
.t-serial-label {
  font-family: 'Special Elite', monospace; font-size: 0.45rem;
  letter-spacing: 0.25em; text-transform: uppercase; color: rgba(255,255,255,0.7);
}
.t-serial-num {
  font-family: 'Special Elite', monospace; font-size: 0.65rem;
  letter-spacing: 0.15em; color: rgba(255,255,255,0.95);
}
.ticket-body {
  background: var(--parchment); padding: 1rem 1.2rem; position: relative; overflow: hidden;
}
.ticket-body::after {
  content: ''; position: absolute; inset: 0; pointer-events: none;
  background-image: repeating-linear-gradient(0deg, transparent, transparent 27px, rgba(139,90,43,0.06) 27px, rgba(139,90,43,0.06) 28px);
}
.ticket-watermark {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%) rotate(-30deg);
  font-family: 'Playfair Display', serif; font-size: 4rem; font-style: italic; font-weight: 700;
  color: rgba(42,138,154,0.06); white-space: nowrap; pointer-events: none; z-index: 0; line-height: 1;
}
.t-hr { border: none; border-top: 1px solid rgba(139,90,43,0.15); margin: 0.6rem 0; }
.ticket-parties { display: flex; align-items: center; justify-content: space-between; margin: 0.5rem 0; position: relative; z-index: 1; }
.t-party { text-align: center; flex: 1; }
.t-avatar { display: flex; justify-content: center; margin-bottom: 0.3rem; }
.t-avatar svg { filter: drop-shadow(0 2px 6px rgba(42,138,154,0.2)); transition: transform 0.3s; }
.t-avatar svg:hover { transform: scale(1.08); }
.t-party-label { font-family: 'Special Elite', monospace; font-size: 0.5rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--ink-light); display: block; margin-bottom: 2px; }
.t-party-name { font-family: 'Playfair Display', serif; font-size: 0.9rem; font-style: italic; color: var(--ink); }
.t-arrow { font-size: 1.2rem; opacity: 0.7; padding: 0 0.4rem; }
.ticket-vale {
  background: rgba(42,138,154,0.06); border: 1px solid rgba(42,138,154,0.25);
  border-radius: 0.4rem; padding: 0.7rem 0.9rem; margin: 0.5rem 0; position: relative; z-index: 1;
}
.t-vale-label { font-family: 'Special Elite', monospace; font-size: 0.5rem; letter-spacing: 0.2em; color: var(--ink-light); margin-bottom: 0.35rem; }
.t-vale-por { font-family: 'Cormorant Garamond', serif; font-size: 0.7rem; font-style: italic; color: var(--ink-light); margin-bottom: 0.2rem; }
.t-vale-concept { font-family: 'Playfair Display', serif; font-size: 1rem; font-weight: 700; color: var(--ink); line-height: 1.3; }
.ticket-deco { text-align: center; font-size: 1rem; margin: 0.55rem 0; opacity: 0.7; position: relative; z-index: 1; }
.ticket-stamp {
  position: absolute; top: 1rem; right: 1rem;
  width: 52px; height: 52px; border: 2px solid rgba(42,138,154,0.5);
  border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center;
  transform: rotate(15deg); z-index: 2;
}
.t-stamp-icon { font-size: 1.1rem; }
.t-stamp-text { font-family: 'Special Elite', monospace; font-size: 0.3rem; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(42,138,154,0.7); text-align: center; line-height: 1.3; }
.ticket-footer { display: flex; justify-content: space-between; margin-top: 0.5rem; position: relative; z-index: 1; }
.t-footer-l, .t-footer-r {
  font-family: 'Special Elite', monospace; font-size: 0.5rem;
  letter-spacing: 0.08em; color: var(--ink-light); line-height: 1.6;
}
.t-footer-r { text-align: right; }

/* Zigzag tear */
.zz-mid-wrap { line-height: 0; position: relative; z-index: 2; }
.zz-mid-wrap svg { display: block; width: 100%; }

/* Stub */
.ticket-stub {
  background: linear-gradient(135deg, var(--parchment-dark), var(--parchment));
  padding: 0.65rem 1.2rem;
  display: flex; align-items: center; justify-content: space-between; gap: 1rem;
}
.stub-left { flex: 1; }
.stub-title { font-family: 'Playfair Display', serif; font-size: 0.78rem; font-style: italic; font-weight: 700; color: var(--ink); }
.stub-sub { font-family: 'Special Elite', monospace; font-size: 0.45rem; letter-spacing: 0.1em; color: var(--ink-light); text-transform: uppercase; margin-top: 2px; }
.stub-right { font-family: 'Special Elite', monospace; font-size: 0.45rem; letter-spacing: 0.08em; color: var(--ink-light); text-align: right; line-height: 1.6; }
.barcode { display: flex; gap: 1.5px; align-items: stretch; height: 32px; opacity: 0.35; flex-shrink: 0; }
.bc-bar { background: var(--ink); border-radius: 1px; }

/* ===== ACTION BTNS ===== */
.action-btns { display: flex; gap: 1rem; margin-top: 1.5rem; }
.action-btn {
  flex: 1; padding: 0.75rem; border: 1px solid rgba(42,138,154,0.25);
  border-radius: 0.75rem; background: rgba(255,255,255,0.6);
  color: var(--cream); font-weight: 600; font-family: 'Cormorant Garamond', serif; font-size: 0.95rem;
  cursor: pointer; transition: all 0.3s; backdrop-filter: blur(8px);
  display: flex; align-items: center; justify-content: center; gap: 0.4rem;
}
.action-btn:hover { background: rgba(42,138,154,0.1); border-color: var(--teal); }
.action-btn.whatsapp-btn {
  background: linear-gradient(135deg, #25d366, #128c7e);
  border-color: #25d366; color: white !important;
}
.action-btn.whatsapp-btn:hover { opacity: 0.9; transform: translateY(-1px); }

/* ===== WALLET ===== */
.wallet-section { width: 100%; max-width: 480px; margin-top: 2.5rem; }
.wallet-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
.wallet-title {
  font-family: 'Playfair Display', serif; font-size: 1.3rem; font-style: italic;
  background: linear-gradient(135deg, #0a5060, #0a6050);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.wallet-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.2rem; }
.wallet-tab {
  flex: 1; padding: 0.55rem 0.5rem;
  border: 1px solid rgba(42,138,154,0.3); border-radius: 2rem;
  background: rgba(255,255,255,0.5); color: var(--cream);
  font-family: 'Playfair Display', serif; font-size: 0.85rem; font-style: italic;
  cursor: pointer; transition: all 0.25s; text-align: center;
}
.wallet-tab.active {
  background: linear-gradient(135deg, #2a8a9a, #1a7a6a);
  border-color: #2a8a9a; color: white; box-shadow: 0 0 14px rgba(42,138,154,0.35);
}
.wallet-empty {
  text-align: center; padding: 2rem 1rem;
  background: rgba(255,255,255,0.4); border: 1px dashed rgba(42,138,154,0.25);
  border-radius: 1rem; backdrop-filter: blur(8px);
}
.wallet-empty-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
.wallet-empty-text { font-family: 'Playfair Display', serif; font-size: 0.95rem; font-style: italic; color: var(--moonlight); }
.wallet-cards { display: flex; flex-direction: column; gap: 0.8rem; }
.vale-card {
  background: rgba(255,255,255,0.65); border: 1px solid rgba(42,138,154,0.2);
  border-radius: 1rem; padding: 0.9rem 1.1rem;
  backdrop-filter: blur(10px); box-shadow: 0 3px 14px rgba(42,138,154,0.08);
  display: flex; align-items: center; gap: 0.9rem;
  transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden;
}
.vale-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(42,138,154,0.15); }
.vale-card.status-caducado  { opacity: 0.6; border-color: rgba(180,60,60,0.25); background: rgba(255,235,235,0.55); }
.vale-card.status-caduca-1  { border-color: rgba(200,80,80,0.35); background: rgba(255,245,240,0.75); }
.vale-card.status-caduca-2  { border-color: rgba(210,140,40,0.35); background: rgba(255,250,235,0.75); }
.vale-card.status-caduca-3  { border-color: rgba(200,170,40,0.3);  background: rgba(255,253,230,0.75); }
.vale-card.status-en-fecha  { border-color: rgba(42,138,100,0.25); }
.vale-card.status-eterna    { }

.vale-card-badge {
  font-size: 0.62rem; font-family: 'Special Elite', monospace;
  padding: 0.2rem 0.45rem; border-radius: 0.4rem; text-align: center;
  letter-spacing: 0.03em; white-space: nowrap;
}
/* Badge colours per state */
.status-eterna-badge   { background: rgba(42,138,154,0.1);  color: var(--teal); }
.status-en-fecha-badge { background: rgba(42,160,100,0.12); color: #1a7a4a; }
.status-caduca-3-badge { background: rgba(190,160,20,0.15); color: #7a6010; font-weight: 700; }
.status-caduca-2-badge { background: rgba(210,130,20,0.18); color: #8a5010; font-weight: 700; }
.status-caduca-1-badge { background: rgba(200,60,40,0.15);  color: #8a2010; font-weight: 700; animation: pulse 1.2s ease-in-out infinite; }
.status-caducado-badge { background: rgba(180,50,50,0.12);  color: rgba(160,40,40,0.8); text-decoration: line-through; }

/* New vale item expiry tint in popup */
.status-caduca-1-item { border-left: 3px solid rgba(200,60,40,0.5); padding-left: 0.6rem; }
.status-caduca-2-item { border-left: 3px solid rgba(210,130,20,0.5); padding-left: 0.6rem; }
.status-caduca-3-item { border-left: 3px solid rgba(190,160,20,0.5); padding-left: 0.6rem; }
.status-caducado-item { border-left: 3px solid rgba(180,50,50,0.5); padding-left: 0.6rem; opacity: 0.75; }
.vale-card-avatar { flex-shrink: 0; }
.vale-card-body { flex: 1; min-width: 0; }
.vale-card-concept {
  font-family: 'Playfair Display', serif; font-size: 1rem; font-weight: 700; font-style: italic;
  color: var(--cream); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.vale-card-from { font-size: 0.72rem; font-family: 'Playfair Display', serif; font-style: italic; color: var(--moonlight); margin-top: 2px; }
.vale-card-meta { font-family: 'Special Elite', monospace; font-size: 0.52rem; letter-spacing: 0.1em; color: var(--moonlight); margin-top: 3px; }
.vale-card-status { flex-shrink: 0; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; }
.vale-card-delete { background: none; border: none; font-size: 0.9rem; cursor: pointer; opacity: 0.3; transition: opacity 0.2s; padding: 2px; }
.vale-card-delete:hover { opacity: 0.8; }
.vale-card-action { background: none; border: none; font-size: 0.9rem; cursor: pointer; opacity: 0.5; transition: opacity 0.2s, transform 0.15s; padding: 2px; }
.vale-card-action:hover { opacity: 1; transform: scale(1.2); }

.wallet-save-btn {
  width: 100%; margin-top: 0.8rem; padding: 0.75rem;
  border: 1px dashed rgba(42,138,154,0.4); border-radius: 0.75rem;
  background: rgba(255,255,255,0.4); color: var(--cream);
  font-family: 'Playfair Display', serif; font-size: 0.95rem; font-style: italic;
  cursor: pointer; transition: all 0.3s; display: none;
}
.wallet-save-btn.visible { display: block; }
.wallet-save-btn:hover { background: rgba(42,138,154,0.1); border-color: var(--teal); }

footer { margin-top: 2.5rem; text-align: center; font-size: 0.7rem; opacity: 0.25; letter-spacing: 0.15em; }
</style>
</head>
<body>
<div class="stars" id="stars"></div>
<div class="floaters" id="floaters"></div>

<div class="container">
  <!-- ONBOARDING OVERLAY -->
  <div class="onboarding-overlay hidden" id="onboardingOverlay">
    <div class="onboarding-icon">üíå</div>
    <div class="onboarding-title">Vales de Amor</div>
    <div class="onboarding-sub">para Florecilla &amp; Chiquit√≠n</div>
    <div class="onboarding-question">¬øQui√©n eres t√∫?</div>
    <div class="onboarding-btns">
      <button class="onboarding-btn" onclick="setIdentity('Florecilla')">
        <div class="onboarding-btn-avatar" id="onboardAvatarFlor"></div>
        <div>
          <div class="onboarding-btn-name">üå∏ Florecilla</div>
          <div class="onboarding-btn-sub">Recibir√°s los vales de Chiquit√≠n</div>
        </div>
      </button>
      <button class="onboarding-btn" onclick="setIdentity('Chiquit√≠n')">
        <div class="onboarding-btn-avatar" id="onboardAvatarChiq"></div>
        <div>
          <div class="onboarding-btn-name">üêæ Chiquit√≠n</div>
          <div class="onboarding-btn-sub">Recibir√°s los vales de Florecilla</div>
        </div>
      </button>
    </div>
  </div>

  <!-- NEW VALE NOTIFICATION POPUP -->
  <div class="new-vale-overlay" id="newValeOverlay">
    <div class="new-vale-popup">
      <div class="new-vale-popup-icon">üíå</div>
      <div class="new-vale-popup-title" id="newValeTitle">¬°Tienes vales nuevos!</div>
      <div class="new-vale-popup-sub" id="newValeSub">Tu pareja te ha enviado:</div>
      <div class="new-vale-list" id="newValeList"></div>
      <button class="new-vale-close" onclick="dismissNewVales()">üíô Ver mi Wallet</button>
    </div>
  </div>

  <div class="header">
    <span class="moon-icon">üåô</span>
    <h1>Vales de Amor</h1>
    <p class="subtitle">para Florecilla &amp; Chiquit√≠n</p>
  </div>
  <div class="install-banner" id="installBanner" onclick="installApp()">
    <div class="install-icon">üì±</div>
    <div class="install-text">
      <strong>Instalar app</strong>
      <span>A√±adir a pantalla de inicio</span>
    </div>
  </div>

  <!-- Current user chip -->
  <div class="current-user-chip" id="currentUserChip" onclick="showOnboarding(true)" style="display:none;">
    <div class="current-user-chip-dot"></div>
    <span id="currentUserChipLabel">T√∫: Florecilla</span>
    <span style="opacity:0.4;margin-left:0.2rem;font-size:0.7rem;">‚úèÔ∏è</span>
  </div>

  <div class="sender-section">
    <div class="sender-label" id="senderLabel">¬øQui√©n env√≠a el vale?</div>
    <div class="sender-avatars-preview">
      <div class="sender-avatar-wrap">
        <div id="previewAvatarFrom"></div>
        <span id="previewNameFrom" class="sender-avatar-name">Florecilla</span>
      </div>
      <div style="font-size:1.4rem;opacity:0.45;align-self:center;">üíå</div>
      <div class="sender-avatar-wrap">
        <div id="previewAvatarTo"></div>
        <span id="previewNameTo" class="sender-avatar-name">Chiquit√≠n</span>
      </div>
    </div>
    <div class="sender-btns" id="senderBtns">
      <button class="sender-btn active" onclick="setSender('Florecilla', this)">üå∏ Florecilla</button>
      <button class="sender-btn" onclick="setSender('Chiquit√≠n', this)">üêæ Chiquit√≠n</button>
    </div>
  </div>

  <div class="form-card">
    <label class="form-label">‚ú¶ el vale dice...</label>
    <textarea class="concept-input" id="conceptInput" rows="2"
      placeholder="un abrazo eterno, un beso sorpresa, una tarde de pelis juntos..."></textarea>
    <button class="generate-btn" onclick="generateFlyer()">üåô Crear mi Vale de Amor</button>
    <div class="expiry-section">
      <label class="form-label" style="margin-top:1.1rem;">üìÖ Fecha de caducidad</label>
      <select class="expiry-select" id="expirySelect" onchange="toggleCustomDate(this)">
        <option value="nunca">‚ú® No caduca nunca</option>
        <option value="hoy">Hoy mismo</option>
        <option value="1semana">En 1 semana</option>
        <option value="1mes">En 1 mes</option>
        <option value="3meses">En 3 meses</option>
        <option value="6meses">En 6 meses</option>
        <option value="1a√±o">En 1 a√±o</option>
        <option value="custom">üìÜ Elegir fecha...</option>
      </select>
      <input type="date" class="expiry-custom" id="expiryCustom">
    </div>
  </div>

  <div class="suggestions" id="suggestionsSection">
    <div class="suggestions-title" id="suggestionsTitle">‚ú¶ ideas para tu vale</div>
    <div class="tags" id="tags"></div>
  </div>

  <div class="flyer-container" id="flyerContainer">
    <div class="ticket-shadow">
      <div class="ticket">
        <div class="ticket-header">
          <div class="t-logo">
            <div class="t-logo-icon">üåô</div>
            <div class="t-logo-text">Vale de amor</div>
          </div>
          <div class="t-serial">
            <div class="t-serial-label">N¬∫ de serie</div>
            <div class="t-serial-num" id="serialNum">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
          </div>
        </div>
        <div class="ticket-body">
          <div class="ticket-watermark">Vale</div>
          <div class="ticket-stamp">
            <div class="t-stamp-icon">üíú</div>
            <div class="t-stamp-text">con todo<br>mi amor</div>
          </div>
          <hr class="t-hr">
          <div class="ticket-parties">
            <div class="t-party">
              <div class="t-avatar" id="avatarFrom">
                <svg width="52" height="52" viewBox="0 0 52 52" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="26" cy="26" r="25" fill="#e8f5f0" stroke="rgba(42,138,154,0.3)" stroke-width="1.5"/>
                  <rect x="21" y="33" width="10" height="8" rx="4" fill="#f5c8a0"/>
                  <ellipse cx="26" cy="47" rx="13" ry="8" fill="#2a2a2a"/>
                  <circle cx="26" cy="26" r="11" fill="#f5c8a0"/>
                  <ellipse cx="26" cy="13" rx="8" ry="5" fill="#6b3a1f"/>
                  <ellipse cx="17" cy="22" rx="3" ry="6" fill="#7a4020"/>
                  <ellipse cx="35" cy="22" rx="3" ry="6" fill="#7a4020"/>
                  <ellipse cx="26" cy="17" rx="9" ry="7" fill="#7a4020"/>
                  <circle cx="26" cy="12" r="5" fill="#6b3a1f"/>
                  <path d="M17 20 Q26 16 35 20" fill="#7a4020"/>
                  <ellipse cx="22" cy="26" rx="1.8" ry="2" fill="#3a2010"/>
                  <ellipse cx="30" cy="26" rx="1.8" ry="2" fill="#3a2010"/>
                  <circle cx="23" cy="25" r="0.6" fill="white"/>
                  <circle cx="31" cy="25" r="0.6" fill="white"/>
                  <path d="M21 30 Q26 34 31 30" stroke="#c47a5a" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                  <circle cx="19" cy="29" r="2.5" fill="rgba(255,150,120,0.25)"/>
                  <circle cx="33" cy="29" r="2.5" fill="rgba(255,150,120,0.25)"/>
                </svg>
              </div>
              <span class="t-party-label">de</span>
              <div class="t-party-name" id="ticketFrom">Florecilla</div>
            </div>
            <div class="t-arrow">üíå</div>
            <div class="t-party">
              <div class="t-avatar" id="avatarTo">
                <svg width="52" height="52" viewBox="0 0 52 52" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="26" cy="26" r="25" fill="#e8f0f8" stroke="rgba(42,138,154,0.3)" stroke-width="1.5"/>
                  <rect x="21" y="33" width="10" height="8" rx="4" fill="#d4a882"/>
                  <ellipse cx="26" cy="47" rx="13" ry="8" fill="#1a1a1a"/>
                  <circle cx="26" cy="26" r="11" fill="#d4a882"/>
                  <circle cx="26" cy="21" r="11" fill="#c09070"/>
                  <circle cx="26" cy="19" r="10.5" fill="#c89878"/>
                  <path d="M18 30 Q26 38 34 30 Q30 35 26 36 Q22 35 18 30Z" fill="#b8a898"/>
                  <ellipse cx="26" cy="30" rx="5" ry="2" fill="#b0a090"/>
                  <rect x="16" y="23" width="8" height="5.5" rx="2.5" fill="#1a1a2e" opacity="0.95"/>
                  <rect x="28" y="23" width="8" height="5.5" rx="2.5" fill="#1a1a2e" opacity="0.95"/>
                  <line x1="24" y1="25.5" x2="28" y2="25.5" stroke="#1a1a2e" stroke-width="1.5"/>
                  <line x1="16" y1="25.5" x2="14" y2="25" stroke="#1a1a2e" stroke-width="1.5"/>
                  <line x1="36" y1="25.5" x2="38" y2="25" stroke="#1a1a2e" stroke-width="1.5"/>
                  <rect x="17" y="23.5" width="6" height="4" rx="2" fill="#3a6aee" opacity="0.6"/>
                  <rect x="29" y="23.5" width="6" height="4" rx="2" fill="#3a6aee" opacity="0.6"/>
                  <line x1="18" y1="24.5" x2="21" y2="24.5" stroke="rgba(255,255,255,0.4)" stroke-width="0.8"/>
                  <line x1="30" y1="24.5" x2="33" y2="24.5" stroke="rgba(255,255,255,0.4)" stroke-width="0.8"/>
                  <path d="M22 31.5 Q26 34 30 31.5" stroke="#9a7a5a" stroke-width="1.2" fill="none" stroke-linecap="round"/>
                </svg>
              </div>
              <span class="t-party-label">para</span>
              <div class="t-party-name" id="ticketTo">Chiquit√≠n</div>
            </div>
          </div>
          <hr class="t-hr">
          <div class="ticket-vale">
            <div class="t-vale-label">‚ú¶ ¬∑ ¬∑ ¬∑ vale por ¬∑ ¬∑ ¬∑ ‚ú¶</div>
            <div class="t-vale-por">Este vale te da derecho a</div>
            <div class="t-vale-concept" id="ticketConcept">...</div>
          </div>
          <div class="ticket-deco">üå∏ üåô üåπ üêæ üí´ üíô üå∫ üê∂</div>
          <div class="ticket-footer">
            <div class="t-footer-l">Emitido con amor ‚ô•<br><span id="ticketEmitido">--/--/----</span></div>
            <div class="t-footer-r">Caduca: <span id="ticketCaduca">nunca ‚ú®</span><br>Canjeable cuando quieras</div>
          </div>
        </div>
        <div class="zz-mid-wrap">
          <svg viewBox="0 0 400 12" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
            <polygon points="0,0 400,0 400,12 390,6 380,12 370,6 360,12 350,6 340,12 330,6 320,12 310,6 300,12 290,6 280,12 270,6 260,12 250,6 240,12 230,6 220,12 210,6 200,12 190,6 180,12 170,6 160,12 150,6 140,12 130,6 120,12 110,6 100,12 90,6 80,12 70,6 60,12 50,6 40,12 30,6 20,12 10,6 0,12" fill="#f5ead0"/>
          </svg>
        </div>
        <div class="ticket-stub">
          <div class="stub-left">
            <div class="stub-title" id="stubFrom">De Florecilla</div>
            <div class="stub-sub" id="stubConcept">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
          </div>
          <canvas class="barcode" id="barcode" width="60" height="32"></canvas>
          <div class="stub-right">
            <div id="stubSerial">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
            <div id="stubCaduca">No caduca ‚ú®</div>
          </div>
        </div>
      </div>
    </div>

    <button class="wallet-save-btn" id="walletSaveBtn" onclick="saveToWallet()">
      üíæ Guardar vale en la Wallet
    </button>

    <div class="action-btns">
      <button class="action-btn" id="shareBtn" onclick="shareAsImage()">üì∏ Guardar imagen</button>
    </div>
    <div class="action-btns" style="margin-top:0.6rem;">
      <button class="action-btn whatsapp-btn" id="waBtn" onclick="shareWhatsapp()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
        Enviar por WhatsApp
      </button>
    </div>
  </div>

  <!-- WALLET -->
  <div class="wallet-section">
    <div class="wallet-header">
      <div class="wallet-title" id="walletTitleEl">üí≥ Mi Wallet de Amor</div>
    </div>
    <div class="wallet-tabs">
      <button class="wallet-tab active" id="tabFlorecilla" onclick="switchWalletTab('Florecilla', this)">üå∏ Florecilla<span class="wallet-tab-badge" id="badgeFlorecilla" style="display:none"></span></button>
      <button class="wallet-tab" id="tabChiquitin" onclick="switchWalletTab('Chiquit√≠n', this)">üêæ Chiquit√≠n<span class="wallet-tab-badge" id="badgeChiquitin" style="display:none"></span></button>
    </div>
    <div id="walletCards" class="wallet-cards"></div>
  </div>

  <footer id="footerEl">üåô hecho con amor ¬∑ para siempre vuestro üåπ</footer>
</div>

<script>
// ===== STATE =====
let sender = 'Florecilla';
// ===== IDENTITY & ONBOARDING =====
let currentUser = localStorage.getItem('vales-identity') || null;

function setIdentity(name) {
  currentUser = name;
  localStorage.setItem('vales-identity', name);
  // Lock sender to current user
  lockSender();
  // Hide onboarding
  document.getElementById('onboardingOverlay').classList.add('hidden');
  // Show user chip
  showUserChip();
  // Check for new vales
  checkNewVales();
}

function showOnboarding(forceShow = false) {
  const overlay = document.getElementById('onboardingOverlay');
  const oFlor = document.getElementById('onboardAvatarFlor');
  const oChiq = document.getElementById('onboardAvatarChiq');
  if (oFlor) oFlor.innerHTML = AVATAR_FLORECILLA.replace('width="52" height="52"', 'width="44" height="44"');
  if (oChiq) oChiq.innerHTML = AVATAR_CHIQUTIN.replace('width="52" height="52"', 'width="44" height="44"');

  if (!currentUser || forceShow) {
    // Temporarily restore buttons so identity can be re-chosen
    const btns = document.getElementById('senderBtns');
    if (btns) btns.style.display = 'flex';
    const label = document.getElementById('senderLabel');
    if (label) label.textContent = '¬øQui√©n env√≠a el vale?';
    overlay.classList.remove('hidden');
  } else {
    overlay.classList.add('hidden');
    showUserChip();
    checkNewVales();
  }
}

function showUserChip() {
  if (!currentUser) return;
  const chip = document.getElementById('currentUserChip');
  const label = document.getElementById('currentUserChipLabel');
  if (chip) chip.style.display = 'flex';
  if (label) label.textContent = (currentUser === 'Florecilla' ? 'üå∏' : 'üêæ') + ' T√∫: ' + currentUser;
}

// ===== NEW VALE DETECTION =====
// We track which serials the user has "seen" via localStorage
function seenKey(user) { return 'vales-seen:' + user; }

function getSeenSerials(user) {
  try { return JSON.parse(localStorage.getItem(seenKey(user)) || '[]'); } catch(e) { return []; }
}
function markAllSeen(user, data) {
  const serials = data.map(v => v.serial);
  localStorage.setItem(seenKey(user), JSON.stringify(serials));
}

// ===== SOUND & VIBRATION =====
function playNotificationSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    // Sweet two-note chime: C5 then E5
    [[523.25, 0, 0.15], [659.25, 0.18, 0.2]].forEach(([freq, delay, dur]) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime + delay);
      gain.gain.setValueAtTime(0, ctx.currentTime + delay);
      gain.gain.linearRampToValueAtTime(0.18, ctx.currentTime + delay + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + dur);
      osc.start(ctx.currentTime + delay);
      osc.stop(ctx.currentTime + delay + dur);
    });
  } catch(e) {}
}

function vibrateDevice() {
  try {
    if (navigator.vibrate) navigator.vibrate([120, 60, 80]);
  } catch(e) {}
}

async function checkNewVales() {
  if (!currentUser) return;
  const data = await loadWalletData(currentUser);
  const seen = getSeenSerials(currentUser);
  const newVales = data.filter(v => !seen.includes(v.serial));

  // Update tab badge
  updateBadge(currentUser, newVales.length);

  // Update PWA app icon badge
  if (newVales.length > 0 && navigator.setAppBadge) {
    navigator.setAppBadge(newVales.length).catch(() => {});
  } else if (newVales.length === 0 && navigator.clearAppBadge) {
    navigator.clearAppBadge().catch(() => {});
  }

  if (newVales.length > 0) {
    playNotificationSound();
    vibrateDevice();
    showNewValePopup(newVales);
  } else {
    // No new vales ‚Äî check expiry alerts instead
    await checkExpiryAlerts(currentUser);
  }
}

function updateBadge(user, count) {
  const badgeId = user === 'Florecilla' ? 'badgeFlorecilla' : 'badgeChiquitin';
  const badge = document.getElementById(badgeId);
  if (!badge) return;
  if (count > 0) {
    badge.textContent = count;
    badge.style.display = 'inline-flex';
  } else {
    badge.style.display = 'none';
  }
}

function showNewValePopup(newVales) {
  const overlay = document.getElementById('newValeOverlay');
  const title = document.getElementById('newValeTitle');
  const sub = document.getElementById('newValeSub');
  const list = document.getElementById('newValeList');
  if (!overlay) return;

  const partner = currentUser === 'Florecilla' ? 'Chiquit√≠n' : 'Florecilla';
  title.textContent = newVales.length === 1 ? '¬°Tienes un vale nuevo! üíå' : `¬°Tienes ${newVales.length} vales nuevos! üíå`;
  sub.textContent = partner + ' te ha enviado:';
  list.innerHTML = newVales.map(v => `
    <div class="new-vale-item">
      <div>‚ú® ${v.concept}</div>
      <div class="new-vale-item-from">De ${v.from} ¬∑ ${v.emitido}</div>
    </div>`).join('');

  overlay.classList.add('visible');
}

function dismissNewVales() {
  if (!currentUser) return;
  const overlay = document.getElementById('newValeOverlay');
  overlay.classList.remove('visible');

  // Mark all current vales as seen
  loadWalletData(currentUser).then(data => {
    markAllSeen(currentUser, data);
    updateBadge(currentUser, 0);
    if (navigator.clearAppBadge) navigator.clearAppBadge().catch(() => {});
  });

  // Switch wallet to current user's tab
  walletTab = currentUser;
  document.querySelectorAll('.wallet-tab').forEach(b => {
    b.classList.toggle('active', b.textContent.includes(currentUser));
  });
  renderWallet();

  // Scroll to wallet
  setTimeout(() => {
    document.querySelector('.wallet-section')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 300);
}

// Polling: check for new vales every 30s while app is open
// Also play sound+vibrate if new vales appear during polling
let _lastSeenCount = 0;
let pollingInterval = null;
function startPolling() {
  if (pollingInterval) clearInterval(pollingInterval);
  pollingInterval = setInterval(async () => {
    if (!currentUser) return;
    const data = await loadWalletData(currentUser);
    const seen = getSeenSerials(currentUser);
    const newVales = data.filter(v => !seen.includes(v.serial));
    const newCount = newVales.length;
    updateBadge(currentUser, newCount);
    if (newCount > 0 && navigator.setAppBadge) navigator.setAppBadge(newCount).catch(() => {});
    // New vale arrived during session
    if (newCount > _lastSeenCount) {
      playNotificationSound();
      vibrateDevice();
      showNewValePopup(newVales);
    }
    _lastSeenCount = newCount;
    // Always check expiry alerts on each poll
    await checkExpiryAlerts(currentUser);
  }, 30000);
}


let walletTab = 'Florecilla';
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); deferredPrompt = e;
  document.getElementById('installBanner').style.display = 'flex';
});
function installApp() {
  if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; document.getElementById('installBanner').style.display = 'none'; }
}

// ===== SENDER =====
function setSender(name, btn) {
  // If identity is fixed, ignore attempts to change sender
  if (currentUser && name !== currentUser) return;
  sender = name;
  document.querySelectorAll('.sender-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTags();
  updateAvatars();
}

function lockSender() {
  if (!currentUser) return;
  // Force sender to currentUser
  sender = currentUser;
  // Activate the correct button
  document.querySelectorAll('.sender-btn').forEach(b => {
    b.classList.toggle('active', b.textContent.includes(currentUser));
  });
  // Hide selector buttons ‚Äî direction is fixed
  const btns = document.getElementById('senderBtns');
  if (btns) btns.style.display = 'none';
  // Update label to show fixed direction
  const label = document.getElementById('senderLabel');
  const icon    = currentUser === 'Florecilla' ? 'üå∏' : 'üêæ';
  const partner = currentUser === 'Florecilla' ? 'Chiquit√≠n' : 'Florecilla';
  const partnerIcon = partner === 'Florecilla' ? 'üå∏' : 'üêæ';
  if (label) label.textContent = `${icon} ${currentUser} ‚Üí ${partnerIcon} ${partner}`;
}

// ===== AVATARS =====
const AVATAR_FLORECILLA = `<svg width="52" height="52" viewBox="0 0 52 52" xmlns="http://www.w3.org/2000/svg">
  <circle cx="26" cy="26" r="25" fill="#e8f5f0" stroke="rgba(42,138,154,0.3)" stroke-width="1.5"/>
  <rect x="21" y="33" width="10" height="8" rx="4" fill="#f5c8a0"/>
  <ellipse cx="26" cy="47" rx="13" ry="8" fill="#2a2a2a"/>
  <circle cx="26" cy="26" r="11" fill="#f5c8a0"/>
  <ellipse cx="26" cy="13" rx="8" ry="5" fill="#6b3a1f"/>
  <ellipse cx="17" cy="22" rx="3" ry="6" fill="#7a4020"/>
  <ellipse cx="35" cy="22" rx="3" ry="6" fill="#7a4020"/>
  <ellipse cx="26" cy="17" rx="9" ry="7" fill="#7a4020"/>
  <circle cx="26" cy="12" r="5" fill="#6b3a1f"/>
  <path d="M17 20 Q26 16 35 20" fill="#7a4020"/>
  <ellipse cx="22" cy="26" rx="1.8" ry="2" fill="#3a2010"/>
  <ellipse cx="30" cy="26" rx="1.8" ry="2" fill="#3a2010"/>
  <circle cx="23" cy="25" r="0.6" fill="white"/>
  <circle cx="31" cy="25" r="0.6" fill="white"/>
  <path d="M21 30 Q26 34 31 30" stroke="#c47a5a" stroke-width="1.5" fill="none" stroke-linecap="round"/>
  <circle cx="19" cy="29" r="2.5" fill="rgba(255,150,120,0.25)"/>
  <circle cx="33" cy="29" r="2.5" fill="rgba(255,150,120,0.25)"/>
</svg>`;

const AVATAR_CHIQUTIN = `<svg width="52" height="52" viewBox="0 0 52 52" xmlns="http://www.w3.org/2000/svg">
  <circle cx="26" cy="26" r="25" fill="#e8f0f8" stroke="rgba(42,138,154,0.3)" stroke-width="1.5"/>
  <rect x="21" y="33" width="10" height="8" rx="4" fill="#d4a882"/>
  <ellipse cx="26" cy="47" rx="13" ry="8" fill="#1a1a1a"/>
  <circle cx="26" cy="26" r="11" fill="#d4a882"/>
  <circle cx="26" cy="21" r="11" fill="#c09070"/>
  <circle cx="26" cy="19" r="10.5" fill="#c89878"/>
  <path d="M18 30 Q26 38 34 30 Q30 35 26 36 Q22 35 18 30Z" fill="#b8a898"/>
  <ellipse cx="26" cy="30" rx="5" ry="2" fill="#b0a090"/>
  <rect x="16" y="23" width="8" height="5.5" rx="2.5" fill="#1a1a2e" opacity="0.95"/>
  <rect x="28" y="23" width="8" height="5.5" rx="2.5" fill="#1a1a2e" opacity="0.95"/>
  <line x1="24" y1="25.5" x2="28" y2="25.5" stroke="#1a1a2e" stroke-width="1.5"/>
  <line x1="16" y1="25.5" x2="14" y2="25" stroke="#1a1a2e" stroke-width="1.5"/>
  <line x1="36" y1="25.5" x2="38" y2="25" stroke="#1a1a2e" stroke-width="1.5"/>
  <rect x="17" y="23.5" width="6" height="4" rx="2" fill="#3a6aee" opacity="0.6"/>
  <rect x="29" y="23.5" width="6" height="4" rx="2" fill="#3a6aee" opacity="0.6"/>
  <line x1="18" y1="24.5" x2="21" y2="24.5" stroke="rgba(255,255,255,0.4)" stroke-width="0.8"/>
  <line x1="30" y1="24.5" x2="33" y2="24.5" stroke="rgba(255,255,255,0.4)" stroke-width="0.8"/>
  <path d="M22 31.5 Q26 34 30 31.5" stroke="#9a7a5a" stroke-width="1.2" fill="none" stroke-linecap="round"/>
</svg>`;

function updateAvatars() {
  const fromFlor = sender === 'Florecilla';
  const avatarA = fromFlor ? AVATAR_FLORECILLA : AVATAR_CHIQUTIN;
  const avatarB = fromFlor ? AVATAR_CHIQUTIN : AVATAR_FLORECILLA;
  const nameA = fromFlor ? 'Florecilla' : 'Chiquit√≠n';
  const nameB = fromFlor ? 'Chiquit√≠n' : 'Florecilla';

  const elFrom = document.getElementById('avatarFrom');
  const elTo = document.getElementById('avatarTo');
  if (elFrom) elFrom.innerHTML = avatarA;
  if (elTo) elTo.innerHTML = avatarB;

  const pFrom = document.getElementById('previewAvatarFrom');
  const pTo = document.getElementById('previewAvatarTo');
  if (pFrom) pFrom.innerHTML = avatarA;
  if (pTo) pTo.innerHTML = avatarB;

  const nFrom = document.getElementById('previewNameFrom');
  const nTo = document.getElementById('previewNameTo');
  if (nFrom) nFrom.textContent = nameA;
  if (nTo) nTo.textContent = nameB;
}

// ===== TAGS =====
const ideas = {
  Florecilla: ['un abrazo de oso muy largo','elegir la peli esta noche','un beso sorpresa','un masaje en los pies','una tarde de mimos','preparo yo la cena','un d√≠a sin quejas üòá','te dejo el mando'],
  Chiquit√≠n:  ['un paseo rom√°ntico','flores inesperadas','desayuno en la cama','un beso cuando llegues','una sorpresa secreta','bailar contigo esta noche','te escribo una carta','un d√≠a tuyo entero']
};
function renderTags() {
  const currentIdeas = ideas;
  document.getElementById('tags').innerHTML = currentIdeas[sender].map(idea =>
    `<span class="tag" onclick="useSuggestion(this)" data-idea="${idea.replace(/"/g,'&quot;')}">${idea}</span>`
  ).join('');
}
function useSuggestion(el) {
  document.getElementById('conceptInput').value = el.dataset.idea;
  document.getElementById('conceptInput').focus();
}

// ===== EXPIRY =====
function toggleCustomDate(sel) {
  document.getElementById('expiryCustom').style.display = sel.value === 'custom' ? 'block' : 'none';
}
function getExpiryText() {
  const sel = document.getElementById('expirySelect').value;
  const now = new Date();
  const fmt = d => d.toLocaleDateString('es-ES', {day:'2-digit', month:'2-digit', year:'numeric'});
  if (sel === 'nunca') return 'nunca ‚ú®';
  if (sel === 'hoy') return fmt(now);
  if (sel === 'custom') {
    const val = document.getElementById('expiryCustom').value;
    return val ? fmt(new Date(val + 'T12:00:00')) : 'nunca ‚ú®';
  }
  const d = new Date(now);
  if (sel === '1semana') d.setDate(d.getDate() + 7);
  if (sel === '1mes')    d.setMonth(d.getMonth() + 1);
  if (sel === '3meses')  d.setMonth(d.getMonth() + 3);
  if (sel === '6meses')  d.setMonth(d.getMonth() + 6);
  if (sel === '1a√±o')    d.setFullYear(d.getFullYear() + 1);
  return fmt(d);
}

// ===== SERIAL & BARCODE =====
function generateSerial() {
  const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let s = '';
  for (let i = 0; i < 8; i++) { if (i===4) s+='-'; s += c[Math.floor(Math.random()*c.length)]; }
  return s;
}
function generateBarcode() {
  const canvas = document.getElementById('barcode');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = '#2c1810';
  let x = 0;
  [1,2,1,3,1,2,2,1,3,1,2,1,1,3,2,1,2,1,3,1,2].forEach((w,i) => {
    if (i % 2 === 0) ctx.fillRect(x, 0, w*2, canvas.height);
    x += w*2 + 1.5;
  });
}

// ===== GENERATE FLYER =====
function generateFlyer() {
  const concept = document.getElementById('conceptInput').value.trim();
  if (!concept) {
    document.getElementById('conceptInput').style.borderColor = 'var(--rose)';
    setTimeout(() => document.getElementById('conceptInput').style.borderColor = '', 1500);
    return;
  }
  const receiver = sender === 'Florecilla' ? 'Chiquit√≠n' : 'Florecilla';
  const serial = generateSerial();
  const dateStr = new Date().toLocaleDateString('es-ES', {day:'2-digit',month:'2-digit',year:'numeric'});
  const expiryText = getExpiryText();

  document.getElementById('ticketFrom').textContent = sender;
  document.getElementById('ticketTo').textContent = receiver;
  document.getElementById('ticketConcept').textContent = concept;
  document.getElementById('serialNum').textContent = serial;
  document.getElementById('ticketEmitido').textContent = dateStr;
  document.getElementById('ticketCaduca').textContent = expiryText;
  document.getElementById('stubFrom').textContent = 'De ' + sender;
  document.getElementById('stubConcept').textContent = concept.length > 22 ? concept.slice(0,22)+'‚Ä¶' : concept;
  document.getElementById('stubSerial').textContent = serial;
  document.getElementById('stubCaduca').textContent = expiryText === 'nunca ‚ú®' ? 'No caduca ‚ú®' : 'Caduca: ' + expiryText;

  updateAvatars();
  generateBarcode();

  const container = document.getElementById('flyerContainer');
  container.classList.remove('visible');
  void container.offsetWidth;
  container.classList.add('visible');

  // Show wallet save button
  const saveBtn = document.getElementById('walletSaveBtn');
  if (saveBtn) {
    saveBtn.classList.add('visible');
    saveBtn.textContent = 'üíæ Guardar vale en la Wallet';
  }

  container.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ===== WALLET STORAGE (localStorage + window.storage fallback) =====
function walletKey(owner) {
  return 'vales-amor:' + owner;
}

async function loadWalletData(owner) {
  // Try window.storage first (Claude.ai), then localStorage (GitHub Pages etc.)
  try {
    if (window.storage) {
      const result = await window.storage.get(walletKey(owner));
      if (result && result.value) return JSON.parse(result.value);
    }
  } catch(e) {}
  try {
    const raw = localStorage.getItem(walletKey(owner));
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return [];
}

async function saveWalletData(owner, data) {
  const json = JSON.stringify(data);
  // Save to both for maximum compatibility
  try { if (window.storage) await window.storage.set(walletKey(owner), json); } catch(e) {}
  try { localStorage.setItem(walletKey(owner), json); } catch(e) {}
}

async function saveToWallet() {
  const concept = document.getElementById('ticketConcept')?.textContent?.trim();
  const from    = document.getElementById('ticketFrom')?.textContent?.trim();
  const to      = document.getElementById('ticketTo')?.textContent?.trim();
  const serial  = document.getElementById('serialNum')?.textContent?.trim();
  const caduca  = document.getElementById('ticketCaduca')?.textContent?.trim();
  const emitido = document.getElementById('ticketEmitido')?.textContent?.trim();

  const btn = document.getElementById('walletSaveBtn');
  const modeText = 'üíæ Guardar vale en la Wallet';

  // Guard: must have a real generated ticket
  if (!concept || concept === '...' || !to || !serial || serial.startsWith('‚îÄ')) {
    if (btn) { btn.textContent = '‚ö†Ô∏è Primero genera un vale'; setTimeout(() => btn.textContent = modeText, 2000); }
    return;
  }

  const vale = { id: Date.now(), concept, from, to, serial, caduca, emitido };

  // Save to BOTH wallets ‚Äî recipient and sender
  let savedAny = false;
  for (const owner of [to, from]) {
    const data = await loadWalletData(owner);
    if (!data.find(v => v.serial === serial)) {
      data.unshift(vale);
      await saveWalletData(owner, data);
      savedAny = true;
    }
  }

  if (btn) {
    if (savedAny) {
      btn.textContent = `‚úÖ Guardado para ${from} y ${to}`;
    } else {
      btn.textContent = '‚úÖ Ya estaba guardado';
    }
    setTimeout(() => btn.textContent = modeText, 2500);
  }

  // Update badge for recipient (they have unseen vales now)
  const recipientData = await loadWalletData(to);
  const recipientSeen = getSeenSerials(to);
  const recipientNew = recipientData.filter(v => !recipientSeen.includes(v.serial)).length;
  updateBadge(to, recipientNew);

  // Switch wallet tab to recipient so user sees it immediately
  walletTab = to;
  document.querySelectorAll('.wallet-tab').forEach(b => {
    b.classList.toggle('active', b.textContent.includes(to));
  });
  renderWallet();
}

// ===== WALLET DISPLAY =====
function switchWalletTab(name, btn) {
  walletTab = name;
  document.querySelectorAll('.wallet-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderWallet();
}

// ===== VALE STATUS =====
function parseExpiryDate(caduca) {
  if (!caduca || caduca.includes('nunca') || caduca.includes('‚ú®')) return null;
  const clean = caduca.replace('Caduca: ', '').trim();
  const parts = clean.split('/');
  if (parts.length !== 3) return null;
  const d = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
  d.setHours(23, 59, 59, 0); // end of that day
  return isNaN(d.getTime()) ? null : d;
}

function getValeStatus(caduca) {
  const expiry = parseExpiryDate(caduca);
  if (!expiry) return { key: 'eterna',   label: '‚ú® Sin caducidad', css: 'status-eterna' };
  const now   = new Date();
  const days  = Math.ceil((expiry - now) / 86400000);
  if (days < 0)  return { key: 'caducado', label: 'üíÄ Caducado',      css: 'status-caducado' };
  if (days === 0) return { key: 'caduca-1', label: '‚ö†Ô∏è Caduca hoy',    css: 'status-caduca-1' };
  if (days === 1) return { key: 'caduca-1', label: '‚ö†Ô∏è Caduca en 1 d√≠a', css: 'status-caduca-1' };
  if (days === 2) return { key: 'caduca-2', label: 'üî∂ Caduca en 2 d√≠as', css: 'status-caduca-2' };
  if (days === 3) return { key: 'caduca-3', label: 'üîî Caduca en 3 d√≠as', css: 'status-caduca-3' };
  return { key: 'en-fecha', label: `‚úÖ En fecha ¬∑ ${days}d`, css: 'status-en-fecha' };
}

// Keep these for backward compat with previewFromWallet
function isExpired(caduca) { return getValeStatus(caduca).key === 'caducado'; }
function daysLeft(caduca) {
  const expiry = parseExpiryDate(caduca);
  if (!expiry) return null;
  return Math.ceil((expiry - new Date()) / 86400000);
}

// ===== EXPIRY ALERT SYSTEM =====
function expiryAlertKey(user) { return 'vales-expiry-alerted:' + user; }

function getAlertedSerials(user) {
  try { return JSON.parse(localStorage.getItem(expiryAlertKey(user)) || '[]'); } catch(e) { return []; }
}
function setAlertedSerials(user, serials) {
  try { localStorage.setItem(expiryAlertKey(user), JSON.stringify(serials)); } catch(e) {}
}

async function checkExpiryAlerts(user) {
  if (!user) return;
  const data = await loadWalletData(user);
  const alerted = getAlertedSerials(user);
  const toAlert = [];

  data.forEach(vale => {
    const status = getValeStatus(vale.caduca);
    const alertKeys = ['caduca-1', 'caduca-2', 'caduca-3', 'caducado'];
    if (!alertKeys.includes(status.key)) return;
    // Alert once per (serial + status key) combo ‚Äî re-alerts if status changes
    const alertId = vale.serial + ':' + status.key;
    if (!alerted.includes(alertId)) toAlert.push({ vale, status, alertId });
  });

  if (toAlert.length === 0) return;

  // Mark as alerted
  const newAlerted = [...alerted, ...toAlert.map(a => a.alertId)];
  setAlertedSerials(user, newAlerted);

  // Play sound + vibrate
  playNotificationSound();
  vibrateDevice();

  // Show expiry popup
  showExpiryPopup(toAlert);
}

function showExpiryPopup(alerts) {
  const overlay = document.getElementById('newValeOverlay');
  const title   = document.getElementById('newValeTitle');
  const sub     = document.getElementById('newValeSub');
  const list    = document.getElementById('newValeList');
  if (!overlay) return;

  title.textContent = alerts.length === 1 ? '‚è∞ Aviso de caducidad' : `‚è∞ ${alerts.length} vales con aviso`;
  sub.textContent   = 'Revisa el estado de tus vales:';
  list.innerHTML    = alerts.map(({ vale, status }) => `
    <div class="new-vale-item ${status.css}-item">
      <div>${status.label} ¬∑ <em>${vale.concept}</em></div>
      <div class="new-vale-item-from">De ${vale.from} ¬∑ vence ${vale.caduca}</div>
    </div>`).join('');

  overlay.classList.add('visible');
}


async function deleteFromWallet(owner, id) {
  const data = await loadWalletData(owner);
  await saveWalletData(owner, data.filter(v => v.id !== id));
  renderWallet();
}

async function renderWallet() {
  const data = await loadWalletData(walletTab);
  const container = document.getElementById('walletCards');

  if (!data.length) {
    container.innerHTML = `<div class="wallet-empty">
      <div class="wallet-empty-icon">üíå</div>
      <div class="wallet-empty-text">A√∫n no hay vales para ${walletTab}</div>
    </div>`;
    return;
  }

  const isFlor = walletTab === 'Florecilla';
  const ownerAv = isFlor ? AVATAR_FLORECILLA : AVATAR_CHIQUTIN;
  const senderAv = isFlor ? AVATAR_CHIQUTIN : AVATAR_FLORECILLA;
  const smallAv = av => av.replace('width="52" height="52"', 'width="36" height="36"');

  container.innerHTML = data.map(vale => {
    const status = getValeStatus(vale.caduca);
    const av = vale.from === walletTab ? smallAv(ownerAv) : smallAv(senderAv);
    const idSafe = vale.id;
    return `<div class="vale-card ${status.css}">
      <div class="vale-card-avatar">${av}</div>
      <div class="vale-card-body">
        <div class="vale-card-concept">${vale.concept}</div>
        <div class="vale-card-from">De ${vale.from} ¬∑ ${vale.emitido}</div>
        <div class="vale-card-meta">N¬∫ ${vale.serial}</div>
      </div>
      <div class="vale-card-status">
        <div class="vale-card-badge ${status.css}-badge">${status.label}</div>
        <div style="display:flex;gap:0.3rem;margin-top:0.2rem;">
          <button class="vale-card-action" onclick="previewFromWallet(${idSafe})" title="Ver y compartir">üëÅ</button>
          <button class="vale-card-delete" onclick="deleteFromWallet('${walletTab}', ${idSafe})" title="Eliminar">üóë</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

async function previewFromWallet(id) {
  // Find the vale across both wallets
  let vale = null;
  for (const owner of ['Florecilla', 'Chiquit√≠n']) {
    const data = await loadWalletData(owner);
    const found = data.find(v => v.id === id);
    if (found) { vale = found; break; }
  }
  if (!vale) return;

  // Populate ticket fields
  document.getElementById('ticketFrom').textContent    = vale.from;
  document.getElementById('ticketTo').textContent      = vale.to;
  document.getElementById('ticketConcept').textContent = vale.concept;
  document.getElementById('serialNum').textContent     = vale.serial;
  document.getElementById('ticketEmitido').textContent = vale.emitido;
  document.getElementById('ticketCaduca').textContent  = vale.caduca;
  document.getElementById('stubFrom').textContent      = 'De ' + vale.from;
  document.getElementById('stubSerial').textContent    = vale.serial;
  document.getElementById('stubCaduca').textContent    = vale.caduca.includes('nunca') ? 'No caduca ‚ú®' : 'Caduca: ' + vale.caduca;
  const conceptShort = vale.concept.length > 22 ? vale.concept.slice(0, 22) + '‚Ä¶' : vale.concept;
  document.getElementById('stubConcept').textContent   = conceptShort;

  // Update avatars in ticket
  const isFlor = vale.from === 'Florecilla';
  document.getElementById('avatarFrom').innerHTML = isFlor ? AVATAR_FLORECILLA : AVATAR_CHIQUTIN;
  document.getElementById('avatarTo').innerHTML   = isFlor ? AVATAR_CHIQUTIN : AVATAR_FLORECILLA;

  generateBarcode();

  // Show ticket and scroll to it
  const container = document.getElementById('flyerContainer');
  container.classList.remove('visible');
  void container.offsetWidth;
  container.classList.add('visible');
  container.scrollIntoView({ behavior: 'smooth', block: 'start' });

  // Show share buttons
  showWalletSaveBtn();

  // Visual feedback on card
  document.querySelectorAll('.vale-card-action').forEach(b => b.textContent = 'üëÅ');
  event.target.textContent = '‚úÖ';
  setTimeout(() => { event.target.textContent = 'üëÅ'; }, 1500);
}

// ===== SHARE / EXPORT =====
async function captureTicket() {
  const script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
  document.head.appendChild(script);
  await new Promise(r => script.onload = r);
  const ticket = document.querySelector('.ticket-shadow');
  return html2canvas(ticket, { scale: 3, backgroundColor: null, useCORS: true });
}
async function shareAsImage() {
  const btn = document.getElementById('shareBtn');
  btn.textContent = '‚è≥ Generando...'; btn.disabled = true;
  try {
    const canvas = await captureTicket();
    canvas.toBlob(async blob => {
      const file = new File([blob], 'vale-de-amor.png', {type:'image/png'});
      if (navigator.canShare && navigator.canShare({files:[file]})) {
        await navigator.share({files:[file], title:'Vale de Amor üåô'});
      } else {
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = 'vale-de-amor.png'; a.click();
      }
    }, 'image/png');
  } catch(e) { console.error(e); }
  btn.textContent = 'üì∏ Guardar imagen'; btn.disabled = false;
}
async function shareWhatsapp() {
  const waBtn = document.getElementById('waBtn');
  waBtn.innerHTML = '‚è≥ Generando imagen...'; waBtn.disabled = true;
  try {
    const canvas = await captureTicket();
    canvas.toBlob(async blob => {
      const file = new File([blob], 'vale-de-amor.png', {type:'image/png'});
      try {
        if (navigator.canShare && navigator.canShare({files:[file]})) {
          await navigator.share({files:[file], title:'üíú Te env√≠o un Vale de Amor üåô'});
        } else {
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
          a.download = 'vale-de-amor.png'; a.click();
          setTimeout(() => window.open('https://wa.me/?text=' + encodeURIComponent('üíú Te env√≠o un Vale de Amor üåô'), '_blank'), 1000);
        }
        waBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg> ¬°Enviado!`;
        setTimeout(() => { waBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg> Enviar por WhatsApp`; waBtn.disabled = false; }, 2500);
      } catch(e) {
        waBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg> Enviar por WhatsApp`; waBtn.disabled = false;
      }
    }, 'image/png');
  } catch(e) { console.error(e); waBtn.innerHTML = 'Enviar por WhatsApp'; waBtn.disabled = false; }
}

// ===== PARTICLES =====
function createStars() {
  const c = document.getElementById('stars');
  const colors = ['rgba(42,138,154,0.45)','rgba(26,122,102,0.4)','rgba(80,180,200,0.4)','rgba(42,160,130,0.35)','rgba(100,200,220,0.3)'];
  for (let i = 0; i < 55; i++) {
    const s = document.createElement('div'); s.className = 'star';
    const sz = Math.random()*3+1;
    s.style.cssText = `width:${sz}px;height:${sz}px;top:${Math.random()*100}%;left:${Math.random()*100}%;background:${colors[Math.floor(Math.random()*colors.length)]};--d:${2+Math.random()*4}s;animation-delay:${Math.random()*4}s`;
    c.appendChild(s);
  }
}
function createFloaters() {
  const emojis = ['üå∏','üåô','üíú','üåπ','üêæ','üí´','‚ù§Ô∏è','üå∫','‚≠ê','üê∂'];
  const c = document.getElementById('floaters');
  for (let i = 0; i < 10; i++) {
    const el = document.createElement('div'); el.className = 'floater';
    el.textContent = emojis[i % emojis.length];
    el.style.cssText = `top:${Math.random()*100}%;left:${Math.random()*100}%;--d:${3+Math.random()*5}s;animation-delay:${Math.random()*3}s;font-size:${1+Math.random()*2}rem`;
    c.appendChild(el);
  }
}

// ===== INIT =====
createStars(); createFloaters();
renderTags(); updateAvatars(); renderWallet();

// Lock sender direction if identity already known
if (currentUser) lockSender();

// Onboarding / identity check
showOnboarding();

// Start polling for new vales
startPolling();

if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
</script>
</body>
</html>

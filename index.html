<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1a0a2e">
<meta name="description" content="Vales de Amor para Florecilla y Chiquit√≠n">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Vales de Amor">
<title>Vales de Amor üåô</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&family=Special+Elite&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root {
  --deep: #0d0520;
  --night: #1a0a2e;
  --twilight: #2d1654;
  --rose: #c4607a;
  --blush: #e8a0b4;
  --gold: #d4a853;
  --cream: #fdf3e7;
  --moonlight: #e8dff5;
  --parchment: #f5ead0;
  --parchment-dark: #e8d5a3;
  --ink: #2c1810;
  --ink-light: #4a2e1a;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--deep);
  min-height: 100vh;
  font-family: 'Cormorant Garamond', serif;
  color: var(--cream);
  overflow-x: hidden;
}

.stars { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
.star {
  position: absolute; background: white; border-radius: 50%;
  animation: twinkle var(--d) ease-in-out infinite alternate;
}
@keyframes twinkle { from { opacity: 0.1; } to { opacity: 0.9; } }

.floaters { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
.floater {
  position: absolute;
  animation: float var(--d) ease-in-out infinite alternate;
  opacity: 0.12;
}
@keyframes float {
  0% { transform: translateY(0) rotate(0deg); }
  100% { transform: translateY(-18px) rotate(8deg); }
}

.app {
  position: relative; z-index: 1; min-height: 100vh;
  display: flex; flex-direction: column; align-items: center;
  padding: 2rem 1rem 3rem;
}

header { text-align: center; margin-bottom: 2rem; }
.moon-icon {
  font-size: 3.5rem; display: block;
  filter: drop-shadow(0 0 20px #d4a853bb);
  animation: moonGlow 3s ease-in-out infinite alternate;
}
@keyframes moonGlow {
  from { filter: drop-shadow(0 0 10px #d4a85355); }
  to   { filter: drop-shadow(0 0 30px #d4a853cc); }
}
h1 {
  font-family: 'Playfair Display', serif;
  font-size: clamp(1.8rem, 6vw, 3rem);
  font-style: italic;
  background: linear-gradient(135deg, var(--gold), var(--blush), var(--gold));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  line-height: 1.2; margin-top: 0.3rem;
}
.subtitle {
  font-size: 0.85rem; color: var(--moonlight); opacity: 0.6;
  letter-spacing: 0.25em; text-transform: uppercase; margin-top: 0.4rem;
}

.install-banner {
  display: none; width: 100%; max-width: 480px;
  background: linear-gradient(135deg, rgba(45,22,84,0.9), rgba(196,96,122,0.2));
  border: 1px solid rgba(196,96,122,0.3); border-radius: 1rem;
  padding: 1rem 1.5rem; margin-bottom: 1.5rem;
  align-items: center; gap: 1rem; cursor: pointer; transition: all 0.3s;
}
.install-banner:hover { transform: scale(1.01); }
.install-banner.show { display: flex; animation: fadeUp 0.5s ease; }
.install-text strong { display: block; font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--gold); }
.install-text span { font-size: 0.8rem; opacity: 0.7; }

.sender-section {
  display: flex; flex-direction: column; align-items: center; gap: 0.6rem;
  margin-bottom: 1.8rem;
  background: rgba(255,255,255,0.04); border: 1px solid rgba(212,168,83,0.2);
  border-radius: 1rem; padding: 1rem 1.5rem; backdrop-filter: blur(10px);
  width: 100%; max-width: 480px;
}
.sender-label { font-size: 0.8rem; color: var(--blush); letter-spacing: 0.18em; text-transform: uppercase; }
.sender-btns { display: flex; gap: 0.7rem; }
.sender-btn {
  padding: 0.55rem 1.3rem; border: 1px solid rgba(212,168,83,0.4);
  border-radius: 2rem; background: transparent; color: var(--cream);
  font-family: 'Playfair Display', serif; font-size: 0.95rem; cursor: pointer; transition: all 0.3s;
}
.sender-btn.active {
  background: linear-gradient(135deg, var(--rose), var(--twilight));
  border-color: var(--rose); box-shadow: 0 0 18px rgba(196,96,122,0.4);
}

.form-card {
  width: 100%; max-width: 480px;
  background: linear-gradient(160deg, rgba(45,22,84,0.8), rgba(13,5,32,0.9));
  border: 1px solid rgba(212,168,83,0.25); border-radius: 1.5rem;
  padding: 1.8rem; backdrop-filter: blur(20px);
  box-shadow: 0 20px 60px rgba(0,0,0,0.5); margin-bottom: 1.8rem;
}
.form-label {
  font-size: 0.78rem; letter-spacing: 0.2em; text-transform: uppercase;
  color: var(--blush); margin-bottom: 0.5rem; display: block;
}
.concept-input {
  width: 100%; background: rgba(255,255,255,0.04);
  border: 1px solid rgba(212,168,83,0.3); border-radius: 0.75rem;
  color: var(--cream); font-family: 'Playfair Display', serif;
  font-size: 1.05rem; font-style: italic; padding: 0.8rem 1rem;
  outline: none; transition: border-color 0.3s, box-shadow 0.3s;
  resize: none; min-height: 75px; margin-bottom: 1.3rem;
}
.concept-input::placeholder { color: rgba(253,243,231,0.3); }
.concept-input:focus { border-color: var(--gold); box-shadow: 0 0 15px rgba(212,168,83,0.2); }
.generate-btn {
  width: 100%; padding: 0.95rem;
  background: linear-gradient(135deg, var(--rose) 0%, #8b3a8b 50%, var(--twilight) 100%);
  border: none; border-radius: 0.75rem; color: white;
  font-family: 'Playfair Display', serif; font-size: 1.05rem; font-style: italic;
  cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 20px rgba(196,96,122,0.4);
  overflow: hidden; position: relative;
}
.generate-btn::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, transparent, rgba(255,255,255,0.12), transparent);
  transform: translateX(-100%); transition: transform 0.5s;
}
.generate-btn:hover::before { transform: translateX(100%); }
.generate-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(196,96,122,0.5); }

.suggestions { width: 100%; max-width: 480px; margin-bottom: 2rem; }
.suggestions-title {
  font-size: 0.75rem; letter-spacing: 0.2em; text-transform: uppercase;
  color: var(--blush); opacity: 0.6; margin-bottom: 0.7rem;
}
.tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
.tag {
  padding: 0.35rem 0.85rem; border: 1px solid rgba(212,168,83,0.2);
  border-radius: 2rem; font-size: 0.82rem; color: var(--moonlight);
  cursor: pointer; transition: all 0.2s; background: rgba(255,255,255,0.03);
}
.tag:hover { background: rgba(212,168,83,0.1); border-color: var(--gold); color: var(--gold); }

/* ===== TICKET ===== */
.flyer-container { width: 100%; max-width: 460px; display: none; }
.flyer-container.visible { display: block; animation: fadeUp 0.7s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(40px) scale(0.95); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}

.ticket-shadow {
  filter: drop-shadow(0 25px 50px rgba(0,0,0,0.75)) drop-shadow(0 0 25px rgba(196,96,122,0.15));
}

.ticket {
  background: var(--parchment);
  position: relative;
  border-radius: 4px;
}

/* Zigzag edges via SVG-like clip */
.zz-top {
  width: 100%; height: 14px; overflow: hidden; line-height: 0;
}
.zz-top svg, .zz-bot svg { display: block; width: 100%; }

.ticket-body {
  background: var(--parchment);
  padding: 1.2rem 1.6rem 1rem;
  position: relative;
  overflow: hidden;
}

/* Ruled lines texture */
.ticket-body::after {
  content: '';
  position: absolute; inset: 0;
  background-image: repeating-linear-gradient(
    0deg, transparent, transparent 27px,
    rgba(139,90,43,0.07) 27px, rgba(139,90,43,0.07) 28px
  );
  pointer-events: none;
}

.ticket-watermark {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%) rotate(-28deg);
  font-family: 'Playfair Display', serif;
  font-size: 4.5rem; font-style: italic;
  color: rgba(196,96,122,0.06);
  white-space: nowrap; pointer-events: none; user-select: none;
}

/* Header */
.ticket-header {
  display: flex; justify-content: space-between; align-items: flex-start;
  margin-bottom: 0.75rem; position: relative; z-index: 1;
}
.t-logo-icon { font-size: 1.7rem; line-height: 1; }
.t-logo-text {
  font-family: 'Special Elite', monospace; font-size: 0.55rem;
  letter-spacing: 0.25em; text-transform: uppercase; color: var(--ink-light); margin-top: 3px;
}
.t-serial-label {
  font-family: 'Special Elite', monospace; font-size: 0.5rem;
  letter-spacing: 0.15em; color: var(--ink-light); opacity: 0.55;
  text-transform: uppercase; text-align: right;
}
.t-serial-num {
  font-family: 'Special Elite', monospace; font-size: 0.85rem;
  color: var(--ink); letter-spacing: 0.1em;
}

.t-hr { border: none; border-top: 1px dashed rgba(139,90,43,0.3); margin: 0.65rem 0; position: relative; z-index:1; }

/* Parties */
.ticket-parties {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 0.8rem; position: relative; z-index: 1;
}
.t-party { text-align: center; flex: 1; }
.t-party-label {
  font-family: 'Special Elite', monospace; font-size: 0.52rem;
  letter-spacing: 0.2em; text-transform: uppercase;
  color: var(--ink-light); opacity: 0.55; display: block; margin-bottom: 2px;
}
.t-party-name {
  font-family: 'Playfair Display', serif; font-size: 1.15rem;
  font-style: italic; color: var(--ink);
}
.t-arrow { font-size: 1.2rem; opacity: 0.4; padding: 0 0.4rem; }

/* Vale box */
.ticket-vale {
  background: rgba(139,90,43,0.07);
  border: 1px dashed rgba(139,90,43,0.28);
  border-radius: 5px;
  padding: 0.9rem 4.5rem 0.9rem 1.1rem; /* right padding for stamp */
  margin: 0.6rem 0;
  position: relative; z-index: 1;
  text-align: center;
  min-height: 90px;
  display: flex; flex-direction: column; justify-content: center; align-items: center;
}
.t-vale-label {
  font-family: 'Special Elite', monospace; font-size: 0.58rem;
  letter-spacing: 0.3em; text-transform: uppercase;
  color: var(--ink-light); opacity: 0.5; margin-bottom: 0.35rem;
}
.t-vale-por {
  font-family: 'Playfair Display', serif; font-size: 0.82rem;
  font-style: italic; color: var(--ink-light); margin-bottom: 0.2rem;
}
.t-vale-concept {
  font-family: 'Playfair Display', serif; font-size: 1.4rem;
  font-weight: 700; color: var(--ink); line-height: 1.3;
}

/* Stamp */
.ticket-stamp {
  position: absolute; right: 0.8rem; top: 50%;
  transform: translateY(-50%) rotate(12deg);
  width: 68px; height: 68px;
  border: 2.5px solid rgba(196,96,122,0.5);
  border-radius: 50%;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  text-align: center;
}
.ticket-stamp::before {
  content: '';
  position: absolute; inset: 3px;
  border: 1px solid rgba(196,96,122,0.3);
  border-radius: 50%;
}
.t-stamp-icon { font-size: 1.3rem; position: relative; z-index: 1; line-height: 1; }
.t-stamp-text {
  font-family: 'Special Elite', monospace; font-size: 0.42rem;
  letter-spacing: 0.1em; text-transform: uppercase;
  color: rgba(196,96,122,0.65); position: relative; z-index: 1; line-height: 1.3;
}

/* Deco row */
.ticket-deco {
  display: flex; justify-content: center; gap: 0.35rem;
  font-size: 1rem; margin: 0.55rem 0; opacity: 0.45;
  position: relative; z-index: 1;
}

/* Footer row */
.ticket-footer {
  display: flex; justify-content: space-between; align-items: flex-end;
  position: relative; z-index: 1;
}
.t-footer-l, .t-footer-r {
  font-family: 'Special Elite', monospace; font-size: 0.52rem;
  letter-spacing: 0.08em; color: var(--ink-light); opacity: 0.5; line-height: 1.6;
}
.t-footer-r { text-align: right; }

/* Tear-off stub */
.zz-mid-wrap {
  background: var(--parchment);
  position: relative;
}
.stub-scissors {
  position: absolute; left: 1rem; top: -0.6rem;
  font-size: 0.9rem; opacity: 0.35; z-index: 2;
  background: var(--parchment-dark); padding: 0 3px;
}

.ticket-stub {
  background: linear-gradient(135deg, #f0e0cc, var(--parchment-dark));
  border-top: 1px dashed rgba(139,90,43,0.3);
  padding: 0.75rem 1.4rem;
  display: flex; align-items: center; justify-content: space-between; gap: 0.8rem;
}
.stub-info { flex: 1; }
.stub-title {
  font-family: 'Playfair Display', serif; font-size: 0.78rem;
  font-style: italic; font-weight: 700; color: var(--ink);
}
.stub-sub {
  font-family: 'Special Elite', monospace; font-size: 0.52rem;
  letter-spacing: 0.1em; color: var(--ink-light); opacity: 0.55;
  text-transform: uppercase; margin-top: 2px;
}
.stub-right {
  font-family: 'Special Elite', monospace; font-size: 0.5rem;
  color: var(--ink-light); opacity: 0.45; text-align: right; line-height: 1.6;
}

/* Barcode */
.barcode { display: flex; gap: 1.5px; align-items: stretch; height: 32px; opacity: 0.35; flex-shrink: 0; }
.bc-bar { background: var(--ink); border-radius: 1px; }

/* Action buttons */
.action-btns { display: flex; gap: 1rem; margin-top: 1.5rem; }
.action-btn {
  flex: 1; padding: 0.8rem; border-radius: 0.75rem;
  border: 1px solid rgba(212,168,83,0.3); background: rgba(255,255,255,0.04);
  color: var(--cream); font-family: 'Cormorant Garamond', serif; font-size: 0.95rem;
  cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.4rem;
}
.action-btn:hover { background: rgba(212,168,83,0.1); border-color: var(--gold); transform: translateY(-2px); }
.new-btn { border-color: rgba(196,96,122,0.3); }
.new-btn:hover { background: rgba(196,96,122,0.1); border-color: var(--rose); }

.whatsapp-btn {
  border-color: rgba(37,211,102,0.4) !important;
  color: #25d366 !important;
}
.whatsapp-btn:hover {
  background: rgba(37,211,102,0.1) !important;
  border-color: #25d366 !important;
  transform: translateY(-2px);
}

footer { margin-top: 2.5rem; text-align: center; font-size: 0.7rem; opacity: 0.25; letter-spacing: 0.15em; }
</style>
</head>
<body>

<div class="stars" id="stars"></div>
<div class="floaters" id="floaters"></div>

<div class="app">
  <header>
    <span class="moon-icon">üåô</span>
    <h1>Vales de Amor</h1>
    <p class="subtitle">para Florecilla &amp; Chiquit√≠n</p>
  </header>

  <div class="install-banner" id="installBanner" onclick="installApp()">
    <div style="font-size:2rem">üì≤</div>
    <div class="install-text">
      <strong>Instalar en tu m√≥vil</strong>
      <span>A√±adir a pantalla de inicio</span>
    </div>
    <div>‚ûï</div>
  </div>

  <div class="sender-section">
    <div class="sender-label">¬øQui√©n env√≠a el vale?</div>
    <div class="sender-btns">
      <button class="sender-btn active" onclick="setSender('Florecilla', this)">üå∏ Florecilla</button>
      <button class="sender-btn" onclick="setSender('Chiquit√≠n', this)">üêæ Chiquit√≠n</button>
    </div>
  </div>

  <div class="form-card">
    <label class="form-label">‚ú¶ El vale dice...</label>
    <textarea class="concept-input" id="conceptInput"
      placeholder="un abrazo eterno, un beso sorpresa, una tarde de pelis juntos..."
      rows="3"></textarea>
    <button class="generate-btn" onclick="generateFlyer()">üåô Crear mi Vale de Amor</button>
  </div>

  <div class="suggestions">
    <div class="suggestions-title">‚ú¶ ideas para tu vale</div>
    <div class="tags" id="tags"></div>
  </div>

  <!-- TICKET -->
  <div class="flyer-container" id="flyerContainer">
    <div class="ticket-shadow">
      <div class="ticket">

        <!-- Zigzag top -->
        <div style="line-height:0;overflow:hidden;height:14px;">
          <svg viewBox="0 0 400 14" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
            <polygon points="0,0 400,0 400,14 390,0 380,14 370,0 360,14 350,0 340,14 330,0 320,14 310,0 300,14 290,0 280,14 270,0 260,14 250,0 240,14 230,0 220,14 210,0 200,14 190,0 180,14 170,0 160,14 150,0 140,14 130,0 120,14 110,0 100,14 90,0 80,14 70,0 60,14 50,0 40,14 30,0 20,14 10,0 0,14"
              fill="#f5ead0"/>
          </svg>
        </div>

        <!-- Main body -->
        <div class="ticket-body">
          <div class="ticket-watermark">Vale de Amor</div>

          <div class="ticket-header">
            <div>
              <div class="t-logo-icon">üåô</div>
              <div class="t-logo-text">Vale de amor</div>
            </div>
            <div>
              <div class="t-serial-label">N¬∫ de serie</div>
              <div class="t-serial-num" id="serialNum">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
            </div>
          </div>

          <hr class="t-hr">

          <div class="ticket-parties">
            <div class="t-party">
              <span class="t-party-label">de</span>
              <div class="t-party-name" id="ticketFrom">Florecilla</div>
            </div>
            <div class="t-arrow">üíå</div>
            <div class="t-party">
              <span class="t-party-label">para</span>
              <div class="t-party-name" id="ticketTo">Chiquit√≠n</div>
            </div>
          </div>

          <div class="ticket-vale">
            <div class="t-vale-label">‚ú¶ ¬∑ ¬∑ ¬∑ vale por ¬∑ ¬∑ ¬∑ ‚ú¶</div>
            <div class="t-vale-por">Este vale te da derecho a</div>
            <div class="t-vale-concept" id="ticketConcept">...</div>
            <div class="ticket-stamp">
              <div class="t-stamp-icon">üíú</div>
              <div class="t-stamp-text">con todo<br>mi amor</div>
            </div>
          </div>

          <div class="ticket-deco">üå∏ üåô üåπ üêæ üí´ ‚ù§Ô∏è üå∫ üê∂</div>

          <hr class="t-hr">

          <div class="ticket-footer">
            <div class="t-footer-l">Emitido con amor ‚ô•<br>V√°lido para siempre</div>
            <div class="t-footer-r" id="ticketDate">--/--/----<br>Canjeable cuando quieras</div>
          </div>
        </div>

        <!-- Stub divider (zigzag bottom of main + top of stub) -->
        <div class="zz-mid-wrap">
          <div class="stub-scissors">‚úÇ</div>
          <div style="line-height:0;overflow:hidden;height:14px;">
            <svg viewBox="0 0 400 14" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
              <polygon points="0,14 400,14 400,0 390,14 380,0 370,14 360,0 350,14 340,0 330,14 320,0 310,14 300,0 290,14 280,0 270,14 260,0 250,14 240,0 230,14 220,0 210,14 200,0 190,14 180,0 170,14 160,0 150,14 140,0 130,14 120,0 110,14 100,0 90,14 80,0 70,14 60,0 50,14 40,0 30,14 20,0 10,14 0,0"
                fill="#e8d5a3"/>
            </svg>
          </div>
          <div class="ticket-stub">
            <div class="stub-info">
              <div class="stub-title" id="stubFrom">De Florecilla</div>
              <div class="stub-sub" id="stubConcept">vale por...</div>
            </div>
            <div class="barcode" id="barcode"></div>
            <div class="stub-right">
              <div id="stubSerial">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
              <div>No caduca üåô</div>
            </div>
          </div>
          <div style="line-height:0;overflow:hidden;height:14px;">
            <svg viewBox="0 0 400 14" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
              <polygon points="0,0 400,0 400,14 390,0 380,14 370,0 360,14 350,0 340,14 330,0 320,14 310,0 300,14 290,0 280,14 270,0 260,14 250,0 240,14 230,0 220,14 210,0 200,14 190,0 180,14 170,0 160,14 150,0 140,14 130,0 120,14 110,0 100,14 90,0 80,14 70,0 60,14 50,0 40,14 30,0 20,14 10,0 0,14"
                fill="#e8d5a3"/>
            </svg>
          </div>
        </div>

      </div>
    </div>

    <div class="action-btns">
      <button class="action-btn new-btn" onclick="resetForm()">üå∏ Nuevo Vale</button>
      <button class="action-btn" id="shareBtn" onclick="shareAsImage()">üì∏ Guardar imagen</button>
    </div>
    <div class="action-btns" style="margin-top:0.6rem;">
      <button class="action-btn whatsapp-btn" id="waBtn" onclick="shareWhatsapp()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
        Enviar por WhatsApp
      </button>
    </div>
  </div>

  <footer>üåô hecho con amor ¬∑ para siempre vuestro üåπ</footer>
</div>

<script>
const ideas = {
  Florecilla: [
    "un abrazo de oso muy largo","elegir la peli esta noche","un beso sorpresa",
    "un masaje en los pies","una tarde de mimos","preparo yo la cena",
    "un d√≠a sin quejas üòá","te dejo el mando",
  ],
  Chiquit√≠n: [
    "un paseo rom√°ntico","flores inesperadas","desayuno en la cama",
    "un beso cuando llegues","una sorpresa secreta","bailar contigo esta noche",
    "te escribo una carta","un d√≠a tuyo entero",
  ]
};

let sender = 'Florecilla';
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); deferredPrompt = e;
  document.getElementById('installBanner').classList.add('show');
});

function installApp() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(() => { deferredPrompt = null; document.getElementById('installBanner').classList.remove('show'); });
  } else {
    alert('Para instalar:\n‚Ä¢ iPhone: Compartir ‚Üí A√±adir a pantalla de inicio\n‚Ä¢ Android: Men√∫ ‚ãÆ ‚Üí A√±adir a pantalla de inicio');
  }
}

function setSender(name, btn) {
  sender = name;
  document.querySelectorAll('.sender-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTags();
}

function renderTags() {
  document.getElementById('tags').innerHTML = ideas[sender].map(idea =>
    `<span class="tag" onclick="useSuggestion('${idea}')">${idea}</span>`
  ).join('');
}

function useSuggestion(text) {
  document.getElementById('conceptInput').value = text;
  document.getElementById('conceptInput').focus();
}

function generateSerial() {
  const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let s = '';
  for (let i = 0; i < 8; i++) { if (i===4) s+='-'; s += c[Math.floor(Math.random()*c.length)]; }
  return s;
}

function generateBarcode() {
  const c = document.getElementById('barcode');
  c.innerHTML = '';
  [1,2,1,3,1,2,2,1,3,1,2,1,1,3,2,1,2,1,3,1,2].forEach(w => {
    const b = document.createElement('div');
    b.className = 'bc-bar';
    b.style.width = w + 'px';
    c.appendChild(b);
  });
}

function generateFlyer() {
  const concept = document.getElementById('conceptInput').value.trim();
  if (!concept) {
    document.getElementById('conceptInput').style.borderColor = 'var(--rose)';
    setTimeout(() => document.getElementById('conceptInput').style.borderColor = '', 1500);
    return;
  }
  const receiver = sender === 'Florecilla' ? 'Chiquit√≠n' : 'Florecilla';
  const serial = generateSerial();
  const dateStr = new Date().toLocaleDateString('es-ES', {day:'2-digit',month:'2-digit',year:'numeric'});

  document.getElementById('ticketFrom').textContent = sender;
  document.getElementById('ticketTo').textContent = receiver;
  document.getElementById('ticketConcept').textContent = concept;
  document.getElementById('serialNum').textContent = serial;
  document.getElementById('ticketDate').innerHTML = dateStr + '<br>Canjeable cuando quieras';
  document.getElementById('stubFrom').textContent = 'De ' + sender;
  document.getElementById('stubConcept').textContent = concept.length > 22 ? concept.slice(0,22)+'‚Ä¶' : concept;
  document.getElementById('stubSerial').textContent = serial;

  generateBarcode();

  const container = document.getElementById('flyerContainer');
  container.classList.remove('visible');
  void container.offsetWidth;
  container.classList.add('visible');
  container.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function resetForm() {
  document.getElementById('conceptInput').value = '';
  document.getElementById('flyerContainer').classList.remove('visible');
  document.querySelector('.form-card').scrollIntoView({ behavior: 'smooth' });
}

async function captureTicket() {
  const ticket = document.querySelector('.ticket-shadow');
  // Temporarily add a white padding wrapper so shadow isn't clipped
  const canvas = await html2canvas(ticket, {
    scale: 3,
    useCORS: true,
    allowTaint: true,
    backgroundColor: '#1a0a2e',
    logging: false,
    onclone: (doc) => {
      // Ensure fonts render in clone
      doc.querySelectorAll('*').forEach(el => {
        el.style.webkitPrintColorAdjust = 'exact';
      });
    }
  });
  return canvas;
}

async function shareAsImage() {
  const btn = document.getElementById('shareBtn');
  btn.textContent = '‚è≥ Generando...';
  btn.disabled = true;
  try {
    const canvas = await captureTicket();
    canvas.toBlob(async (blob) => {
      const file = new File([blob], 'vale-de-amor.png', { type: 'image/png' });
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({ files: [file], title: 'Vale de Amor üåô' });
      } else {
        // Fallback: download the image
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'vale-de-amor.png'; a.click();
        URL.revokeObjectURL(url);
      }
      btn.textContent = '‚úÖ ¬°Listo!';
      setTimeout(() => { btn.textContent = 'üì∏ Guardar imagen'; btn.disabled = false; }, 2000);
    }, 'image/png');
  } catch(e) {
    btn.textContent = 'üì∏ Guardar imagen';
    btn.disabled = false;
  }
}

async function shareWhatsapp() {
  const waBtn = document.getElementById('waBtn');
  waBtn.innerHTML = '‚è≥ Generando imagen...';
  waBtn.disabled = true;
  try {
    const canvas = await captureTicket();
    canvas.toBlob(async (blob) => {
      const file = new File([blob], 'vale-de-amor.png', { type: 'image/png' });
      // Try Web Share API with file (works on Android Chrome & iOS Safari 15+)
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({ files: [file], title: 'üíú Te env√≠o un Vale de Amor üåô' });
          waBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg> ¬°Enviado!`;
          setTimeout(() => {
            waBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg> Enviar por WhatsApp`;
            waBtn.disabled = false;
          }, 2500);
          return;
        } catch(e) { /* user cancelled or error, fall through */ }
      }
      // Fallback: download image + open WhatsApp
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'vale-de-amor.png'; a.click();
      URL.revokeObjectURL(url);
      setTimeout(() => {
        window.open('https://wa.me/?text=' + encodeURIComponent('üíú Te env√≠o un Vale de Amor üåô (adjunta la imagen que acaba de descargarse)'), '_blank');
      }, 800);
      waBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg> Enviar por WhatsApp`;
      waBtn.disabled = false;
    }, 'image/png');
  } catch(e) {
    waBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg> Enviar por WhatsApp`;
    waBtn.disabled = false;
  }
}

function createStars() {
  const c = document.getElementById('stars');
  for (let i = 0; i < 70; i++) {
    const s = document.createElement('div'); s.className = 'star';
    const sz = Math.random()*2.5+0.5;
    s.style.cssText = `width:${sz}px;height:${sz}px;top:${Math.random()*100}%;left:${Math.random()*100}%;--d:${2+Math.random()*4}s;animation-delay:${Math.random()*4}s`;
    c.appendChild(s);
  }
}
function createFloaters() {
  const emojis = ['üå∏','üåô','üíú','üåπ','üêæ','üí´','‚ù§Ô∏è','üå∫','‚≠ê','üê∂'];
  const c = document.getElementById('floaters');
  for (let i = 0; i < 10; i++) {
    const el = document.createElement('div'); el.className = 'floater';
    el.textContent = emojis[i%emojis.length];
    el.style.cssText = `top:${Math.random()*100}%;left:${Math.random()*100}%;--d:${3+Math.random()*5}s;animation-delay:${Math.random()*3}s;font-size:${1+Math.random()*2}rem`;
    c.appendChild(el);
  }
}

createStars(); createFloaters(); renderTags();

if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
</script>
</body>
</html>
